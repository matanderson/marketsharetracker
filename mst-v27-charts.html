<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Share Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link rel="stylesheet" href="https://use.typekit.net/gbr7ncz.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    
<script>
// ==========================================
// GLOBAL VARIABLES - DECLARE FIRST
// ==========================================
let weeklyData = {};
let currentWeek = '';
let currentTab = 'overview';
let futureProjections = [];
let weekContexts = {};
let appliedGeneralContext = null;

// ==========================================
// CONFIGURATION
// ==========================================
const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwi63m01Jcwiq1gE7-ML0UXi2_GfEQTCwFmW7KMQpW71n8mf3finsvKXswLnrZShuCdrw/exec';

	
	// ==========================================
// CHART.JS FONT CONFIGURATION
// ==========================================
Chart.defaults.font.family = "'pragmatica-extended', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif";
	
	
	
// ==========================================
// COLOR CONFIGURATION
// ==========================================
const LABEL_COLORS = {
    'Provident': '#E25423',
    'CCMG': '#1696F3',
    'ADA': '#FEAE20',
    'THE ORCHARD': '#3DB5AD',
    'Fair Trade': '#44A700',
    'WORD/CURB': '#A350DD',
    'Total Others': '#95A5A6'
};

function getLabelColor(label) {
    return LABEL_COLORS[label] || '#888888';
}

// ==========================================
// CACHE CONFIGURATION
// ==========================================
const CACHE_KEY = 'marketShareData';
const CACHE_VERSION_KEY = 'marketShareDataVersion';
const CACHE_TIMESTAMP_KEY = 'marketShareDataTimestamp';

// ==========================================
// CACHE MANAGEMENT FUNCTIONS
// ==========================================
function shouldClearCache() {
    const lastCacheTime = localStorage.getItem(CACHE_TIMESTAMP_KEY);
    if (!lastCacheTime) return true;
    
    const lastCache = new Date(parseInt(lastCacheTime));
    const now = new Date();
    
    // If it's Monday (day 1) and cache is from before today
    if (now.getDay() === 1) {
        const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        if (lastCache < todayMidnight) {
            console.log('Monday cache clear triggered');
            return true;
        }
    }
    
    // Also clear if cache is older than 7 days
    const daysSinceCache = (now - lastCache) / (1000 * 60 * 60 * 24);
    if (daysSinceCache > 7) {
        console.log('Weekly cache expiry triggered');
        return true;
    }
    
    return false;
}

function getCachedData() {
    if (shouldClearCache()) {
        clearCache();
        return null;
    }
    
    try {
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
            console.log('Loading from cache');
            return JSON.parse(cached);
        }
    } catch (e) {
        console.error('Cache read error:', e);
        clearCache();
    }
    return null;
}

function setCachedData(data) {
    try {
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
        console.log('Data cached successfully');
    } catch (e) {
        console.error('Cache write error:', e);
        // If cache is full, clear and try again
        if (e.name === 'QuotaExceededError') {
            clearCache();
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
            } catch (e2) {
                console.error('Cache still full after clear:', e2);
            }
        }
    }
}

function clearCache() {
    localStorage.removeItem(CACHE_KEY);
    localStorage.removeItem(CACHE_VERSION_KEY);
    localStorage.removeItem(CACHE_TIMESTAMP_KEY);
    console.log('Cache cleared');
}

function clearCacheAndReload() {
    clearCache();
    location.reload();
}

// ==========================================
// UI HELPER FUNCTIONS
// ==========================================
function ensureStatusElement() {
    let statusEl = document.getElementById('dataStatus');
    if (!statusEl) {
        console.warn('Creating dataStatus element...');
        
        const container = document.querySelector('.controls') || 
                         document.querySelector('.header') || 
                         document.querySelector('.container') ||
                         document.body;
        
        statusEl = document.createElement('div');
        statusEl.id = 'dataStatus';
        statusEl.style.cssText = 'padding: 10px; text-align: center; font-size: 14px; color: #888;';
        
        if (container.firstChild) {
            container.insertBefore(statusEl, container.firstChild);
        } else {
            container.appendChild(statusEl);
        }
    }
    return statusEl;
}

function showProgress(message, percent) {
    let overlay = document.getElementById('progressOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'progressOverlay';
        overlay.className = 'progress-overlay';
        overlay.innerHTML = `
            <div class="progress-content">
                <div class="progress-spinner"></div>
                <div class="progress-message">${message || 'Loading...'}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percent || 0}%"></div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
    } else {
        const messageEl = overlay.querySelector('.progress-message');
        const fillEl = overlay.querySelector('.progress-fill');
        
        if (messageEl) messageEl.textContent = message || 'Loading...';
        if (fillEl) fillEl.style.width = (percent || 0) + '%';
    }
    
    overlay.classList.add('active');
}

function hideProgress() {
    const overlay = document.getElementById('progressOverlay');
    if (overlay) {
        overlay.classList.remove('active');
    }
}

// ==========================================
// UTILITY FUNCTIONS
// ==========================================
function formatNumber(num) {
    if (!num && num !== 0) return 'N/A';
    if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
    if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
    if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
    return num.toLocaleString();
}

// ==========================================
// DATA FETCHING FUNCTIONS
// ==========================================
async function fetchDataFromGoogleDrive(forceRefresh = false) {
    const statusEl = ensureStatusElement();
    const startTime = performance.now();
    
    try {
        // Check cache first unless force refresh
        if (!forceRefresh) {
            const cachedData = getCachedData();
            if (cachedData && Object.keys(cachedData).length > 0) {
                weeklyData = cachedData;
                statusEl.innerHTML = `✓ Loaded ${Object.keys(weeklyData).length} weeks from cache`;
                
                // Set current week and update UI immediately
                setCurrentWeek();
                updateAllViews();
                
                // Check for updates in background
                checkForUpdatesInBackground();
                return;
            }
        }
        
        // Show loading overlay
        showProgress('Loading recent data...', 20);
        statusEl.textContent = 'Loading recent weeks...';
        
        // First, fetch recent 8 weeks for fast initial load
        console.log('Fetching recent 8 weeks...');
        const recentUrl = `${GOOGLE_APPS_SCRIPT_URL}?action=getRecentData&weeks=8`;
        
        showProgress('Connecting to data source...', 30);
        const recentResponse = await fetch(recentUrl);
        
        if (!recentResponse.ok) {
            throw new Error(`HTTP error! status: ${recentResponse.status}`);
        }
        
        showProgress('Processing data...', 60);
        const recentData = await recentResponse.json();
        
        if (recentData && !recentData.error && Object.keys(recentData).length > 0) {
            weeklyData = recentData;
            
            showProgress('Updating dashboard...', 90);
            
            // Update UI with recent data immediately
            setCurrentWeek();
            updateAllViews();
            hideProgress();
            
            const loadTime = ((performance.now() - startTime) / 1000).toFixed(2);
            statusEl.innerHTML = `✓ Loaded recent ${Object.keys(weeklyData).length} weeks in ${loadTime}s`;
            
            // Save recent data to cache
            setCachedData(weeklyData);
            
            // Load remaining data in background
            loadRemainingDataInBackground();
        } else {
            throw new Error('No recent data received');
        }
        
    } catch (error) {
        console.error('Error fetching data:', error);
        hideProgress();
        
        // Try to use cached data as fallback
        const cachedData = getCachedData();
        if (cachedData && Object.keys(cachedData).length > 0) {
            weeklyData = cachedData;
            statusEl.innerHTML = '⚠️ Using cached data (offline mode)';
            setCurrentWeek();
            updateAllViews();
        } else {
            statusEl.innerHTML = `<span style="color: #f87171;">❌ Error loading data: ${error.message}</span>`;
        }
    }
}

async function loadRemainingDataInBackground() {
    try {
        console.log('Loading historical data in background...');
        
        const allUrl = `${GOOGLE_APPS_SCRIPT_URL}?action=getAllData`;
        const response = await fetch(allUrl);
        
        if (response.ok) {
            const allData = await response.json();
            
            if (allData && !allData.error && Object.keys(allData).length > Object.keys(weeklyData).length) {
                // Merge with existing data
                weeklyData = { ...weeklyData, ...allData };
                
                // Update cache with complete data
                setCachedData(weeklyData);
                
                // Update status silently
                const statusEl = document.getElementById('dataStatus');
                if (statusEl) {
                    statusEl.innerHTML = `✓ All ${Object.keys(weeklyData).length} weeks loaded`;
                }
                
                // Update week selector if on overview tab
                if (currentTab === 'overview') {
                    updateWeekSelector();
                }
                
                console.log('Background loading complete:', Object.keys(weeklyData).length, 'weeks');
            }
        }
    } catch (error) {
        console.warn('Background loading failed:', error);
    }
}

async function checkForUpdatesInBackground() {
    try {
        const versionUrl = `${GOOGLE_APPS_SCRIPT_URL}?action=getVersion`;
        const response = await fetch(versionUrl);
        
        if (response.ok) {
            const versionData = await response.json();
            const cachedVersion = localStorage.getItem(CACHE_VERSION_KEY);
            
            if (!cachedVersion || versionData.version !== cachedVersion) {
                console.log('New data available, updating...');
                
                // Fetch new data in background
                const allUrl = `${GOOGLE_APPS_SCRIPT_URL}?action=getAllData`;
                const dataResponse = await fetch(allUrl);
                
                if (dataResponse.ok) {
                    const newData = await dataResponse.json();
                    if (newData && !newData.error) {
                        weeklyData = newData;
                        setCachedData(weeklyData);
                        localStorage.setItem(CACHE_VERSION_KEY, versionData.version);
                        
                        // Update UI if still on same week
                        if (document.visibilityState === 'visible') {
                            updateAllViews();
                            const statusEl = document.getElementById('dataStatus');
                            if (statusEl) {
                                statusEl.innerHTML = `✓ Updated to latest data (${Object.keys(weeklyData).length} weeks)`;
                            }
                        }
                    }
                }
            }
        }
    } catch (error) {
        console.warn('Update check failed:', error);
    }
}

	
	
	
// ==========================================
// WEEK MANAGEMENT FUNCTIONS
// ==========================================
function setCurrentWeek() {
    if (weeklyData && Object.keys(weeklyData).length > 0) {
        const weeks = Object.keys(weeklyData).sort();
        currentWeek = weeks[weeks.length - 1]; // Set to most recent week
        console.log('Current week set to:', currentWeek);
    }
}

function selectWeek(week) {
    currentWeek = week;
    updateAllViews();
}

// ==========================================
// TAB SWITCHING FUNCTIONS
// ==========================================
function switchTab(tabName, element) {
    console.log('Switching to tab:', tabName);
    currentTab = tabName;
    
    // Update active tab styling
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    if (element) {
        element.classList.add('active');
    }
    
    // Hide all tab panels
    document.querySelectorAll('.tab-content').forEach(panel => {
        panel.style.display = 'none';
        panel.classList.remove('active');
    });
    
    // Show the selected tab panel
    const selectedPanel = document.getElementById(tabName + '-tab');
    if (selectedPanel) {
        selectedPanel.style.display = 'block';
        selectedPanel.classList.add('active');
    }
    
    // Update views for this tab
    updateAllViews();
}

function switchTabMobile(value) {
    // Find the corresponding tab button and trigger switchTab
    const tabButtons = document.querySelectorAll('.tab');
    tabButtons.forEach(button => {
        if (button.textContent.toLowerCase().includes(value.toLowerCase()) || 
            button.onclick.toString().includes(`'${value}'`)) {
            switchTab(value, button);
        }
    });
}

// ==========================================
// DASHBOARD UPDATE FUNCTIONS
// ==========================================
function updateAllViews() {
    console.log('Updating all views with data...');
    
    // Check if we have data
    if (!weeklyData || Object.keys(weeklyData).length === 0) {
        console.log('No data available to display');
        return;
    }
    
    // Update based on current tab
    const activeTab = currentTab || 'overview';
    console.log('Active tab:', activeTab);
    
    // Call the appropriate update functions based on tab
    switch(activeTab) {
    case 'overview':
        updateOverviewTab();
        break;
    case 'analytics':
        updateAnalyticsTab();
        break;
    case 'performance':
        updatePerformanceTab();
        break;
    case 'comparison':
        updateComparisonTab();
        break;
    case 'charts':
        updateChartsTab();
        break;
    case 'export':
        updateExportTab();
        break;
}
    
    // Update week selector if it exists
    updateWeekSelector();
}

// Update week selector

        
function updateWeekSelector() {
    const selector = document.getElementById('weekDropdown');
    const mobileSelector = document.getElementById('mobileWeekDropdown');
    const drawerSelector = document.getElementById('drawerWeekDropdown');
    
    if (weeklyData) {
        const currentValue = selector ? selector.value : null;
        const weeks = Object.keys(weeklyData).sort();
        
        // Update desktop selector
        if (selector) {
            selector.innerHTML = '';
            weeks.forEach(week => {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = week;
                option.selected = week === (currentValue || currentWeek);
                selector.appendChild(option);
            });
        }
        
        // Update mobile header selector
        if (mobileSelector) {
            mobileSelector.innerHTML = '';
            weeks.forEach(week => {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = week;
                option.selected = week === (currentValue || currentWeek);
                mobileSelector.appendChild(option);
            });
        }
        
        // Update drawer selector
        if (drawerSelector) {
            drawerSelector.innerHTML = '';
            weeks.forEach(week => {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = week;
                option.selected = week === (currentValue || currentWeek);
                drawerSelector.appendChild(option);
            });
        }
    }
}

// ==========================================
// OVERVIEW TAB FUNCTIONS
// ==========================================
function updateOverviewTab() {
    console.log('Updating overview tab...');
    
    if (!currentWeek || !weeklyData[currentWeek]) {
        console.log('No current week data');
        return;
    }
    
    const data = weeklyData[currentWeek];
    console.log('Current week data:', data);
    
    // Update weekly summary
    updateWeeklySummary();
    
    // Update total market card
    updateTotalMarketCard();
    
    // Update alerts
    updateAlerts();
    
    // Update biggest movers
    updateBiggestMovers();
    
    // Update metric cards grid
    updateMetricsGrid();
    
    // Update charts
    updateStreamChart();
    updatePieChart();
    updateBarChart();
}

function updateWeeklySummary() {
    const summaryEl = document.getElementById('weeklySummaryText');
    if (!summaryEl || !currentWeek || !weeklyData[currentWeek]) return;
    
    const data = weeklyData[currentWeek];
    const prevWeek = getPreviousWeek(currentWeek);
    const prevData = prevWeek ? weeklyData[prevWeek] : null;
    
    let summaryText = `<strong>Week ending ${currentWeek}:</strong><br>`;
    
    // Basic stats
    const totalLabels = Object.keys(data.marketShares || {}).length;
    summaryText += `Tracking ${totalLabels} labels in the market.<br>`;
    
    // Market leader
    const sortedLabels = Object.entries(data.marketShares || {})
        .sort((a, b) => b[1].percentage - a[1].percentage);
    
    if (sortedLabels.length > 0) {
        const [leader, leaderData] = sortedLabels[0];
        summaryText += `<br><strong>${leader}</strong> leads with ${leaderData.percentage.toFixed(1)}% market share`;
        
        if (prevData && prevData.marketShares[leader]) {
            const prevShare = prevData.marketShares[leader].percentage;
            const change = leaderData.percentage - prevShare;
            if (Math.abs(change) > 0.1) {
                summaryText += ` (${change > 0 ? '+' : ''}${change.toFixed(1)}% from last week)`;
            }
        }
        summaryText += '.<br>';
    }
    
    // Total streaming volume
    if (data.totalStreaming) {
        summaryText += `<br>Total streaming volume: ${formatNumber(data.totalStreaming)}`;
        if (prevData && prevData.totalStreaming) {
            const streamChange = ((data.totalStreaming - prevData.totalStreaming) / prevData.totalStreaming * 100);
            summaryText += ` (${streamChange > 0 ? '+' : ''}${streamChange.toFixed(1)}% WoW)`;
        }
        summaryText += '.';
    }
    
    // Context if available
    const context = weekContexts[currentWeek] || appliedGeneralContext;
    if (context) {
        summaryText += `<br><br><em style="color: #667eea;">Context: ${context}</em>`;
        document.getElementById('contextIndicator').style.display = 'inline';
    } else {
        document.getElementById('contextIndicator').style.display = 'none';
    }
    
    summaryEl.innerHTML = summaryText;
}

function updateTotalMarketCard() {
    const card = document.getElementById('totalMarketCard');
    if (!card || !currentWeek || !weeklyData[currentWeek]) return;
    
    const data = weeklyData[currentWeek];
    const prevWeek = getPreviousWeek(currentWeek);
    const prevData = prevWeek ? weeklyData[prevWeek] : null;
    
    // Calculate changes
    let totalChange = 'N/A';
    let streamChange = 'N/A';
    let albumChange = 'N/A';
    
    // Calculate weekly values
    let weeklyStreaming = data.totalStreaming || 0;
    let weeklyAlbums = data.totalAlbums || 0;
    let weeklyTotal = data.totalMarketShareVolume?.value || 0;
    
    if (prevData) {
        // YTD Changes
        if (data.totalMarketShareVolume && prevData.totalMarketShareVolume) {
            const change = ((data.totalMarketShareVolume.value - prevData.totalMarketShareVolume.value) / 
                           prevData.totalMarketShareVolume.value * 100);
            totalChange = `${change > 0 ? '+' : ''}${change.toFixed(1)}%`;
        }
        if (data.totalStreaming && prevData.totalStreaming) {
            const change = ((data.totalStreaming - prevData.totalStreaming) / prevData.totalStreaming * 100);
            streamChange = `${change > 0 ? '+' : ''}${change.toFixed(1)}%`;
        }
        if (data.totalAlbums && prevData.totalAlbums) {
            const change = ((data.totalAlbums - prevData.totalAlbums) / prevData.totalAlbums * 100);
            albumChange = `${change > 0 ? '+' : ''}${change.toFixed(1)}%`;
        }
        
        // Calculate weekly values (current YTD - previous YTD)
        weeklyStreaming = (data.totalStreaming || 0) - (prevData.totalStreaming || 0);
        weeklyAlbums = (data.totalAlbums || 0) - (prevData.totalAlbums || 0);
        weeklyTotal = (data.totalMarketShareVolume?.value || 0) - (prevData.totalMarketShareVolume?.value || 0);
    }
    
    card.innerHTML = `
        <h3 style="font-size: 1.6rem; color: #a0a0a0; margin-bottom: 15px;">Total Market Overview</h3>
        
        <div class="metrics-grid-container">
            <!-- Row 1: YTD Metrics -->
            <div class="metric-item">
                <div class="metric-label">YTD Total Volume</div>
                <div class="metric-value">${formatNumber(data.totalMarketShareVolume?.value || 0)}</div>
                <div class="metric-change" style="color: ${totalChange.includes('+') ? '#4ade80' : '#f87171'}">
                    ${totalChange} WoW
                </div>
            </div>
            
            <div class="metric-item">
                <div class="metric-label">YTD Streaming</div>
                <div class="metric-value">${formatNumber(data.totalStreaming || 0)}</div>
                <div class="metric-change" style="color: ${streamChange.includes('+') ? '#4ade80' : '#f87171'}">
                    ${streamChange} WoW
                </div>
            </div>
            
            <div class="metric-item">
                <div class="metric-label">YTD Albums</div>
                <div class="metric-value">${formatNumber(data.totalAlbums || 0)}</div>
                <div class="metric-change" style="color: ${albumChange.includes('+') ? '#4ade80' : '#f87171'}">
                    ${albumChange} WoW
                </div>
            </div>
            
            <!-- Row 2: Weekly Metrics -->
            <div class="metric-item">
                <div class="metric-label">Weekly Units</div>
                <div class="metric-value">${formatNumber(weeklyTotal)}</div>
            </div>
            
            <div class="metric-item">
                <div class="metric-label">Weekly Streams</div>
                <div class="metric-value">${formatNumber(weeklyStreaming)}</div>
            </div>
            
            <div class="metric-item">
                <div class="metric-label">Weekly Albums</div>
                <div class="metric-value">${formatNumber(weeklyAlbums)}</div>
            </div>
        </div>
    `;
}

function updateAlerts() {
    const alertsSection = document.getElementById('alertsSection');
    const alertsList = document.getElementById('alertsList');
    
    if (!alertsSection || !alertsList || !currentWeek || !weeklyData[currentWeek]) {
        if (alertsSection) alertsSection.style.display = 'none';
        return;
    }
    
    const data = weeklyData[currentWeek];
    const prevWeek = getPreviousWeek(currentWeek);
    const prevData = prevWeek ? weeklyData[prevWeek] : null;
    
    if (!prevData) {
        alertsSection.style.display = 'none';
        return;
    }
    
    const alerts = [];
    
    // Check for significant changes
    Object.entries(data.marketShares).forEach(([label, info]) => {
        if (prevData.marketShares[label]) {
            const change = info.percentage - prevData.marketShares[label].percentage;
            if (Math.abs(change) > 1.0) { // More than 1% change
                alerts.push({
                    label,
                    change,
                    newShare: info.percentage
                });
            }
        }
    });
    
    if (alerts.length > 0) {
        alertsSection.style.display = 'block';
        alertsList.innerHTML = alerts
            .sort((a, b) => Math.abs(b.change) - Math.abs(a.change))
            .map(alert => `
                <div class="alert-item">
                    <strong>${alert.label}</strong>: 
                    <span style="color: ${alert.change > 0 ? '#4ade80' : '#f87171'}">
                        ${alert.change > 0 ? '+' : ''}${alert.change.toFixed(1)}%
                    </span>
                    (now ${alert.newShare.toFixed(1)}%)
                </div>
            `).join('');
    } else {
        alertsSection.style.display = 'none';
    }
}

function updateBiggestMovers() {
    const container = document.getElementById('biggestMovers');
    if (!container || !currentWeek || !weeklyData[currentWeek]) return;
    
    const data = weeklyData[currentWeek];
    const prevWeek = getPreviousWeek(currentWeek);
    const prevData = prevWeek ? weeklyData[prevWeek] : null;
    
    if (!prevData) {
        container.innerHTML = '<p style="text-align: center; color: #888;">Need previous week data for comparison</p>';
        return;
    }
    
    // Calculate all changes based on absolute point change, not percentage change
    const changes = [];
    Object.entries(data.marketShares).forEach(([label, info]) => {
        if (prevData.marketShares[label]) {
            const prevShare = prevData.marketShares[label].percentage;
            const pointChange = info.percentage - prevShare;
            
            changes.push({
                label,
                pointChange,
                currentShare: info.percentage,
                prevShare
            });
        }
    });
    
    // Sort by absolute point change
    changes.sort((a, b) => Math.abs(b.pointChange) - Math.abs(a.pointChange));
    
    // Get top 3 movers
    const topMovers = changes.slice(0, 3);
    
    container.innerHTML = topMovers.map((mover, index) => `
        <div class="performance-card">
            <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 1.5rem;">${index === 0 ? '#1' : index === 1 ? '#2' : '#3'}</span>
                ${mover.label}
            </h4>
            <div class="performance-metric">
                <span>Change</span>
                <span style="color: ${mover.pointChange > 0 ? '#4ade80' : '#f87171'}; font-weight: 600;">
                    ${mover.pointChange > 0 ? '+' : ''}${mover.pointChange.toFixed(2)}%
                </span>
            </div>
            <div class="performance-metric">
                <span>Current Share</span>
                <span>${mover.currentShare.toFixed(1)}%</span>
            </div>
            <div class="performance-metric">
                <span>Previous</span>
                <span style="color: #888;">${mover.prevShare.toFixed(1)}%</span>
            </div>
        </div>
    `).join('');
}

function updateMetricsGrid() {
    const grid = document.getElementById('metricsGrid');
    if (!grid || !currentWeek || !weeklyData[currentWeek]) return;
    
    const data = weeklyData[currentWeek];
    const prevWeek = getPreviousWeek(currentWeek);
    const prevData = prevWeek ? weeklyData[prevWeek] : null;
    
    // Get all labels sorted by percentage (including "Total Others")
    const labels = Object.entries(data.marketShares)
        .sort((a, b) => b[1].percentage - a[1].percentage);
    
    grid.innerHTML = labels.map(([label, info]) => {
        let change = 'N/A';
        let changeClass = '';
        
        // Calculate weekly values
        let weeklyUnits = info.value || 0;
        let weeklyStreaming = info.streaming || 0;
        let weeklyAlbums = info.albums || 0;
        
        if (prevData && prevData.marketShares[label]) {
            const diff = info.percentage - prevData.marketShares[label].percentage;
            change = `${diff > 0 ? '+' : ''}${diff.toFixed(2)}%`;
            changeClass = diff > 0 ? 'positive' : diff < 0 ? 'negative' : '';
            
            // Calculate weekly values (current YTD - previous YTD)
            weeklyUnits = (info.value || 0) - (prevData.marketShares[label].value || 0);
            weeklyStreaming = (info.streaming || 0) - (prevData.marketShares[label].streaming || 0);
            weeklyAlbums = (info.albums || 0) - (prevData.marketShares[label].albums || 0);
        }
        
        return `
            <div class="metric-card" style="background: ${label === 'Total Others' ? 'rgba(255, 255, 255, 0.03)' : 'rgba(255, 255, 255, 0.05)'};">
                <div class="metric-label">${label}</div>
                <div class="metric-value">${info.percentage.toFixed(1)}%</div>
                <div class="metric-change ${changeClass}">${change} WoW</div>
                
                <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                    <h5 style="font-size: 0.75rem; color: #667eea; margin-bottom: 10px; text-transform: uppercase;">Year-to-Date</h5>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #888; font-size: 0.8rem;">YTD Units</span>
                        <span style="font-weight: 500;">${formatNumber(info.value)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #888; font-size: 0.8rem;">YTD Streaming</span>
                        <span style="font-weight: 500;">${formatNumber(info.streaming || 0)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #888; font-size: 0.8rem;">YTD Albums</span>
                        <span style="font-weight: 500;">${formatNumber(info.albums || 0)}</span>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                    <h5 style="font-size: 0.75rem; color: #44A700; margin-bottom: 10px; text-transform: uppercase;">This Week</h5>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #888; font-size: 0.8rem;">Weekly Units</span>
                        <span style="font-weight: 500; color: ${weeklyUnits >= 0 ? '#e0e0e0' : '#f87171'};">
                            ${weeklyUnits >= 0 ? '+' : ''}${formatNumber(weeklyUnits)}
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #888; font-size: 0.8rem;">Weekly Streams</span>
                        <span style="font-weight: 500; color: ${weeklyStreaming >= 0 ? '#e0e0e0' : '#f87171'};">
                            ${weeklyStreaming >= 0 ? '+' : ''}${formatNumber(weeklyStreaming)}
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #888; font-size: 0.8rem;">Weekly Albums</span>
                        <span style="font-weight: 500; color: ${weeklyAlbums >= 0 ? '#e0e0e0' : '#f87171'};">
                            ${weeklyAlbums >= 0 ? '+' : ''}${formatNumber(weeklyAlbums)}
                        </span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// ==========================================
// CHART UPDATE FUNCTIONS
// ==========================================
function updatePieChart() {
    const canvas = document.getElementById('pieChart');
    if (!canvas || !currentWeek || !weeklyData[currentWeek]) return;
    
    const ctx = canvas.getContext('2d');
    const data = weeklyData[currentWeek];
    
    // Prepare data for pie chart
    const labels = Object.keys(data.marketShares);
    const values = labels.map(label => data.marketShares[label].percentage);
    const colors = labels.map(label => getLabelColor(label));
    
    // Create or update chart
    if (window.pieChartInstance) {
        window.pieChartInstance.data.labels = labels;
        window.pieChartInstance.data.datasets[0].data = values;
        window.pieChartInstance.data.datasets[0].backgroundColor = colors;
        window.pieChartInstance.update();
    } else {
        window.pieChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                return `${label}: ${value.toFixed(1)}%`;
                            }
                        }
                    }
                }
            }
        });
    }
}

function updateBarChart() {
    const canvas = document.getElementById('barChart');
    if (!canvas || !currentWeek || !weeklyData[currentWeek]) return;
    
    const ctx = canvas.getContext('2d');
    const data = weeklyData[currentWeek];
    const prevWeek = getPreviousWeek(currentWeek);
    const prevData = prevWeek ? weeklyData[prevWeek] : null;
    
    // Calculate week-over-week changes
    const changes = [];
    Object.entries(data.marketShares).forEach(([label, info]) => {
        if (prevData && prevData.marketShares[label]) {
            const change = info.percentage - prevData.marketShares[label].percentage;
            changes.push({ label, change });
        }
    });
    
    // Sort by absolute change
    changes.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
    const topChanges = changes.slice(0, 10);
    
    const labels = topChanges.map(item => item.label);
    const values = topChanges.map(item => item.change);
    const colors = values.map(v => v >= 0 ? '#4ade80' : '#f87171');
    
    if (window.barChartInstance) {
        window.barChartInstance.data.labels = labels;
        window.barChartInstance.data.datasets[0].data = values;
        window.barChartInstance.data.datasets[0].backgroundColor = colors;
        window.barChartInstance.update();
    } else {
        window.barChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Change (%)',
                    data: values,
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y || 0;
                                return `Change: ${value > 0 ? '+' : ''}${value.toFixed(2)}%`;
                            }
                        }
                    }
                }
            }
        });
    }
}

function updateStreamChart() {
    const placeholder = document.getElementById('streamChartPlaceholder');
    const wrapper = document.getElementById('streamChartWrapper');
    const canvas = document.getElementById('streamChart');
    
    if (!canvas || !weeklyData) return;
    
    const weeks = Object.keys(weeklyData).sort();
    
    // Check if we have enough data
    if (weeks.length < 8) {
        if (placeholder) {
            placeholder.style.display = 'block';
            const progress = document.getElementById('streamChartProgress');
            if (progress) {
                progress.textContent = `Currently have ${weeks.length} weeks of data`;
            }
        }
        if (wrapper) wrapper.style.display = 'none';
        return;
    }
    
    // Hide placeholder, show chart
    if (placeholder) placeholder.style.display = 'none';
    if (wrapper) wrapper.style.display = 'block';
    
    // Prepare data for stacked area chart
    const labels = ['Provident', 'CCMG', 'ADA', 'THE ORCHARD', 'Fair Trade', 'WORD/CURB'];
    const datasets = labels.map((label, index) => {
        const data = [];
        
        for (let i = 1; i < weeks.length; i++) {
            const currentData = weeklyData[weeks[i]];
            const prevData = weeklyData[weeks[i-1]];
            
            if (currentData.marketShares[label] && prevData.marketShares[label]) {
                const change = currentData.marketShares[label].value - prevData.marketShares[label].value;
                data.push(change);
            } else {
                data.push(0);
            }
        }
        
        const colors = ['#E25423', '#1696F3', '#FEAE20', '#3DB5AD', '#44A700', '#A350DD'];
        
        return {
    label: label,
    data: data,
    backgroundColor: getLabelColor(label), // Remove transparency
    borderColor: getLabelColor(label),
    borderWidth: 2,
    fill: false, // Change from 'origin' to false
    tension: 0.4
};
    });
    
    const ctx = canvas.getContext('2d');
    
    if (window.streamChartInstance) {
        window.streamChartInstance.destroy();
    }
    
    window.streamChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: weeks.slice(1),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: false
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Volume Change'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatNumber(value);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label;
                            const value = context.parsed.y;
                            return `${label}: ${value > 0 ? '+' : ''}${formatNumber(value)}`;
                        }
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 10,
                        font: { size: 11 }
                    }
                }
            },
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const week = weeks.slice(1)[index];
                    selectWeek(week);
                }
            }
        }
    });
}

// ==========================================
// ANALYTICS TAB FUNCTIONS
// ==========================================
function updateAnalyticsTab() {
    console.log('Updating analytics tab...');
    
    if (!weeklyData || Object.keys(weeklyData).length === 0) {
        console.log('No data available for analytics');
        return;
    }
    
    // Update all analytics charts
    updateAnalyticsStreamChart();
    updateCorrelationChart();
    updateVolatilityChart();
    updateTrendChart();
    updatePredictiveChart();
}

function updateAnalyticsStreamChart() {
    const placeholder = document.getElementById('analyticsStreamChartPlaceholder');
    const wrapper = document.getElementById('analyticsStreamChartWrapper');
    const canvas = document.getElementById('analyticsStreamChart');
    
    if (!canvas || !weeklyData) return;
    
    const weeks = Object.keys(weeklyData).sort();
    
    // Check if we have enough data
    if (weeks.length < 8) {
        if (placeholder) placeholder.style.display = 'block';
        if (wrapper) wrapper.style.display = 'none';
        return;
    }
    
    // Hide placeholder, show chart
    if (placeholder) placeholder.style.display = 'none';
    if (wrapper) wrapper.style.display = 'block';
    
    // Prepare data for stacked area chart
    const labels = ['Provident', 'CCMG', 'ADA', 'THE ORCHARD', 'Fair Trade', 'WORD/CURB'];
    const datasets = labels.map((label, index) => {
        const data = [];
        
        for (let i = 1; i < weeks.length; i++) {
            const currentData = weeklyData[weeks[i]];
            const prevData = weeklyData[weeks[i-1]];
            
            if (currentData.marketShares[label] && prevData.marketShares[label]) {
                const change = currentData.marketShares[label].value - prevData.marketShares[label].value;
                data.push(change);
            } else {
                data.push(0);
            }
        }
        
       return {
    label: label,
    data: data,
    backgroundColor: getLabelColor(label), // Remove transparency
    borderColor: getLabelColor(label),
    borderWidth: 2,
    fill: false, // Change from 'origin' to false
    tension: 0.4
};
    });
    
    const ctx = canvas.getContext('2d');
    
    if (window.analyticsStreamChartInstance) {
        window.analyticsStreamChartInstance.destroy();
    }
    
    window.analyticsStreamChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: weeks.slice(1),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: false
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Volume Change'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatNumber(value);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label;
                            const value = context.parsed.y;
                            return `${label}: ${value > 0 ? '+' : ''}${formatNumber(value)}`;
                        }
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 10,
                        font: { size: 11 }
                    }
                }
            }
        }
    });
}

function updateCorrelationChart() {
    const canvas = document.getElementById('correlationChart');
    if (!canvas || !weeklyData || !currentWeek) return;
    
    const ctx = canvas.getContext('2d');
    const currentData = weeklyData[currentWeek];
    
    if (!currentData || !currentData.marketShares) return;
    
    // Prepare data - one point per label showing YTD totals
    const labels = ['Provident', 'CCMG', 'ADA', 'THE ORCHARD', 'Fair Trade', 'WORD/CURB'];
    const datasets = [{
        label: 'Labels',
        data: labels.map(label => {
            const labelData = currentData.marketShares[label];
            if (labelData) {
                return {
                    x: labelData.albums || 0,
                    y: labelData.streaming || 0,
                    label: label
                };
            }
            return { x: 0, y: 0, label: label };
        }),
        backgroundColor: labels.map(label => getLabelColor(label)),
        borderColor: labels.map(label => getLabelColor(label)),
        borderWidth: 2,
        pointRadius: 8,
        pointHoverRadius: 10
    }];
    
    if (window.correlationChartInstance) {
        window.correlationChartInstance.data.datasets = datasets;
        window.correlationChartInstance.update();
    } else {
        window.correlationChartInstance = new Chart(ctx, {
            type: 'scatter',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Album Sales (w/TEA) - YTD'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatNumber(value);
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Streaming Volume - YTD'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatNumber(value);
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const point = context.raw;
                                return [
                                    `${point.label}`,
                                    `Albums: ${formatNumber(point.x)}`,
                                    `Streams: ${formatNumber(point.y)}`
                                ];
                            }
                        }
                    }
                }
            }
        });
    }
}

function updateVolatilityChart() {
    const canvas = document.getElementById('volatilityChart');
    if (!canvas || !weeklyData) return;
    
    const ctx = canvas.getContext('2d');
    const labels = ['Provident', 'CCMG', 'ADA', 'THE ORCHARD', 'Fair Trade', 'WORD/CURB'];
    
    // Calculate volatility (standard deviation of week-over-week changes)
    const volatilityData = labels.map(label => {
        const changes = [];
        const weeks = Object.keys(weeklyData).sort();
        
        for (let i = 1; i < weeks.length; i++) {
            const curr = weeklyData[weeks[i]];
            const prev = weeklyData[weeks[i-1]];
            
            if (curr.marketShares[label] && prev.marketShares[label]) {
                const change = curr.marketShares[label].percentage - prev.marketShares[label].percentage;
                changes.push(change);
            }
        }
        
        // Calculate standard deviation
        const mean = changes.reduce((a, b) => a + b, 0) / changes.length;
        const variance = changes.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / changes.length;
        return Math.sqrt(variance);
    });
    
    // Get colors for each label
    const colors = labels.map(label => getLabelColor(label));
    
    if (window.volatilityChartInstance) {
        window.volatilityChartInstance.data.labels = labels;
        window.volatilityChartInstance.data.datasets[0].data = volatilityData;
        window.volatilityChartInstance.data.datasets[0].backgroundColor = colors;
        window.volatilityChartInstance.update();
    } else {
        window.volatilityChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Market Share Volatility',
                    data: volatilityData,
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Standard Deviation (%)'
                        }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
}

function updateTrendChart() {
    const canvas = document.getElementById('trendChart');
    if (!canvas || !weeklyData) return;
    
    const ctx = canvas.getContext('2d');
    const weeks = Object.keys(weeklyData).sort();
    const labels = ['Provident', 'CCMG', 'ADA', 'THE ORCHARD', 'Fair Trade', 'WORD/CURB'];
    
    const datasets = labels.map((label, index) => {
        const data = weeks.map(week => {
            const weekData = weeklyData[week];
            return weekData.marketShares[label] ? weekData.marketShares[label].percentage : 0;
        });
        
     return {
    label: label,
    data: data,
    borderColor: getLabelColor(label),
    backgroundColor: 'transparent', // Remove transparency
    borderWidth: 2,
    tension: 0.1,
    fill: false // Add this line
};
    });
    
    if (window.trendChartInstance) {
        window.trendChartInstance.data.labels = weeks;
        window.trendChartInstance.data.datasets = datasets;
        window.trendChartInstance.update();
    } else {
        window.trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: weeks,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Market Share %'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 10,
                            font: { size: 11 }
                        }
                    }
                }
            }
        });
    }
}

function updatePredictiveChart() {
    const canvas = document.getElementById('predictiveChart');
    if (!canvas || !weeklyData) return;
    
    const ctx = canvas.getContext('2d');
    const weeks = Object.keys(weeklyData).sort();
    const labels = ['Provident', 'CCMG', 'ADA', 'THE ORCHARD', 'Fair Trade', 'WORD/CURB'];
    
    // For now, just show the trend lines
    // In a full implementation, this would include regression analysis
    const datasets = labels.map((label, index) => {
        const data = weeks.map(week => {
            const weekData = weeklyData[week];
            return weekData.marketShares[label] ? weekData.marketShares[label].value : 0;
        });
        
      return {
    label: label,
    data: data,
    borderColor: getLabelColor(label),
    backgroundColor: 'transparent', // Remove transparency
    borderWidth: 2,
    tension: 0.1,
    fill: false // Add this line
};
    });
    
    if (window.predictiveChartInstance) {
        window.predictiveChartInstance.data.labels = weeks;
        window.predictiveChartInstance.data.datasets = datasets;
        window.predictiveChartInstance.update();
    } else {
        window.predictiveChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: weeks,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Units'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatNumber(value);
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Historical Trend (Future projections would appear as dashed lines)'
                    }
                }
            }
        });
    }
}

// ==========================================
// PERFORMANCE TAB FUNCTIONS
// ==========================================
function updatePerformanceTab() {
    console.log('Updating performance tab...');
    
    if (!currentWeek || !weeklyData[currentWeek]) {
        console.log('No current week data for performance');
        return;
    }
    
    updatePerformanceCards();
    updateRankingTable();
}

function updatePerformanceCards() {
    const container = document.getElementById('performanceCards');
    if (!container || !currentWeek || !weeklyData[currentWeek]) return;
    
    const data = weeklyData[currentWeek];
    const labels = Object.entries(data.marketShares)
        .filter(([label]) => label !== 'Total Others')
        .sort((a, b) => b[1].percentage - a[1].percentage)
        .slice(0, 6)
        .map(([label]) => label);
    
    // Calculate performance metrics for each label
    const cards = labels.map(label => {
        const weeks = Object.keys(weeklyData).sort();
        const recentWeeks = weeks.slice(-4);
        
        let avgGrowth = 0;
        let volatility = 0;
        let trendDirection = 'stable';
        
        // Calculate metrics
        const changes = [];
        for (let i = 1; i < recentWeeks.length; i++) {
            const curr = weeklyData[recentWeeks[i]];
            const prev = weeklyData[recentWeeks[i-1]];
            
            if (curr.marketShares[label] && prev.marketShares[label]) {
                const change = ((curr.marketShares[label].value - prev.marketShares[label].value) / 
                               prev.marketShares[label].value * 100);
                changes.push(change);
            }
        }
        
        if (changes.length > 0) {
            avgGrowth = changes.reduce((a, b) => a + b, 0) / changes.length;
            const variance = changes.reduce((sum, val) => sum + Math.pow(val - avgGrowth, 2), 0) / changes.length;
            volatility = Math.sqrt(variance);
            
            // Determine trend
            if (avgGrowth > 2) trendDirection = 'up';
            else if (avgGrowth < -2) trendDirection = 'down';
        }
        
        return { label, avgGrowth, volatility, trendDirection };
    });
    
    container.innerHTML = cards.map(card => `
        <div class="performance-card">
            <h4>${card.label}</h4>
            <div class="performance-metric">
                <span>Avg Growth (4W)</span>
                <span style="color: ${card.avgGrowth > 0 ? '#4ade80' : '#f87171'}">
                    ${card.avgGrowth > 0 ? '+' : ''}${card.avgGrowth.toFixed(1)}%
                </span>
            </div>
            <div class="performance-metric">
                <span>Volatility</span>
                <span>${card.volatility.toFixed(1)}%</span>
            </div>
            <div class="performance-metric">
                <span>Trend</span>
                <span style="color: ${card.trendDirection === 'up' ? '#4ade80' : 
                                     card.trendDirection === 'down' ? '#f87171' : '#ffa500'}">
                    ${card.trendDirection === 'up' ? '↑' : 
                      card.trendDirection === 'down' ? '↓' : '→'} ${card.trendDirection}
                </span>
            </div>
        </div>
    `).join('');
}

function updateRankingTable() {
    const tbody = document.getElementById('rankingTableBody');
    const mobileContainer = document.getElementById('mobileRankings');
   
    if (!tbody || !currentWeek || !weeklyData[currentWeek]) return;
    
    const data = weeklyData[currentWeek];
    const prevWeek = getPreviousWeek(currentWeek);
    const prevData = prevWeek ? weeklyData[prevWeek] : null;
    
    // Get all labels sorted by market share
    const rankings = Object.entries(data.marketShares)
        .map(([label, info], index) => {
            let growth = 0;
            let volatility = 0;
            
            // Calculate weekly values
            let weeklyUnits = info.value || 0;
            let weeklyAlbums = info.albums || 0;
            let weeklyStreams = info.streaming || 0;
            
            // Calculate growth and weekly values
            if (prevData && prevData.marketShares[label]) {
                growth = ((info.value - prevData.marketShares[label].value) / 
                         prevData.marketShares[label].value * 100);
                         
                // Calculate weekly values (current YTD - previous YTD)
                weeklyUnits = (info.value || 0) - (prevData.marketShares[label].value || 0);
                weeklyAlbums = (info.albums || 0) - (prevData.marketShares[label].albums || 0);
                weeklyStreams = (info.streaming || 0) - (prevData.marketShares[label].streaming || 0);
            }
            
            // Calculate volatility (simplified)
            const weeks = Object.keys(weeklyData).sort().slice(-4);
            const changes = [];
            for (let i = 1; i < weeks.length; i++) {
                const curr = weeklyData[weeks[i]];
                const prev = weeklyData[weeks[i-1]];
                if (curr.marketShares[label] && prev.marketShares[label]) {
                    const change = curr.marketShares[label].percentage - prev.marketShares[label].percentage;
                    changes.push(change);
                }
            }
            
            if (changes.length > 0) {
                const mean = changes.reduce((a, b) => a + b, 0) / changes.length;
                const variance = changes.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / changes.length;
                volatility = Math.sqrt(variance);
            }
            
            return {
                rank: index + 1,
                label,
                marketShare: info.percentage,
                weeklyUnits,
                ytdUnits: info.value,
                weeklyAlbums,
                ytdAlbums: info.albums || 0,
                weeklyStreams,
                ytdStreams: info.streaming || 0,
                growth,
                volatility
            };
        })
        .sort((a, b) => b.marketShare - a.marketShare);
    
    // Update desktop table
    tbody.innerHTML = rankings.map((item, index) => `
        <tr>
            <td>${index + 1}</td>
            <td>${item.label}</td>
            <td>${item.marketShare.toFixed(2)}%</td>
            <td title="Weekly: ${formatNumber(item.weeklyUnits)}">
                <div style="display: flex; flex-direction: column; gap: 2px;">
                    <span style="font-weight: 500;">${formatNumber(item.ytdUnits)}</span>
                    <span style="font-size: 0.8rem; color: ${item.weeklyUnits >= 0 ? '#888' : '#f87171'}">
                        W: ${item.weeklyUnits >= 0 ? '+' : ''}${formatNumber(item.weeklyUnits)}
                    </span>
                </div>
            </td>
            <td>${formatNumber(item.ytdUnits)}</td>
            <td title="Weekly: ${formatNumber(item.weeklyAlbums)}">
                <div style="display: flex; flex-direction: column; gap: 2px;">
                    <span style="font-weight: 500;">${formatNumber(item.ytdAlbums)}</span>
                    <span style="font-size: 0.8rem; color: ${item.weeklyAlbums >= 0 ? '#888' : '#f87171'}">
                        W: ${item.weeklyAlbums >= 0 ? '+' : ''}${formatNumber(item.weeklyAlbums)}
                    </span>
                </div>
            </td>
            <td title="Weekly: ${formatNumber(item.weeklyStreams)}">
                <div style="display: flex; flex-direction: column; gap: 2px;">
                    <span style="font-weight: 500;">${formatNumber(item.ytdStreams)}</span>
                    <span style="font-size: 0.8rem; color: ${item.weeklyStreams >= 0 ? '#888' : '#f87171'}">
                        W: ${item.weeklyStreams >= 0 ? '+' : ''}${formatNumber(item.weeklyStreams)}
                    </span>
                </div>
            </td>
            <td style="color: ${item.growth > 0 ? '#4ade80' : '#f87171'}">
                ${item.growth > 0 ? '+' : ''}${item.growth.toFixed(1)}%
            </td>
            <td>
                <span class="volatility-indicator ${
                    item.volatility < 0.5 ? 'volatility-low' : 
                    item.volatility < 1.0 ? 'volatility-medium' : 
                    'volatility-high'
                }"></span>
                ${item.volatility.toFixed(2)}
            </td>
        </tr>
    `).join('');
    
    // Update mobile cards
    if (mobileContainer) {
        mobileContainer.innerHTML = rankings.slice(0, 10).map((item, index) => `
            <div class="ranking-card">
                <div class="ranking-card-header">
                    <div class="ranking-card-rank">
                        <div class="rank-number">${index + 1}</div>
                        <div class="rank-label">${item.label}</div>
                    </div>
                    <div class="market-share-badge">${item.marketShare.toFixed(1)}%</div>
                </div>
                <div class="ranking-card-body">
                    <div class="ranking-metric-group">
                        <div class="ranking-metric-group-title">Year-to-Date</div>
                        <div class="ranking-metric">
                            <span class="ranking-metric-label">YTD Units</span>
                            <span class="ranking-metric-value">${formatNumber(item.ytdUnits)}</span>
                        </div>
                        <div class="ranking-metric">
                            <span class="ranking-metric-label">YTD Albums</span>
                            <span class="ranking-metric-value">${formatNumber(item.ytdAlbums)}</span>
                        </div>
                        <div class="ranking-metric">
                            <span class="ranking-metric-label">YTD Streaming</span>
                            <span class="ranking-metric-value">${formatNumber(item.ytdStreams)}</span>
                        </div>
                    </div>
                    
                    <div class="ranking-metric-group" style="background: rgba(68, 167, 0, 0.1);">
                        <div class="ranking-metric-group-title">This Week</div>
                        <div class="ranking-metric">
                            <span class="ranking-metric-label">Weekly Units</span>
                            <span class="ranking-metric-value" style="color: ${item.weeklyUnits >= 0 ? '#e0e0e0' : '#f87171'}">
                                ${item.weeklyUnits >= 0 ? '+' : ''}${formatNumber(item.weeklyUnits)}
                            </span>
                        </div>
                        <div class="ranking-metric">
                            <span class="ranking-metric-label">Weekly Albums</span>
                            <span class="ranking-metric-value" style="color: ${item.weeklyAlbums >= 0 ? '#e0e0e0' : '#f87171'}">
                                ${item.weeklyAlbums >= 0 ? '+' : ''}${formatNumber(item.weeklyAlbums)}
                            </span>
                        </div>
                        <div class="ranking-metric">
                            <span class="ranking-metric-label">Weekly Streams</span>
                            <span class="ranking-metric-value" style="color: ${item.weeklyStreams >= 0 ? '#e0e0e0' : '#f87171'}">
                                ${item.weeklyStreams >= 0 ? '+' : ''}${formatNumber(item.weeklyStreams)}
                            </span>
                        </div>
                    </div>
                    
                    <div class="ranking-metric">
                        <span class="ranking-metric-label">Growth Rate</span>
                        <span class="ranking-metric-value" style="color: ${item.growth > 0 ? '#4ade80' : '#f87171'}">
                            ${item.growth > 0 ? '+' : ''}${item.growth.toFixed(1)}%
                        </span>
                    </div>
                </div>
            </div>
        `).join('');
    }
}

// ==========================================
// COMPARISON TAB FUNCTIONS
// ==========================================
function updateComparisonTab() {
    console.log('Updating comparison tab...');
    
    if (!currentWeek || !weeklyData[currentWeek]) {
        console.log('No current week data for comparison');
        return;
    }
    
    // Set up event listeners if not already set
    const label1Select = document.getElementById('label1Select');
    const label2Select = document.getElementById('label2Select');
    
    if (label1Select && !label1Select.hasAttribute('data-listener')) {
        label1Select.addEventListener('change', updateComparisonView);
        label1Select.setAttribute('data-listener', 'true');
    }
    
    if (label2Select && !label2Select.hasAttribute('data-listener')) {
        label2Select.addEventListener('change', updateComparisonView);
        label2Select.setAttribute('data-listener', 'true');
    }
    
    updateComparisonView();
}

function updateComparisonView() {
    const label1 = document.getElementById('label1Select').value;
    const label2 = document.getElementById('label2Select').value;
    
    updateComparisonCards(label1, label2);
    updateComparisonChart(label1, label2);
    updateHeadToHeadChart(label1, label2);
    updateComparisonVolumeChanges(label1, label2);
}

function updateComparisonCards(label1, label2) {
    const container = document.getElementById('comparisonCards');
    if (!container || !currentWeek || !weeklyData[currentWeek]) return;
    
    const data = weeklyData[currentWeek];
    const prevWeek = getPreviousWeek(currentWeek);
    const prevData = prevWeek ? weeklyData[prevWeek] : null;
    
    // Create cards for each label
    const createCard = (label) => {
        const info = data.marketShares[label];
        if (!info) return '';
        
        let change = 'N/A';
        let weeklyUnits = info.value || 0;
        let weeklyStreaming = info.streaming || 0;
        let weeklyAlbums = info.albums || 0;
        
        if (prevData && prevData.marketShares[label]) {
            const diff = info.percentage - prevData.marketShares[label].percentage;
            change = `${diff > 0 ? '+' : ''}${diff.toFixed(2)}%`;
            
            // Calculate weekly values
            weeklyUnits = (info.value || 0) - (prevData.marketShares[label].value || 0);
            weeklyStreaming = (info.streaming || 0) - (prevData.marketShares[label].streaming || 0);
            weeklyAlbums = (info.albums || 0) - (prevData.marketShares[label].albums || 0);
        }
        
        return `
            <div class="performance-card">
                <h4>${label}</h4>
                <div class="performance-metric">
                    <span>Market Share</span>
                    <span>${info.percentage.toFixed(2)}%</span>
                </div>
                <div class="performance-metric">
                    <span>WoW Change</span>
                    <span style="color: ${change.includes('+') ? '#4ade80' : '#f87171'}">${change}</span>
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <h5 style="font-size: 0.85rem; color: #667eea; margin-bottom: 10px;">Year-to-Date</h5>
                    <div class="performance-metric">
                        <span>YTD Units</span>
                        <span>${formatNumber(info.value)}</span>
                    </div>
                    <div class="performance-metric">
                        <span>YTD Streaming</span>
                        <span>${formatNumber(info.streaming || 0)}</span>
                    </div>
                    <div class="performance-metric">
                        <span>YTD Albums</span>
                        <span>${formatNumber(info.albums || 0)}</span>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <h5 style="font-size: 0.85rem; color: #44A700; margin-bottom: 10px;">This Week</h5>
                    <div class="performance-metric">
                        <span>Weekly Units</span>
                        <span style="color: ${weeklyUnits >= 0 ? '#e0e0e0' : '#f87171'}">
                            ${weeklyUnits >= 0 ? '+' : ''}${formatNumber(weeklyUnits)}
                        </span>
                    </div>
                    <div class="performance-metric">
                        <span>Weekly Streams</span>
                        <span style="color: ${weeklyStreaming >= 0 ? '#e0e0e0' : '#f87171'}">
                            ${weeklyStreaming >= 0 ? '+' : ''}${formatNumber(weeklyStreaming)}
                        </span>
                    </div>
                    <div class="performance-metric">
                        <span>Weekly Albums</span>
                        <span style="color: ${weeklyAlbums >= 0 ? '#e0e0e0' : '#f87171'}">
                            ${weeklyAlbums >= 0 ? '+' : ''}${formatNumber(weeklyAlbums)}
                        </span>
                    </div>
                </div>
            </div>
        `;
    };
    
    // Comparison metrics
    const info1 = data.marketShares[label1];
    const info2 = data.marketShares[label2];
    
    let comparisonCard = '';
    if (info1 && info2) {
        const shareDiff = info1.percentage - info2.percentage;
        const unitsDiff = info1.value - info2.value;
        const streamDiff = info1.streaming - info2.streaming;
        const albumDiff = info1.albums - info2.albums;
        
        // Calculate weekly differences if previous data exists
        let weeklyUnitsDiff = unitsDiff;
        let weeklyStreamDiff = streamDiff;
        let weeklyAlbumDiff = albumDiff;
        
        if (prevData && prevData.marketShares[label1] && prevData.marketShares[label2]) {
            const prevInfo1 = prevData.marketShares[label1];
            const prevInfo2 = prevData.marketShares[label2];
            
            const weekly1Units = (info1.value || 0) - (prevInfo1.value || 0);
            const weekly2Units = (info2.value || 0) - (prevInfo2.value || 0);
            weeklyUnitsDiff = weekly1Units - weekly2Units;
            
            const weekly1Streams = (info1.streaming || 0) - (prevInfo1.streaming || 0);
            const weekly2Streams = (info2.streaming || 0) - (prevInfo2.streaming || 0);
            weeklyStreamDiff = weekly1Streams - weekly2Streams;
            
            const weekly1Albums = (info1.albums || 0) - (prevInfo1.albums || 0);
            const weekly2Albums = (info2.albums || 0) - (prevInfo2.albums || 0);
            weeklyAlbumDiff = weekly1Albums - weekly2Albums;
        }
        
        comparisonCard = `
            <div class="performance-card">
                <h4>Comparison</h4>
                <div class="performance-metric">
                    <span>Share Difference</span>
                    <span style="color: ${shareDiff > 0 ? '#4ade80' : '#f87171'}">
                        ${label1} ${shareDiff > 0 ? '+' : ''}${shareDiff.toFixed(2)}%
                    </span>
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <h5 style="font-size: 0.85rem; color: #667eea; margin-bottom: 10px;">YTD Differences</h5>
                    <div class="performance-metric">
                        <span>Units</span>
                        <span>${label1} ${unitsDiff > 0 ? '+' : ''}${formatNumber(unitsDiff)}</span>
                    </div>
                    <div class="performance-metric">
                        <span>Streaming</span>
                        <span>${label1} ${streamDiff > 0 ? '+' : ''}${formatNumber(streamDiff)}</span>
                    </div>
                    <div class="performance-metric">
                        <span>Albums</span>
                        <span>${label1} ${albumDiff > 0 ? '+' : ''}${formatNumber(albumDiff)}</span>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <h5 style="font-size: 0.85rem; color: #44A700; margin-bottom: 10px;">Weekly Differences</h5>
                    <div class="performance-metric">
                        <span>Units</span>
                        <span>${label1} ${weeklyUnitsDiff > 0 ? '+' : ''}${formatNumber(weeklyUnitsDiff)}</span>
                    </div>
                    <div class="performance-metric">
                        <span>Streams</span>
                        <span>${label1} ${weeklyStreamDiff > 0 ? '+' : ''}${formatNumber(weeklyStreamDiff)}</span>
                    </div>
                    <div class="performance-metric">
                        <span>Albums</span>
                        <span>${label1} ${weeklyAlbumDiff > 0 ? '+' : ''}${formatNumber(weeklyAlbumDiff)}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = createCard(label1) + comparisonCard + createCard(label2);
}

function updateComparisonChart(label1, label2) {
    const canvas = document.getElementById('comparisonChart');
    if (!canvas || !weeklyData) return;
    
    const ctx = canvas.getContext('2d');
    const weeks = Object.keys(weeklyData).sort();
    
    // Get data for both labels
    const data1 = weeks.map(week => {
        const data = weeklyData[week];
        return data.marketShares[label1] ? data.marketShares[label1].value : 0;
    });
    
    const data2 = weeks.map(week => {
        const data = weeklyData[week];
        return data.marketShares[label2] ? data.marketShares[label2].value : 0;
    });
    
    if (window.comparisonChartInstance) {
        window.comparisonChartInstance.data.labels = weeks;
        window.comparisonChartInstance.data.datasets = [
            {
                label: label1,
                data: data1,
                borderColor: getLabelColor(label1),
                backgroundColor: getLabelColor(label1) + '20',
                borderWidth: 2,
                tension: 0.1
            },
            {
                label: label2,
                data: data2,
                borderColor: getLabelColor(label2),
                backgroundColor: getLabelColor(label2) + '20',
                borderWidth: 2,
                tension: 0.1
            }
        ];
        window.comparisonChartInstance.update();
    } else {
        window.comparisonChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: weeks,
                datasets: [
    {
        label: label1,
        data: data1,
        borderColor: getLabelColor(label1),
        backgroundColor: 'transparent',
        borderWidth: 2,
        tension: 0.1,
        fill: false
    },
    {
        label: label2,
        data: data2,
        borderColor: getLabelColor(label2),
        backgroundColor: 'transparent',
        borderWidth: 2,
        tension: 0.1,
        fill: false
    }
]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatNumber(value);
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }
    
    // Update chart title
    const titleEl = document.getElementById('comparisonChartTitle');
    if (titleEl) {
        titleEl.textContent = `${label1} vs ${label2} - Units Over Time`;
    }
}

function updateHeadToHeadChart(label1, label2) {
    const canvas = document.getElementById('headToHeadChart');
    if (!canvas || !weeklyData) return;
    
    const ctx = canvas.getContext('2d');
    const weeks = Object.keys(weeklyData).sort();
    
    // Calculate week-over-week streaming volume changes (YTD)
    const changes1 = [];
    const changes2 = [];
    const weekLabels = [];
    
    for (let i = 1; i < weeks.length; i++) {
        const curr = weeklyData[weeks[i]];
        const prev = weeklyData[weeks[i-1]];
        
        // Calculate streaming volume change for label1
        if (curr.marketShares[label1] && prev.marketShares[label1]) {
            const currStreaming = curr.marketShares[label1].streaming || 0;
            const prevStreaming = prev.marketShares[label1].streaming || 0;
            changes1.push(currStreaming - prevStreaming);
        } else {
            changes1.push(0);
        }
        
        // Calculate streaming volume change for label2
        if (curr.marketShares[label2] && prev.marketShares[label2]) {
            const currStreaming = curr.marketShares[label2].streaming || 0;
            const prevStreaming = prev.marketShares[label2].streaming || 0;
            changes2.push(currStreaming - prevStreaming);
        } else {
            changes2.push(0);
        }
        
        weekLabels.push(weeks[i]);
    }
    
    if (window.headToHeadChartInstance) {
        window.headToHeadChartInstance.data.labels = weekLabels;
        window.headToHeadChartInstance.data.datasets = [
            {
                label: label1,
                data: changes1,
                backgroundColor: changes1.map(v => v >= 0 ? getLabelColor(label1) + '80' : getLabelColor(label1) + '50'),
                borderColor: getLabelColor(label1),
                borderWidth: 1
            },
            {
                label: label2,
                data: changes2,
                backgroundColor: changes2.map(v => v >= 0 ? getLabelColor(label2) + '80' : getLabelColor(label2) + '50'),
                borderColor: getLabelColor(label2),
                borderWidth: 1
            }
        ];
        window.headToHeadChartInstance.update();
    } else {
        window.headToHeadChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: weekLabels,
                datasets: [
                    {
                        label: label1,
                        data: changes1,
                        backgroundColor: changes1.map(v => v >= 0 ? getLabelColor(label1) + '80' : getLabelColor(label1) + '50'),
                        borderColor: getLabelColor(label1),
                        borderWidth: 1
                    },
                    {
                        label: label2,
                        data: changes2,
                        backgroundColor: changes2.map(v => v >= 0 ? getLabelColor(label2) + '80' : getLabelColor(label2) + '50'),
                        borderColor: getLabelColor(label2),
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Streaming Volume Change'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatNumber(value);
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y || 0;
                                return `${context.dataset.label}: ${value > 0 ? '+' : ''}${formatNumber(value)} streams`;
                            }
                        }
                    }
                }
            }
        });
    }
}

function updateComparisonVolumeChanges(label1, label2) {
    const placeholder = document.getElementById('comparisonVolumeChangesPlaceholder');
    const wrapper = document.getElementById('comparisonVolumeChangesWrapper');
    const canvas = document.getElementById('comparisonVolumeChangesChart');
    
    if (!canvas || !weeklyData) return;
    
    const weeks = Object.keys(weeklyData).sort();
    
    // Check if we have enough data
    if (weeks.length < 2) {
        if (placeholder) placeholder.style.display = 'block';
        if (wrapper) wrapper.style.display = 'none';
        return;
    }
    
    // Hide placeholder, show chart
    if (placeholder) placeholder.style.display = 'none';
    if (wrapper) wrapper.style.display = 'block';
    
    // Calculate volume changes
    const volumeChanges1 = [];
    const volumeChanges2 = [];
    const weekLabels = [];
    
    for (let i = 1; i < weeks.length; i++) {
        const curr = weeklyData[weeks[i]];
        const prev = weeklyData[weeks[i-1]];
        
        if (curr.marketShares[label1] && prev.marketShares[label1]) {
            const change = curr.marketShares[label1].value - prev.marketShares[label1].value;
            volumeChanges1.push(change);
        } else {
            volumeChanges1.push(0);
        }
        
        if (curr.marketShares[label2] && prev.marketShares[label2]) {
            const change = curr.marketShares[label2].value - prev.marketShares[label2].value;
            volumeChanges2.push(change);
        } else {
            volumeChanges2.push(0);
        }
        
        weekLabels.push(weeks[i]);
    }
    
    const ctx = canvas.getContext('2d');
    
    if (window.comparisonVolumeChangesChartInstance) {
        window.comparisonVolumeChangesChartInstance.destroy();
    }
    
    window.comparisonVolumeChangesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: weekLabels,
            datasets: [
    {
        label: label1,
        data: volumeChanges1,
        backgroundColor: 'transparent',
        borderColor: getLabelColor(label1),
        borderWidth: 2,
        fill: false,
        tension: 0.4
    },
    {
        label: label2,
        data: volumeChanges2,
        backgroundColor: 'transparent',
        borderColor: getLabelColor(label2),
        borderWidth: 2,
        fill: false,
        tension: 0.4
    }
]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    display: true
                },
                y: {
                    stacked: false,
                    title: {
                        display: true,
                        text: 'Volume Change'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatNumber(value);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label;
                            const value = context.parsed.y;
                            return `${label}: ${value > 0 ? '+' : ''}${formatNumber(value)}`;
                        }
                    }
                },
                legend: {
                    position: 'top'
                }
            }
        }
    });
    
    // Update title
    const titleEl = document.getElementById('comparisonVolumeChangesTitle');
    if (titleEl) {
        titleEl.textContent = `Week-over-Week Volume Changes: ${label1} vs ${label2}`;
    }
}

// ==========================================
// EXPORT TAB FUNCTIONS
// ==========================================
function updateExportTab() {
    console.log('Updating export tab...');
    
    if (!currentWeek || !weeklyData[currentWeek]) {
        console.log('No current week data for export');
        return;
    }
    
    updateWeeklySummaryExport();
}

function updateWeeklySummaryExport() {
    const summaryEl = document.getElementById('weeklySummary');
    if (!summaryEl || !currentWeek || !weeklyData[currentWeek]) return;
    
    const data = weeklyData[currentWeek];
    const prevWeek = getPreviousWeek(currentWeek);
    const prevData = prevWeek ? weeklyData[prevWeek] : null;
    
    let html = `
        <h2 style="text-align: center; margin-bottom: 30px;">Market Share Report - Week ${currentWeek}</h2>
        
        <h3>Executive Summary</h3>
        <p>${generateExecutiveSummary()}</p>
        
        <h3>Market Rankings</h3>
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
            <thead>
                <tr style="background: rgba(255, 255, 255, 0.1);">
                    <th style="padding: 10px; text-align: left;">Rank</th>
                    <th style="padding: 10px; text-align: left;">Label</th>
                    <th style="padding: 10px; text-align: right;">Market Share</th>
                    <th style="padding: 10px; text-align: right;">Units</th>
                    <th style="padding: 10px; text-align: right;">WoW Change</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    const rankings = Object.entries(data.marketShares)
        .sort((a, b) => b[1].percentage - a[1].percentage)
        .slice(0, 10);
    
    rankings.forEach(([label, info], index) => {
        let change = 'N/A';
        if (prevData && prevData.marketShares[label]) {
            const diff = info.percentage - prevData.marketShares[label].percentage;
            change = `${diff > 0 ? '+' : ''}${diff.toFixed(2)}%`;
        }
        
        html += `
            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <td style="padding: 10px;">${index + 1}</td>
                <td style="padding: 10px;">${label}</td>
                <td style="padding: 10px; text-align: right;">${info.percentage.toFixed(2)}%</td>
                <td style="padding: 10px; text-align: right;">${formatNumber(info.value)}</td>
                <td style="padding: 10px; text-align: right; color: ${change.includes('+') ? '#4ade80' : '#f87171'}">${change}</td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
        
        <h3>Key Insights</h3>
        <ul style="line-height: 1.8;">
            ${generateKeyInsights()}
        </ul>
        
        <p style="margin-top: 30px; font-size: 0.9rem; color: #888; text-align: center;">
            Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
        </p>
    `;
    
    summaryEl.innerHTML = html;
}

function generateExecutiveSummary() {
    const data = weeklyData[currentWeek];
    const sortedLabels = Object.entries(data.marketShares)
        .sort((a, b) => b[1].percentage - a[1].percentage);
    
    const [leader, leaderData] = sortedLabels[0];
    const totalUnits = Object.values(data.marketShares)
        .reduce((sum, label) => sum + label.value, 0);
    
    return `For the week ending ${currentWeek}, the market processed ${formatNumber(totalUnits)} total units 
            with ${formatNumber(data.totalStreaming)} streams. ${leader} maintained market leadership with 
            ${leaderData.percentage.toFixed(1)}% market share, representing ${formatNumber(leaderData.value)} units.`;
}

function generateKeyInsights() {
    const insights = [];
    const data = weeklyData[currentWeek];
    const prevWeek = getPreviousWeek(currentWeek);
    const prevData = prevWeek ? weeklyData[prevWeek] : null;
    
    if (prevData) {
        // Find biggest gainers
        const gainers = [];
        Object.entries(data.marketShares).forEach(([label, info]) => {
            if (prevData.marketShares[label]) {
                const change = info.percentage - prevData.marketShares[label].percentage;
                if (change > 0.5) {
                    gainers.push({ label, change });
                }
            }
        });
        
        if (gainers.length > 0) {
            gainers.sort((a, b) => b.change - a.change);
            insights.push(`<li><strong>Top Gainers:</strong> ${gainers.slice(0, 3)
                .map(g => `${g.label} (+${g.change.toFixed(1)}%)`).join(', ')}</li>`);
        }
        
        // Overall market trend
        const marketChange = ((data.totalStreaming - prevData.totalStreaming) / prevData.totalStreaming * 100);
        insights.push(`<li><strong>Market Trend:</strong> Total streaming volume ${marketChange > 0 ? 'increased' : 'decreased'} 
                       by ${Math.abs(marketChange).toFixed(1)}% week-over-week</li>`);
    }
    
    // Market concentration
    const top3Share = Object.values(data.marketShares)
        .sort((a, b) => b.percentage - a.percentage)
        .slice(0, 3)
        .reduce((sum, label) => sum + label.percentage, 0);
    
    insights.push(`<li><strong>Market Concentration:</strong> Top 3 labels control ${top3Share.toFixed(1)}% of the market</li>`);
    
    return insights.join('\n');
}

// ==========================================
// SETTINGS TAB FUNCTIONS
// ==========================================
function updateSettingsTab() {
    console.log('Updating settings tab...');
    
    // Load week contexts if authenticated
    if (window.isSettingsAuthenticated) {
        loadSettings();
        // ADD THESE LINES
        updateContextWeekSelector();
        updateWeeksWithContextList();
        updateProjectionsList();
    }
}

function loadSettings() {
    console.log('Loading settings...');
    
    // Load saved contexts
    const savedContexts = localStorage.getItem('weekContexts');
    if (savedContexts) {
        weekContexts = JSON.parse(savedContexts);
    }
    
    // Load projections
    const savedProjections = localStorage.getItem('futureProjections');
    if (savedProjections) {
        futureProjections = JSON.parse(savedProjections);
    }
    
    // Update UI - MAKE SURE THESE LINES ARE HERE
    updateContextWeekSelector();
    updateWeeksWithContextList();
    updateProjectionsList();
}

function updateContextWeekSelector() {
    const selector = document.getElementById('contextWeekSelect');
    if (!selector || !weeklyData) return;
    
    selector.innerHTML = '';
    const weeks = Object.keys(weeklyData).sort();
    
    weeks.forEach(week => {
        const option = document.createElement('option');
        option.value = week;
        option.textContent = week;
        selector.appendChild(option);
    });
    
    // Add change handler
    selector.onchange = function() {
        const context = weekContexts[this.value] || '';
        document.getElementById('individualWeekContext').value = context;
        document.getElementById('existingContextIndicator').textContent = context ? '(has context)' : '';
    };
}

function updateWeeksWithContextList() {
    const container = document.getElementById('weeksWithContextList');
    const badge = document.getElementById('contextCountBadge');
    
    if (!container) return;
    
    const contextCount = Object.keys(weekContexts).length;
    if (badge) badge.textContent = contextCount;
    
    if (contextCount === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No contexts added yet</p>';
        return;
    }
    
    container.innerHTML = Object.entries(weekContexts)
        .sort((a, b) => b[0].localeCompare(a[0]))
        .map(([week, context]) => `
            <div style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <strong style="color: #667eea;">${week}</strong>
                        <p style="margin-top: 5px; color: #e0e0e0;">${context}</p>
                    </div>
                    <button onclick="removeWeekContext('${week}')" 
                            style="background: none; border: none; color: #f87171; cursor: pointer; padding: 5px;">
                        ✕
                    </button>
                </div>
            </div>
        `).join('');
}

function updateProjectionsList() {
    const container = document.getElementById('projectionsList');
    if (!container) return;
    
    if (futureProjections.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No projections added yet</p>';
        return;
    }
    
    container.innerHTML = futureProjections
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .map((proj, index) => `
            <div style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${proj.label}</strong> - ${proj.date}
                        <p style="margin-top: 5px; color: #667eea;">${formatNumber(proj.units)} units</p>
                    </div>
                    <button onclick="removeProjection(${index})" 
                            style="background: none; border: none; color: #f87171; cursor: pointer; padding: 5px;">
                        ✕
                    </button>
                </div>
            </div>
        `).join('');
}

// ==========================================
// HELPER FUNCTIONS
// ==========================================
function getPreviousWeek(week) {
    const weeks = Object.keys(weeklyData).sort();
    const currentIndex = weeks.indexOf(week);
    return currentIndex > 0 ? weeks[currentIndex - 1] : null;
}

// ==========================================
// PASSWORD PROTECTION FUNCTIONS
// ==========================================
function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
    }
    return hash.toString();
}

function checkSettingsPassword() {
    const passwordInput = document.getElementById('settingsPassword');
    const password = passwordInput.value;
    const errorEl = document.getElementById('passwordError');
    
    // Get stored password hash or use default
    const storedHash = localStorage.getItem('settingsPasswordHash');
    const defaultHash = simpleHash('admin');
    const passwordHash = simpleHash(password);
    
    if (passwordHash === storedHash || (!storedHash && passwordHash === defaultHash)) {
        // Success
        window.isSettingsAuthenticated = true;
        errorEl.style.display = 'none';
        passwordInput.value = '';
        document.getElementById('settingsLogin').style.display = 'none';
        document.getElementById('settingsContent').style.display = 'block';
        loadSettings();
        
        // ADD THESE LINES to initialize the context and projections
        updateContextWeekSelector();
        updateWeeksWithContextList();
        updateProjectionsList();
    } else {
        // Error
        errorEl.style.display = 'block';
        passwordInput.select();
    }
}

function logoutSettings() {
    window.isSettingsAuthenticated = false;
    document.getElementById('settingsLogin').style.display = 'block';
    document.getElementById('settingsContent').style.display = 'none';
    document.getElementById('passwordError').style.display = 'none';
    document.getElementById('settingsPassword').value = '';
}

function showChangePassword() {
    document.getElementById('changePasswordModal').style.display = 'flex';
    document.getElementById('newPassword').focus();
}

function hideChangePassword() {
    document.getElementById('changePasswordModal').style.display = 'none';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('passwordChangeError').style.display = 'none';
}

function changePassword() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const errorEl = document.getElementById('passwordChangeError');
    
    if (!newPassword) {
        errorEl.textContent = 'Please enter a new password';
        errorEl.style.display = 'block';
        return;
    }
    
    if (newPassword.length < 4) {
        errorEl.textContent = 'Password must be at least 4 characters';
        errorEl.style.display = 'block';
        return;
    }
    
    if (newPassword !== confirmPassword) {
        errorEl.textContent = 'Passwords do not match';
        errorEl.style.display = 'block';
        return;
    }
    
    // Save new password hash
    localStorage.setItem('settingsPasswordHash', simpleHash(newPassword));
    
    // Hide modal and show success
    hideChangePassword();
    
    const statusEl = document.getElementById('dataStatus');
    const originalText = statusEl.innerHTML;
    statusEl.innerHTML = '✓ Password changed successfully';
    setTimeout(() => {
        statusEl.innerHTML = originalText;
    }, 3000);
}

// ==========================================
// UTILITY FUNCTIONS
// ==========================================
function clearAllProjections() {
    if (confirm('Are you sure you want to clear all projections?')) {
        futureProjections = [];
        localStorage.removeItem('futureProjections');
        updateProjectionsList();
        
        // Update predictive chart if on analytics tab
        if (currentTab === 'analytics') {
            updatePredictiveChart();
        }
        
        // Show success message
        const statusEl = document.getElementById('dataStatus');
        const originalText = statusEl.innerHTML;
        statusEl.innerHTML = '✓ All projections cleared';
        setTimeout(() => {
            statusEl.innerHTML = originalText;
        }, 3000);
    }
}

// ==========================================
// CALCULATOR FUNCTIONS
// ==========================================
function calculateStreamsToUnits() {
    const input = document.getElementById('streamsToUnitsInput');
    const ratioSelect = document.getElementById('streamRatioSelect');
    const customDiv = document.getElementById('customRatioDiv');
    const customInput = document.getElementById('customRatioInput');
    const result = document.getElementById('unitsResult');
    
    if (!input || !ratioSelect || !result) return;
    
    const streams = parseFloat(input.value) || 0;
    let ratio = parseFloat(ratioSelect.value);
    
    if (ratioSelect.value === 'custom') {
        customDiv.style.display = 'block';
        ratio = parseFloat(customInput.value) || 1500;
    } else {
        customDiv.style.display = 'none';
    }
    
    const units = streams / ratio;
    result.textContent = formatNumber(Math.round(units));
}

function calculateStreamsToRevenue() {
    const input = document.getElementById('streamsToRevenueInput');
    const rateSelect = document.getElementById('revenueRateSelect');
    const customDiv = document.getElementById('customRevenueDiv');
    const customInput = document.getElementById('customRevenueInput');
    const result = document.getElementById('revenueResult');
    
    if (!input || !rateSelect || !result) return;
    
    const streams = parseFloat(input.value) || 0;
    let rate = parseFloat(rateSelect.value);
    
    if (rateSelect.value === 'custom') {
        customDiv.style.display = 'block';
        rate = parseFloat(customInput.value) || 0.0035;
    } else {
        customDiv.style.display = 'none';
    }
    
    const revenue = streams * rate;
    result.textContent = '$'  + revenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// ==========================================
// EXPORT FUNCTIONS
// ==========================================
function exportToCSV() {
    if (!currentWeek || !weeklyData[currentWeek]) return;
    
    const data = weeklyData[currentWeek];
    let csv = 'Label,Market Share %,Units,Streaming,Albums\n';
    
    Object.entries(data.marketShares)
        .sort((a, b) => b[1].percentage - a[1].percentage)
        .forEach(([label, info]) => {
            csv += `"${label}",${info.percentage.toFixed(2)},${info.value},${info.streaming || 0},${info.albums || 0}\n`;
        });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `market-share-${currentWeek.replace(/\//g, '-')}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function generatePDFReport() {
    window.print();
}

function downloadWeeklySummary() {
    const summaryEl = document.getElementById('weeklySummary');
    if (!summaryEl) return;
    
    const blob = new Blob([summaryEl.innerHTML], { type: 'text/html' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `weekly-report-${currentWeek.replace(/\//g, '-')}.html`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function emailWeeklySummary() {
    const subject = `Market Share Report - Week ${currentWeek}`;
    const body = generateExecutiveSummary();
    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

// ==========================================
// CONTEXT FUNCTIONS
// ==========================================
function switchContextMode(mode) {
    document.getElementById('individualContextMode').style.display = mode === 'individual' ? 'block' : 'none';
    document.getElementById('multipleContextMode').style.display = mode === 'multiple' ? 'block' : 'none';
}

function toggleWeekSelection() {
    const checkbox = document.getElementById('applyToSpecificWeeks');
    const container = document.getElementById('weekSelectionContainer');
    container.style.display = checkbox.checked ? 'block' : 'none';
    
    if (checkbox.checked) {
        updateWeekCheckboxList();
    }
}
	
	function toggleSettings() {
    const settingsSection = document.getElementById('settings-section');
    const toggleBtn = document.getElementById('settingsToggleBtn');
    
    if (settingsSection.style.display === 'none') {
        settingsSection.style.display = 'block';
        toggleBtn.textContent = 'Hide Settings';
        // Scroll to settings section
        settingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // ADD THESE LINES - Initialize settings UI if authenticated
        if (window.isSettingsAuthenticated) {
            updateContextWeekSelector();
            updateWeeksWithContextList();
            updateProjectionsList();
        }
    } else {
        settingsSection.style.display = 'none';
        toggleBtn.textContent = 'Settings & Projections';
    }
}

function updateWeekCheckboxList() {
    const container = document.getElementById('weekCheckboxList');
    if (!container || !weeklyData) return;
    
    const weeks = Object.keys(weeklyData).sort();
    container.innerHTML = weeks.map(week => `
        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" class="week-checkbox" value="${week}">
            <span>${week}</span>
        </label>
    `).join('');
}

function saveIndividualContext() {
    const week = document.getElementById('contextWeekSelect').value;
    const context = document.getElementById('individualWeekContext').value.trim();
    
    if (!week || !context) {
        alert('Please select a week and enter context');
        return;
    }
    
    weekContexts[week] = context;
    localStorage.setItem('weekContexts', JSON.stringify(weekContexts));
    
    updateWeeksWithContextList();
    document.getElementById('individualWeekContext').value = '';
    
    // Update summary if on current week
    if (week === currentWeek) {
        updateWeeklySummary();
    }
}

function clearIndividualContext() {
    document.getElementById('individualWeekContext').value = '';
}

function copyFromPreviousWeek() {
    const currentSelectedWeek = document.getElementById('contextWeekSelect').value;
    const weeks = Object.keys(weeklyData).sort();
    const currentIndex = weeks.indexOf(currentSelectedWeek);
    
    if (currentIndex > 0) {
        const prevWeek = weeks[currentIndex - 1];
        const prevContext = weekContexts[prevWeek];
        
        if (prevContext) {
            document.getElementById('individualWeekContext').value = prevContext;
        } else {
            alert('No context found for previous week');
        }
    }
}

function selectAllWeeks() {
    document.querySelectorAll('.week-checkbox').forEach(cb => cb.checked = true);
    updateSelectedWeekCount();
}

function deselectAllWeeks() {
    document.querySelectorAll('.week-checkbox').forEach(cb => cb.checked = false);
    updateSelectedWeekCount();
}

function selectRecentWeeks(count) {
    const checkboxes = Array.from(document.querySelectorAll('.week-checkbox'));
    checkboxes.forEach(cb => cb.checked = false);
    
    // Select last N weeks
    checkboxes.slice(-count).forEach(cb => cb.checked = true);
    updateSelectedWeekCount();
}

function updateSelectedWeekCount() {
    const count = document.querySelectorAll('.week-checkbox:checked').length;
    const countEl = document.getElementById('selectedWeekCount');
    if (countEl) {
        countEl.textContent = `(${count} selected)`;
    }
}

function saveAllContexts() {
    // Save individual contexts (already done via saveIndividualContext)
    
    // Save general context if in multiple mode
    const mode = document.querySelector('input[name="contextMode"]:checked').value;
    if (mode === 'multiple') {
        const context = document.getElementById('summaryContext').value.trim();
        const applyToSpecific = document.getElementById('applyToSpecificWeeks').checked;
        
        if (context) {
            if (applyToSpecific) {
                // Apply to selected weeks
                document.querySelectorAll('.week-checkbox:checked').forEach(cb => {
                    weekContexts[cb.value] = context;
                });
            } else {
                // Apply to all weeks
                appliedGeneralContext = context;
                localStorage.setItem('appliedGeneralContext', context);
            }
            
            localStorage.setItem('weekContexts', JSON.stringify(weekContexts));
        }
    }
    
    // Refresh current view
    updateAllViews();
    
    const statusEl = document.getElementById('dataStatus');
    const originalText = statusEl.innerHTML;
    statusEl.innerHTML = '✓ Contexts saved successfully';
    setTimeout(() => {
        statusEl.innerHTML = originalText;
    }, 3000);
}

function clearAllContexts() {
    if (confirm('Are you sure you want to clear all contexts?')) {
        weekContexts = {};
        appliedGeneralContext = null;
        localStorage.removeItem('weekContexts');
        localStorage.removeItem('appliedGeneralContext');
        
        updateWeeksWithContextList();
        document.getElementById('summaryContext').value = '';
        document.getElementById('individualWeekContext').value = '';
        
        updateAllViews();
    }
}

function removeWeekContext(week) {
    delete weekContexts[week];
    localStorage.setItem('weekContexts', JSON.stringify(weekContexts));
    updateWeeksWithContextList();
    
    if (week === currentWeek) {
        updateWeeklySummary();
    }
}

function addProjection() {
    const date = document.getElementById('projectionDate').value;
    const label = document.getElementById('projectionLabel').value;
    const units = parseFloat(document.getElementById('projectionUnits').value);
    
    if (!date || !label || !units) {
        alert('Please fill in all fields');
        return;
    }
    
    futureProjections.push({ date, label, units });
    localStorage.setItem('futureProjections', JSON.stringify(futureProjections));
    
    // Clear form
    document.getElementById('projectionDate').value = '';
    document.getElementById('projectionLabel').value = '';
    document.getElementById('projectionUnits').value = '';
    
    updateProjectionsList();
    
    // Update predictive chart if on analytics tab
    if (currentTab === 'analytics') {
        updatePredictiveChart();
    }
}

function removeProjection(index) {
    futureProjections.splice(index, 1);
    localStorage.setItem('futureProjections', JSON.stringify(futureProjections));
    updateProjectionsList();
    
    if (currentTab === 'analytics') {
        updatePredictiveChart();
    }
}

function saveProjections() {
    localStorage.setItem('futureProjections', JSON.stringify(futureProjections));
    
    if (currentTab === 'analytics') {
        updatePredictiveChart();
    }
    
    const statusEl = document.getElementById('dataStatus');
    const originalText = statusEl.innerHTML;
    statusEl.innerHTML = '✓ Projections saved';
    setTimeout(() => {
        statusEl.innerHTML = originalText;
    }, 3000);
}

function sortTable(column) {
    const table = document.getElementById('rankingTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Get current sort direction from table header
    const headers = table.querySelectorAll('th');
    const currentHeader = headers[column];
    let isAscending = !currentHeader.classList.contains('sorted-asc');
    
    // Clear all sort indicators
    headers.forEach(header => {
        header.classList.remove('sorted-asc', 'sorted-desc');
    });
    
    // Set current sort indicator
    currentHeader.classList.add(isAscending ? 'sorted-asc' : 'sorted-desc');
    
    // Sort rows based on column type
    rows.sort((a, b) => {
        const aValue = a.cells[column].textContent.trim();
        const bValue = b.cells[column].textContent.trim();
        
        let comparison = 0;
        
        // Handle different column types
        switch(column) {
            case 0: // Rank
            case 4: // Total YTD Units
            case 5: // Albums
            case 6: // Streams
            case 8: // Volatility
                // Numeric comparison
                const aNum = parseFloat(aValue.replace(/[^0-9.-]/g, '')) || 0;
                const bNum = parseFloat(bValue.replace(/[^0-9.-]/g, '')) || 0;
                comparison = aNum - bNum;
                break;
            case 2: // Market Share %
            case 7: // Growth Rate
                // Percentage comparison
                const aPercent = parseFloat(aValue.replace('%', '')) || 0;
                const bPercent = parseFloat(bValue.replace('%', '')) || 0;
                comparison = aPercent - bPercent;
                break;
            case 1: // Label (text)
            default:
                // Text comparison
                comparison = aValue.localeCompare(bValue);
                break;
        }
        
        return isAscending ? comparison : -comparison;
    });
    
    // Re-append sorted rows to tbody
    rows.forEach(row => tbody.appendChild(row));
}

// ==========================================
// INITIALIZATION
// ==========================================
function initializeDashboard() {
    if (window.isInitialized) {
        console.log('Already initialized, skipping...');
        return;
    }
    window.isInitialized = true;
    
    console.log('Initializing dashboard...');
    console.log('GOOGLE_APPS_SCRIPT_URL:', GOOGLE_APPS_SCRIPT_URL);
    
    try {
        // Ensure required elements exist
        ensureStatusElement();
        
        // Set up refresh button
        const refreshButton = document.getElementById('refreshButton');
        if (refreshButton) {
            refreshButton.onclick = () => fetchDataFromGoogleDrive(true);
        }
        
        // Check configuration
        if (!GOOGLE_APPS_SCRIPT_URL || GOOGLE_APPS_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT')) {
            const statusEl = document.getElementById('dataStatus');
            if (statusEl) {
                statusEl.innerHTML = '<span style="color: #f87171;">⚠️ Please configure the Google Apps Script URL</span>';
            }
            console.error('Google Apps Script URL not configured properly');
        } else {
            console.log('Starting data fetch...');
            // Start loading data
            fetchDataFromGoogleDrive();
            
            // Set up auto-refresh every 30 minutes
            setInterval(() => {
                if (document.visibilityState === 'visible') {
                    checkForUpdatesInBackground();
                }
            }, 30 * 60 * 1000);
            
            // Update last update time
            setInterval(() => {
                const timeEl = document.getElementById('lastUpdateTime');
                if (timeEl) {
                    timeEl.textContent = new Date().toLocaleTimeString();
                }
            }, 1000);
        }
    } catch (error) {
        console.error('Initialization error:', error);
    }
}

// ==========================================
// STARTUP
// ==========================================
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...');
        setTimeout(initializeDashboard, 100);
    });
} else {
    // DOM already loaded
    console.log('DOM already loaded, initializing...');
    setTimeout(initializeDashboard, 100);
}
	
	
	// Mobile drawer functions
function toggleMobileDrawer() {
    const drawer = document.querySelector('.mobile-drawer');
    const overlay = document.querySelector('.mobile-drawer-overlay');
    const hamburger = document.querySelector('.hamburger-menu');
    
    drawer.classList.toggle('active');
    overlay.classList.toggle('active');
    hamburger.classList.toggle('active');
}

function closeMobileDrawer() {
    const drawer = document.querySelector('.mobile-drawer');
    const overlay = document.querySelector('.mobile-drawer-overlay');
    const hamburger = document.querySelector('.hamburger-menu');
    
    drawer.classList.remove('active');
    overlay.classList.remove('active');
    hamburger.classList.remove('active');
}

function switchTabDrawer(tabName, element) {
    // Switch the tab
    switchTab(tabName, element);
    
    // Update active state in drawer
    document.querySelectorAll('.drawer-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    element.classList.add('active');
    
    // Close drawer
    closeMobileDrawer();
}
	
	
	// ==========================================
// CHARTS TAB FUNCTIONS - COMPLETE IMPLEMENTATION
// ==========================================

// Charts configuration
const CHARTS_GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzLEoouQy021rmgJ95kVudJz-t6oQybjDK-yn1zRd8J-eUnIFvPz2tnY2WU5dIFvxZvng/exec';
const CHARTS_CACHE_KEY = 'chartsDataCache';
const CHARTS_VERSION_KEY = 'chartsDataVersion';
const CHARTS_CACHE_EXPIRY_HOURS = 6;

// Charts data variables
let songsData = [];
let albumsData = [];
let currentSongFilter = 'all';
let currentAlbumFilter = 'all';

// ==========================================
// WEEK SELECTOR INTEGRATION
// ==========================================

// Connect charts to the global week selection system
function connectChartsToWeekSelector() {
    console.log('🔗 Connecting charts to global week selector');
    
    // Listen for week changes from the main dashboard
    const weekDropdown = document.getElementById('weekDropdown');
    if (weekDropdown) {
        // Store original change handler
        const originalHandler = weekDropdown.onchange;
        
        // Create new combined handler
        weekDropdown.onchange = function() {
            console.log('📅 Week changed to:', this.value);
            
            // Call original market share handler
            if (originalHandler) {
                originalHandler.call(this);
            } else if (typeof selectWeek === 'function') {
                selectWeek(this.value);
            }
            
            // Update charts for the new week
            updateChartsForWeek(this.value);
        };
    }
    
    // Also connect mobile dropdown if it exists
    const mobileDropdown = document.getElementById('mobileWeekDropdown');
    if (mobileDropdown) {
        const originalMobileHandler = mobileDropdown.onchange;
        
        mobileDropdown.onchange = function() {
            console.log('📱 Mobile week changed to:', this.value);
            
            // Call original handler
            if (originalMobileHandler) {
                originalMobileHandler.call(this);
            }
            
            // Update charts
            updateChartsForWeek(this.value);
        };
    }
}

// Update charts data for a specific week
async function updateChartsForWeek(selectedWeek) {
    console.log('📊 Updating charts for week:', selectedWeek);
    
    try {
        // Show loading state
        showChartsLoading();
        
        // Fetch charts data for the specific week
        const weekChartsData = await fetchChartsDataForWeek(selectedWeek);
        
        if (weekChartsData && (weekChartsData.songs.length > 0 || weekChartsData.albums.length > 0)) {
            // Update global charts data
            songsData = weekChartsData.songs;
            albumsData = weekChartsData.albums;
            
            console.log(`✅ Updated charts data: ${songsData.length} songs, ${albumsData.length} albums`);
            
            // Re-render current view
            renderCurrentChartsView();
            
            // Update week selectors in charts
            updateChartsWeekSelectors(selectedWeek);
            
        } else {
            console.log('⚠️ No charts data available for week:', selectedWeek);
            showNoChartsDataMessage(selectedWeek);
        }
        
    } catch (error) {
        console.error('❌ Error updating charts for week:', error);
        showChartsError();
    }
}

// Fetch charts data for a specific week
async function fetchChartsDataForWeek(week) {
    try {
        // If we're using Google Apps Script, request data for specific week
        if (CHARTS_GOOGLE_APPS_SCRIPT_URL && !CHARTS_GOOGLE_APPS_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT')) {
            const response = await fetch(`${CHARTS_GOOGLE_APPS_SCRIPT_URL}?action=getChartsData&week=${week}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const rawData = await response.json();
            
            if (rawData.error) {
                throw new Error(rawData.error);
            }
            
            // Process the week-specific data
            return processChartsDataFromGoogleDrive(rawData);
        } else {
            // Fallback: return current data (you might want to filter by week here)
            return { songs: songsData, albums: albumsData };
        }
        
    } catch (error) {
        console.error('Error fetching charts data for week:', error);
        throw error;
    }
}

// Update week selectors within charts to match global selection
function updateChartsWeekSelectors(selectedWeek) {
    const songsWeekSelector = document.getElementById('weekSelectorSongs');
    const albumsWeekSelector = document.getElementById('weekSelectorAlbums');
    
    if (songsWeekSelector) {
        // Update the display text to show selected week
        const weekNumber = extractWeekNumber(selectedWeek);
        songsWeekSelector.innerHTML = `<option value="${selectedWeek}">Week ${weekNumber}</option>`;
    }
    
    if (albumsWeekSelector) {
        const weekNumber = extractWeekNumber(selectedWeek);
        albumsWeekSelector.innerHTML = `<option value="${selectedWeek}">Week ${weekNumber}</option>`;
    }
}

// Extract week number from date string
function extractWeekNumber(weekString) {
    // This depends on your date format - adjust as needed
    // Example: if weekString is "04/10/2025", extract week number
    // You might need to implement logic based on your specific format
    
    if (typeof weekString === 'string' && weekString.includes('/')) {
        // Simple extraction - you may need to adjust this
        const parts = weekString.split('/');
        const month = parseInt(parts[0]);
        const day = parseInt(parts[1]);
        
        // Calculate approximate week number (this is a simplified approach)
        const weekNumber = Math.ceil((month * 4) + (day / 7));
        return weekNumber;
    }
    
    return 'Current';
}

// Show loading state for charts
function showChartsLoading() {
    const containers = ['songsChartContainer', 'albumsChartContainer'];
    
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '<div class="loading-message">Loading charts data for selected week...</div>';
        }
    });
    
    // Also update insights
    const overviewElements = document.querySelectorAll('.charts-overview p');
    overviewElements.forEach(element => {
        element.textContent = 'Loading chart insights for selected week...';
    });
}

// Show message when no charts data is available
function showNoChartsDataMessage(week) {
    const containers = ['songsChartContainer', 'albumsChartContainer'];
    
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `<div class="no-data">No charts data available for ${week}. Please select a different week.</div>`;
        }
    });
    
    // Update insights
    const overviewElements = document.querySelectorAll('.charts-overview p');
    overviewElements.forEach(element => {
        element.textContent = `Charts data is not available for the selected week (${week}). Please choose a different week from the dropdown.`;
    });
}

// Show error message
function showChartsError() {
    const containers = ['songsChartContainer', 'albumsChartContainer'];
    
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '<div class="loading-message">Error loading charts data. Please try again.</div>';
        }
    });
}

// Initialize the connection when charts tab is loaded
function initializeChartsWeekIntegration() {
    console.log('🔄 Initializing charts week integration');
    
    // Connect to the week selector
    connectChartsToWeekSelector();
    
    // If there's already a selected week, update charts to match
    const currentWeekSelector = document.getElementById('weekDropdown');
    if (currentWeekSelector && currentWeekSelector.value) {
        const selectedWeek = currentWeekSelector.value;
        console.log('📅 Syncing charts to current week:', selectedWeek);
        updateChartsForWeek(selectedWeek);
    }
}

// Update the main updateChartsTab function to include week integration
function updateChartsTab() {
    console.log('🎵 Updating charts tab...');
    
    // Initialize week integration
    initializeChartsWeekIntegration();
    
    if (!songsData.length && !albumsData.length) {
        if (CHARTS_GOOGLE_APPS_SCRIPT_URL && !CHARTS_GOOGLE_APPS_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT')) {
            fetchChartsDataFromGoogleDrive()
                .then(() => {
                    console.log(`✅ Loaded ${songsData.length} songs and ${albumsData.length} albums from Google Drive`);
                    renderCurrentChartsView();
                    updateChartInsights();
                })
                .catch(error => {
                    console.error('❌ Failed to load from Google Drive:', error);
                    initializeSampleChartsData();
                    renderCurrentChartsView();
                    updateChartInsights();
                });
        } else {
            initializeSampleChartsData();
            renderCurrentChartsView();
            updateChartInsights();
        }
    } else {
        renderCurrentChartsView();
        updateChartInsights();
    }
}

function renderChartsContent() {
    updateAnalyticsCards();
    renderSongsChart();
    renderAlbumsChart();
    updateSummaryText();
}

async function fetchChartsDataFromGoogleDrive() {
    try {
        const cachedData = getChartsCache();
        if (cachedData) {
            songsData = cachedData.songs;
            albumsData = cachedData.albums;
            return;
        }
        
        const response = await fetch(`${CHARTS_GOOGLE_APPS_SCRIPT_URL}?action=getChartsData`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const rawData = await response.json();
        if (rawData.error) throw new Error(rawData.error);
        
        const processedData = processChartsDataFromGoogleDrive(rawData);
        songsData = processedData.songs;
        albumsData = processedData.albums;
        
        setChartsCache(processedData);
    } catch (error) {
        console.error('Error fetching charts data:', error);
        throw error;
    }
}

// ==========================================
// UPDATED CHARTS CSV PROCESSING FOR NEW FORMAT
// ==========================================

function processChartsDataFromGoogleDrive(rawData) {
    console.log('🔄 Processing charts data from new CSV format...');
    
    // Process songs data with new format
    const songs = processNewFormatSongs(rawData.songs);
    
    // Process albums data with new format  
    const albums = processNewFormatAlbums(rawData.albums);
    
    console.log(`✅ Processed ${songs.length} songs and ${albums.length} albums from new format`);
    
    return { songs, albums };
}

// Process songs data with new two-row header format
function processNewFormatSongs(songsArray) {
    if (!songsArray || songsArray.length === 0) {
        console.log('⚠️ No songs data to process');
        return [];
    }
    
    console.log('🎵 Processing', songsArray.length, 'songs from Google Apps Script');
    
    const songs = songsArray.map((song, index) => {
        // Handle the data structure from Google Apps Script
        const item = {
            rank: parseInt(song.thisWeekRank) || index + 1,
            artist: song.artist || 'Unknown Artist',
            title: song.title || 'Unknown Title',
            label: mapLabelName(song.label),
            streams: parseInt(song.streams) || 0,
            lastWeek: parseInt(song.lastWeekRank) || 0,
            twoWeeksAgo: parseInt(song.twoWeekRank) || 0,
            percentChange: parseFloat(song.percentChange) || 0,
            weeksOnChart: parseInt(song.weeksOn) || 1,
            rtdStreams: parseInt(song.rtdStreams) || 0,
            movement: calculateMovement(parseInt(song.thisWeekRank), parseInt(song.lastWeekRank)),
            isNew: !song.lastWeekRank || parseInt(song.lastWeekRank) === 0
        };
        
        return item;
    }).filter(song => song.rank > 0 && song.artist !== 'Unknown Artist')
      .sort((a, b) => a.rank - b.rank);
    
    console.log('✅ Processed', songs.length, 'valid songs');
    return songs;
}

// Process albums data with new two-row header format
function processNewFormatAlbums(albumsArray) {
    if (!albumsArray || albumsArray.length === 0) {
        console.log('⚠️ No albums data to process');
        return [];
    }
    
    console.log('💿 Processing', albumsArray.length, 'albums from Google Apps Script');
    
    const albums = albumsArray.map((album, index) => {
        const item = {
            rank: parseInt(album.thisWeekRank) || index + 1,
            artist: album.artist || 'Unknown Artist',
            title: album.title || 'Unknown Title',
            label: mapLabelName(album.label),
            sales: parseInt(album.activity) || 0,
            streams: parseInt(album.streams) || 0,
            lastWeek: parseInt(album.lastWeekRank) || 0,
            peakPosition: parseInt(album.peakRank) || index + 1,
            percentChange: parseFloat(album.percentChange) || 0,
            weeksOnChart: parseInt(album.weeksOn) || 1,
            albumSales: parseInt(album.albumSales) || 0,
            totalStreams: parseInt(album.totalStreams) || 0,
            movement: calculateMovement(parseInt(album.thisWeekRank), parseInt(album.lastWeekRank)),
            isNew: !album.lastWeekRank || parseInt(album.lastWeekRank) === 0
        };
        
        return item;
    }).filter(album => album.rank > 0 && album.artist !== 'Unknown Artist')
      .sort((a, b) => a.rank - b.rank);
    
    console.log('✅ Processed', albums.length, 'valid albums');
    return albums;
}
	
	
	// Force refresh charts data from Google Drive
async function forceRefreshChartsData() {
    console.log('🔄 Force refreshing charts data from Google Drive...');
    
    // Clear cache first
    localStorage.removeItem(CHARTS_CACHE_KEY);
    localStorage.removeItem(CHARTS_VERSION_KEY);
    
    try {
        showChartsLoading();
        
        // Add timestamp to prevent caching
        const timestamp = new Date().getTime();
        const response = await fetch(`${CHARTS_GOOGLE_APPS_SCRIPT_URL}?action=getChartsData&_t=${timestamp}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const rawData = await response.json();
        console.log('📥 Fresh data received:', rawData);
        
        if (rawData.error) {
            throw new Error(rawData.error);
        }
        
        // Process the fresh data
        const processedData = processChartsDataFromGoogleDrive(rawData);
        songsData = processedData.songs;
        albumsData = processedData.albums;
        
        // Cache the new data
        setChartsCache(processedData);
        
        console.log(`✅ Force refreshed: ${songsData.length} songs, ${albumsData.length} albums`);
        
        // Re-render everything
        renderCurrentChartsView();
        updateChartInsights();
        
        return processedData;
        
    } catch (error) {
        console.error('❌ Error force refreshing charts data:', error);
        showChartsError();
        throw error;
    }
}

// Update the main updateChartsTab function to include force refresh option
function updateChartsTab(forceRefresh = false) {
    console.log('🎵 Updating charts tab... Force refresh:', forceRefresh);
    
    if (forceRefresh || (!songsData.length && !albumsData.length)) {
        updateLoadingInsights();
        
        if (CHARTS_GOOGLE_APPS_SCRIPT_URL && !CHARTS_GOOGLE_APPS_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT')) {
            const fetchFunction = forceRefresh ? forceRefreshChartsData : fetchChartsDataFromGoogleDrive;
            
            fetchFunction()
                .then(() => {
                    console.log(`✅ Loaded ${songsData.length} songs and ${albumsData.length} albums from Google Drive`);
                    renderCurrentChartsView();
                    updateChartInsights();
                })
                .catch(error => {
                    console.error('❌ Failed to load from Google Drive:', error);
                    initializeSampleChartsData();
                    renderCurrentChartsView();
                    updateChartInsights();
                });
        } else {
            initializeSampleChartsData();
            renderCurrentChartsView();
            updateChartInsights();
        }
    } else {
        renderCurrentChartsView();
        updateChartInsights();
    }
}

function mapLabelName(originalLabel) {
    const labelMappings = {
        'PROV': 'Provident',
        'Provident': 'Provident',
        'CCMG': 'CCMG',
        '10KP': 'CCMG',
        'ADA': 'ADA',
        'ORCHARD': 'THE ORCHARD',
        'THE ORCHARD': 'THE ORCHARD',
        'INDI': 'Independent',
        'TRBL': 'Tribl',
        'COL': 'Columbia',
        'DEF': 'Def Jam',
        '12CM': 'CCMG'
    };
    return labelMappings[originalLabel] || originalLabel || 'Independent';
}

function calculateMovement(currentRank, lastWeekRank) {
    if (!lastWeekRank || lastWeekRank === 0) return 'new';
    if (currentRank < lastWeekRank) return 'up';
    if (currentRank > lastWeekRank) return 'down';
    return 'same';
}

function initializeSampleChartsData() {
    // No sample data - charts will show empty state until real data loads
    songsData = [];
    albumsData = [];
    
    // Show loading message in charts
    const songsContainer = document.getElementById('songsChartContainer');
    const albumsContainer = document.getElementById('albumsChartContainer');
    
    if (songsContainer) {
        songsContainer.innerHTML = '<div class="loading-message">Loading songs data from Google Drive...</div>';
    }
    
    if (albumsContainer) {
        albumsContainer.innerHTML = '<div class="loading-message">Loading albums data from Google Drive...</div>';
    }
}

function updateAnalyticsCards() {
    updateTop5Card();
    updateBiggestMoversCard();
    updateNewEntriesCard();
}

function updateTop5Card() {
    const songsContent = document.getElementById('top5-songs');
    const albumsContent = document.getElementById('top5-albums');
    
    if (songsContent) {
        if (songsData.length > 0) {
            songsContent.innerHTML = songsData.slice(0, 5).map(song => 
                `<div class="analytics-item">
                    <span class="rank-badge">${song.rank}</span>
                    <div class="item-info">
                        <div class="item-title">${song.title}</div>
                        <div class="item-artist">${song.artist}</div>
                    </div>
                    <div class="item-stats">${formatNumber(song.streams)}</div>
                </div>`
            ).join('');
        } else {
            songsContent.innerHTML = '<div class="no-data">Loading songs data...</div>';
        }
    }
    
    if (albumsContent) {
        if (albumsData.length > 0) {
            albumsContent.innerHTML = albumsData.slice(0, 5).map(album => 
                `<div class="analytics-item">
                    <span class="rank-badge">${album.rank}</span>
                    <div class="item-info">
                        <div class="item-title">${album.title}</div>
                        <div class="item-artist">${album.artist}</div>
                    </div>
                    <div class="item-stats">${formatNumber(album.sales)}</div>
                </div>`
            ).join('');
        } else {
            albumsContent.innerHTML = '<div class="no-data">Loading albums data...</div>';
        }
    }
}

function updateBiggestMoversCard() {
    const songsContent = document.getElementById('movers-songs');
    const albumsContent = document.getElementById('movers-albums');
    
    if (songsContent) {
        if (songsData.length > 0) {
            const songMovers = songsData.filter(song => song.movement === 'up' || song.movement === 'down')
                .sort((a, b) => Math.abs(b.lastWeek - b.rank) - Math.abs(a.lastWeek - a.rank))
                .slice(0, 5);
            
            if (songMovers.length > 0) {
                songsContent.innerHTML = songMovers.map(song => {
                    const change = song.lastWeek - song.rank;
                    const changeText = change > 0 ? `+${change}` : change.toString();
                    const changeColor = change > 0 ? '#4ade80' : '#f87171';
                    
                    return `<div class="analytics-item">
                        <span class="rank-badge">${song.rank}</span>
                        <div class="item-info">
                            <div class="item-title">${song.title}</div>
                            <div class="item-artist">${song.artist}</div>
                        </div>
                        <div class="item-stats" style="color: ${changeColor}">${changeText}</div>
                    </div>`;
                }).join('');
            } else {
                songsContent.innerHTML = '<div class="no-data">No movement data available</div>';
            }
        } else {
            songsContent.innerHTML = '<div class="no-data">Loading songs data...</div>';
        }
    }
    
    if (albumsContent) {
        if (albumsData.length > 0) {
            const albumMovers = albumsData.filter(album => album.movement === 'up' || album.movement === 'down')
                .sort((a, b) => Math.abs(b.lastWeek - b.rank) - Math.abs(a.lastWeek - a.rank))
                .slice(0, 5);
            
            if (albumMovers.length > 0) {
                albumsContent.innerHTML = albumMovers.map(album => {
                    const change = album.lastWeek - album.rank;
                    const changeText = change > 0 ? `+${change}` : change.toString();
                    const changeColor = change > 0 ? '#4ade80' : '#f87171';
                    
                    return `<div class="analytics-item">
                        <span class="rank-badge">${album.rank}</span>
                        <div class="item-info">
                            <div class="item-title">${album.title}</div>
                            <div class="item-artist">${album.artist}</div>
                        </div>
                        <div class="item-stats" style="color: ${changeColor}">${changeText}</div>
                    </div>`;
                }).join('');
            } else {
                albumsContent.innerHTML = '<div class="no-data">No movement data available</div>';
            }
        } else {
            albumsContent.innerHTML = '<div class="no-data">Loading albums data...</div>';
        }
    }
}

function updateNewEntriesCard() {
    const songsContent = document.getElementById('new-songs');
    const albumsContent = document.getElementById('new-albums');
    
    if (songsContent) {
        if (songsData.length > 0) {
            const newSongs = songsData.filter(song => song.isNew).slice(0, 5);
            songsContent.innerHTML = newSongs.length > 0 ? newSongs.map(song => 
                `<div class="analytics-item">
                    <span class="rank-badge">${song.rank}</span>
                    <div class="item-info">
                        <div class="item-title">${song.title}</div>
                        <div class="item-artist">${song.artist}</div>
                    </div>
                    <div class="item-stats new-badge">NEW</div>
                </div>`
            ).join('') : '<div class="no-data">No new entries this week</div>';
        } else {
            songsContent.innerHTML = '<div class="no-data">Loading songs data...</div>';
        }
    }
    
    if (albumsContent) {
        if (albumsData.length > 0) {
            const newAlbums = albumsData.filter(album => album.isNew).slice(0, 5);
            albumsContent.innerHTML = newAlbums.length > 0 ? newAlbums.map(album => 
                `<div class="analytics-item">
                    <span class="rank-badge">${album.rank}</span>
                    <div class="item-info">
                        <div class="item-title">${album.title}</div>
                        <div class="item-artist">${album.artist}</div>
                    </div>
                    <div class="item-stats new-badge">NEW</div>
                </div>`
            ).join('') : '<div class="no-data">No new entries this week</div>';
        } else {
            albumsContent.innerHTML = '<div class="no-data">Loading albums data...</div>';
        }
    }
}

function renderSongsChart() {
    const container = document.getElementById('songsChartContainer');
    if (!container) return;
    
    if (songsData.length === 0) {
        container.innerHTML = '<div class="loading-message">No songs data available. Check Google Drive connection.</div>';
        return;
    }
    
    let filteredSongs = [...songsData];
    
    switch (currentSongFilter) {
        case 'fresh':
            filteredSongs = songsData.filter(song => song.weeksOnChart <= 52);
            break;
        case 'new':
            filteredSongs = songsData.filter(song => song.isNew);
            break;
        case 'increases':
            filteredSongs = songsData.filter(song => song.movement === 'up' || song.percentChange > 0);
            break;
        case 'decreases':
            filteredSongs = songsData.filter(song => song.movement === 'down' || song.percentChange < 0);
            break;
    }
    
    if (filteredSongs.length === 0) {
        container.innerHTML = '<div class="no-data">No songs match the current filter</div>';
        return;
    }
    
    // REMOVED: .slice(0, 50) - now shows ALL songs
    container.innerHTML = filteredSongs.map(song => {
        const changeIndicator = getChangeIndicator(song.movement, song.lastWeek, song.rank);
        const labelColor = getLabelColor(song.label);
        
        return `
            <div class="chart-item">
                <div class="item-left">
                    <div class="rank-display">${song.rank}</div>
                    <div class="artwork-placeholder">♪</div>
                    <div class="track-info">
                        <div class="track-title">${song.title}</div>
                        <div class="track-artist">${song.artist}</div>
                        <div class="track-label" style="color: ${labelColor}">${song.label}</div>
                    </div>
                </div>
                <div class="item-right">
                    <div class="stats-row">
                        <span class="stat-item">
                            <span class="stat-label">STREAMS</span>
                            <span class="stat-value">${formatNumber(song.streams)}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">LAST WEEK</span>
                            <span class="stat-value">${song.lastWeek || '-'}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">% CHG</span>
                            <span class="stat-value">${song.percentChange > 0 ? '+' : ''}${song.percentChange}%</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">WEEKS</span>
                            <span class="stat-value">${song.weeksOnChart}</span>
                        </span>
                    </div>
                    ${changeIndicator}
                </div>
            </div>
        `;
    }).join('');
}

function renderAlbumsChart() {
    const container = document.getElementById('albumsChartContainer');
    if (!container) return;
    
    if (albumsData.length === 0) {
        container.innerHTML = '<div class="loading-message">No albums data available. Check Google Drive connection.</div>';
        return;
    }
    
    let filteredAlbums = [...albumsData];
    
    switch (currentAlbumFilter) {
        case 'new':
            filteredAlbums = albumsData.filter(album => album.isNew);
            break;
        case 'increases':
            filteredAlbums = albumsData.filter(album => album.movement === 'up' || album.percentChange > 0);
            break;
        case 'decreases':
            filteredAlbums = albumsData.filter(album => album.movement === 'down' || album.percentChange < 0);
            break;
    }
    
    if (filteredAlbums.length === 0) {
        container.innerHTML = '<div class="no-data">No albums match the current filter</div>';
        return;
    }
    
    // REMOVED: .slice(0, 25) - now shows ALL albums
    container.innerHTML = filteredAlbums.map(album => {
        const changeIndicator = getChangeIndicator(album.movement, album.lastWeek, album.rank);
        const labelColor = getLabelColor(album.label);
        
        return `
            <div class="chart-item">
                <div class="item-left">
                    <div class="rank-display">${album.rank}</div>
                    <div class="artwork-placeholder">♫</div>
                    <div class="track-info">
                        <div class="track-title">${album.title}</div>
                        <div class="track-artist">${album.artist}</div>
                        <div class="track-label" style="color: ${labelColor}">${album.label}</div>
                    </div>
                </div>
                <div class="item-right">
                    <div class="stats-row">
                        <span class="stat-item">
                            <span class="stat-label">TA</span>
                            <span class="stat-value">${formatNumber(album.sales)}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">STREAMS</span>
                            <span class="stat-value">${formatNumber(album.streams)}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">PEAK</span>
                            <span class="stat-value">${album.peakPosition}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">LAST WEEK</span>
                            <span class="stat-value">${album.lastWeek || '-'}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">% CHG</span>
                            <span class="stat-value">${album.percentChange > 0 ? '+' : ''}${album.percentChange}%</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">WEEKS</span>
                            <span class="stat-value">${album.weeksOnChart}</span>
                        </span>
                    </div>
                    ${changeIndicator}
                </div>
            </div>
        `;
    }).join('');
}

function getChangeIndicator(movement, lastWeek, currentRank) {
    switch (movement) {
        case 'new':
            return '<span class="change-indicator new">NEW</span>';
        case 'up':
            const upChange = lastWeek - currentRank;
            return `<span class="change-indicator up">+${upChange}</span>`;
        case 'down':
            const downChange = currentRank - lastWeek;
            return `<span class="change-indicator down">-${downChange}</span>`;
        case 'same':
            return '<span class="change-indicator same">—</span>';
        default:
            return '<span class="change-indicator same">—</span>';
    }
}

// ==========================================
// FIXED SUMMARY TEXT AND INSIGHTS LOADING
// ==========================================

// Update the main updateChartsTab function to properly load insights
function updateChartsTab() {
    console.log('🎵 Updating charts tab...');
    
    if (!songsData.length && !albumsData.length) {
        // Show loading message first
        updateLoadingInsights();
        
        if (CHARTS_GOOGLE_APPS_SCRIPT_URL && !CHARTS_GOOGLE_APPS_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT')) {
            fetchChartsDataFromGoogleDrive()
                .then(() => {
                    console.log(`✅ Loaded ${songsData.length} songs and ${albumsData.length} albums from Google Drive`);
                    renderCurrentChartsView();
                    updateChartInsights(); // Add this line
                })
                .catch(error => {
                    console.error('❌ Failed to load from Google Drive:', error);
                    initializeSampleChartsData();
                    renderCurrentChartsView();
                    updateChartInsights(); // Add this line
                });
        } else {
            initializeSampleChartsData();
            renderCurrentChartsView();
            updateChartInsights(); // Add this line
        }
    } else {
        renderCurrentChartsView();
        updateChartInsights(); // Add this line
    }
}

// Show loading message for insights
function updateLoadingInsights() {
    const overviewElements = document.querySelectorAll('.charts-overview p');
    overviewElements.forEach(element => {
        element.textContent = 'Loading chart data to generate insights...';
    });
}

// Updated updateChartInsights function with better error handling

      function updateChartInsights() {
    console.log('🔍 Updating chart insights for view:', currentChartsView);
    
    let insights = '';
    let targetElementId = '';
    
    try {
        switch (currentChartsView) {
            case 'summary':
                insights = generateSummaryInsights();
                targetElementId = 'chartSummaryView';
                console.log('📊 Generated summary insights');
                break;
            case 'songs':
                insights = generateSongsInsights();
                targetElementId = 'songsChartView';
                console.log('🎵 Generated songs insights');
                break;
            case 'albums':
                insights = generateAlbumsInsights();
                targetElementId = 'albumsChartView';
                console.log('💿 Generated albums insights');
                break;
            default:
                insights = generateSummaryInsights();
                targetElementId = 'chartSummaryView';
                console.log('📊 Generated default summary insights');
        }
        
        console.log('✅ Insights generated:', insights.substring(0, 100) + '...');
        console.log('🎯 Targeting element:', targetElementId);
        
        // Target the specific view's overview element
        const targetView = document.getElementById(targetElementId);
        if (targetView) {
            const overviewElement = targetView.querySelector('.charts-overview p');
            if (overviewElement) {
                overviewElement.textContent = insights;
                console.log('📝 Updated target overview element successfully');
            } else {
                console.log('❌ No overview paragraph found in target view');
            }
        } else {
            console.log('❌ Target view not found:', targetElementId);
        }
        
    } catch (error) {
        console.error('❌ Error updating insights:', error);
    }
}

// Simplified and more reliable summary text update
function updateSummaryText() {
    console.log('📊 Updating summary text...');
    updateChartInsights();
}

// Updated renderCurrentChartsView with better timing
function renderCurrentChartsView() {
    console.log('🎨 Rendering current charts view:', currentChartsView);
    
    switch(currentChartsView) {
        case 'summary':
            updateAnalyticsCards();
            console.log('✅ Updated analytics cards');
            break;
        case 'songs':
            renderSongsChart();
            console.log('✅ Rendered songs chart');
            break;
        case 'albums':
            renderAlbumsChart();
            console.log('✅ Rendered albums chart');
            break;
        default:
            updateAnalyticsCards();
            console.log('✅ Updated default analytics cards');
    }
    
    // Update insights immediately after rendering
    setTimeout(() => {
        updateChartInsights();
    }, 100);
    
    // Load Spotify artwork after insights
    if (songsData.length > 0 || albumsData.length > 0) {
        setTimeout(() => {
            if (typeof loadSpotifyArtwork === 'function') {
                loadSpotifyArtwork();
            }
        }, 1000);
    }
}

// Updated switchChartsView with better insight timing
function switchChartsView(viewName, element) {
    console.log('🔄 Switching to charts view:', viewName);
    currentChartsView = viewName;
    
    // Update active nav button
    document.querySelectorAll('.charts-nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    if (element) {
        element.classList.add('active');
    }
    
    // Hide all chart views
    document.querySelectorAll('.chart-view').forEach(view => {
        view.classList.remove('active');
    });
    
    // Show selected view
    const selectedView = document.getElementById(viewName === 'summary' ? 'chartSummaryView' : viewName + 'ChartView');
    if (selectedView) {
        selectedView.classList.add('active');
        console.log('✅ Activated view:', selectedView.id);
    }
    
    // Update content based on view
    switch(viewName) {
        case 'summary':
            updateAnalyticsCards();
            break;
        case 'songs':
            renderSongsChart();
            break;
        case 'albums':
            renderAlbumsChart();
            break;
    }
    
    // Update insights after view switch
    setTimeout(() => {
        updateChartInsights();
    }, 200);
}

// Enhanced generateSummaryInsights with better error handling
function generateSummaryInsights() {
    console.log('📝 Generating summary insights...');
    console.log('📊 Songs data length:', songsData.length);
    console.log('💿 Albums data length:', albumsData.length);
    
    if (songsData.length === 0 && albumsData.length === 0) {
        return "Loading chart data from Google Drive to generate comprehensive insights...";
    }
    
    try {
        const insights = [];
        
        // Overall chart activity
        const totalSongs = songsData.length;
        const totalAlbums = albumsData.length;
        insights.push(`This week's comprehensive analysis covers ${totalSongs} songs and ${totalAlbums} albums across the Christian music charts.`);
        
        // New entries analysis
        const newSongs = songsData.filter(s => s.isNew).length;
        const newAlbums = albumsData.filter(a => a.isNew).length;
        if (newSongs > 0 || newAlbums > 0) {
            insights.push(`Chart freshness is notable with ${newSongs} new song entries and ${newAlbums} new album debuts this week.`);
        }
        
        // Movement analysis
        const songsMovingUp = songsData.filter(s => s.movement === 'up').length;
        const songsMovingDown = songsData.filter(s => s.movement === 'down').length;
        
        if (songsMovingUp > songsMovingDown) {
            insights.push(`Market momentum is positive with ${songsMovingUp} songs gaining positions versus ${songsMovingDown} declining.`);
        } else if (songsMovingDown > songsMovingUp) {
            insights.push(`Chart dynamics show ${songsMovingDown} songs losing ground while ${songsMovingUp} are climbing.`);
        } else {
            insights.push(`Chart stability is evident with balanced movement between rising and falling tracks.`);
        }
        
        // Top performer analysis
        if (songsData.length > 0) {
            const topSong = songsData[0];
            const topSongStatus = topSong.lastWeek > 0 ? 
                (topSong.movement === 'up' ? `climbing from #${topSong.lastWeek}` : 
                 topSong.movement === 'down' ? `dropping from #${topSong.lastWeek}` : 
                 `holding steady from #${topSong.lastWeek}`) : 
                'making its chart debut';
            insights.push(`"${topSong.title}" by ${topSong.artist} commands the songs chart at #1, ${topSongStatus}.`);
        }
        
        if (albumsData.length > 0) {
            const topAlbum = albumsData[0];
            const topAlbumStatus = topAlbum.lastWeek > 0 ? 
                (topAlbum.movement === 'up' ? `rising from #${topAlbum.lastWeek}` : 
                 topAlbum.movement === 'down' ? `falling from #${topAlbum.lastWeek}` : 
                 `maintaining its #${topAlbum.lastWeek} position`) : 
                'debuting at the top';
            insights.push(`"${topAlbum.title}" by ${topAlbum.artist} leads the albums chart, ${topAlbumStatus}.`);
        }
        
        // Streaming and sales performance
        if (songsData.length > 0) {
            const totalStreams = songsData.reduce((sum, song) => sum + (song.streams || 0), 0);
            const millionStreamers = songsData.filter(s => s.streams >= 1000000).length;
            if (millionStreamers > 0) {
                insights.push(`Streaming strength is demonstrated by ${millionStreamers} tracks surpassing one million weekly streams.`);
            }
        }
        
        const result = insights.join(' ');
        console.log('✅ Summary insights generated successfully');
        return result;
        
    } catch (error) {
        console.error('❌ Error generating summary insights:', error);
        return "Chart data is being processed. Comprehensive insights will be available momentarily.";
    }
}

// Updated filter functions to trigger insights update
function filterSongs(filterType) {
    console.log('🔍 Filtering songs:', filterType);
    currentSongFilter = filterType;
    renderSongsChart();
    setTimeout(() => {
        updateChartInsights();
    }, 150);
}

function filterAlbums(filterType) {
    console.log('🔍 Filtering albums:', filterType);
    currentAlbumFilter = filterType;
    renderAlbumsChart();
    setTimeout(() => {
        updateChartInsights();
    }, 150);
}

function toggleAnalytics(cardType, contentType) {
    const card = document.querySelector(`#${cardType}-songs`).closest('.analytics-card');
    const buttons = card.querySelectorAll('.toggle-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    const songsContent = document.getElementById(`${cardType}-songs`);
    const albumsContent = document.getElementById(`${cardType}-albums`);
    
    if (contentType === 'songs') {
        songsContent.style.display = 'block';
        albumsContent.style.display = 'none';
    } else {
        songsContent.style.display = 'none';
        albumsContent.style.display = 'block';
    }
}

function filterSongs(filterType) {
    currentSongFilter = filterType;
    renderSongsChart();
}

function filterAlbums(filterType) {
    currentAlbumFilter = filterType;
    renderAlbumsChart();
}

// Cache management functions
function getChartsCache() {
    try {
        const cached = localStorage.getItem(CHARTS_CACHE_KEY);
        if (!cached) return null;
        
        const data = JSON.parse(cached);
        const cacheTime = new Date(data.timestamp);
        const now = new Date();
        const hoursDiff = (now - cacheTime) / (1000 * 60 * 60);
        
        if (hoursDiff > CHARTS_CACHE_EXPIRY_HOURS) {
            localStorage.removeItem(CHARTS_CACHE_KEY);
            return null;
        }
        
        return data.charts;
    } catch (error) {
        console.error('Error reading charts cache:', error);
        return null;
    }
}

function setChartsCache(data) {
    try {
        const cacheData = {
            charts: data,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(CHARTS_CACHE_KEY, JSON.stringify(cacheData));
    } catch (error) {
        console.error('Error setting charts cache:', error);
    }
}
	
	
	// ==========================================
// WEEK SELECTOR INTEGRATION
// ==========================================

// Connect charts to the global week selection system
function connectChartsToWeekSelector() {
    console.log('🔗 Connecting charts to global week selector');
    
    // Listen for week changes from the main dashboard
    const weekDropdown = document.getElementById('weekDropdown');
    if (weekDropdown) {
        // Store original change handler
        const originalHandler = weekDropdown.onchange;
        
        // Create new combined handler
        weekDropdown.onchange = function() {
            console.log('📅 Week changed to:', this.value);
            
            // Call original market share handler
            if (originalHandler) {
                originalHandler.call(this);
            } else if (typeof selectWeek === 'function') {
                selectWeek(this.value);
            }
            
            // Update charts for the new week
            updateChartsForWeek(this.value);
        };
    }
    
    // Also connect mobile dropdown if it exists
    const mobileDropdown = document.getElementById('mobileWeekDropdown');
    if (mobileDropdown) {
        const originalMobileHandler = mobileDropdown.onchange;
        
        mobileDropdown.onchange = function() {
            console.log('📱 Mobile week changed to:', this.value);
            
            // Call original handler
            if (originalMobileHandler) {
                originalMobileHandler.call(this);
            }
            
            // Update charts
            updateChartsForWeek(this.value);
        };
    }
}

// Update charts data for a specific week
async function updateChartsForWeek(selectedWeek) {
    console.log('📊 Updating charts for week:', selectedWeek);
    
    try {
        // Show loading state
        showChartsLoading();
        
        // Fetch charts data for the specific week
        const weekChartsData = await fetchChartsDataForWeek(selectedWeek);
        
        if (weekChartsData && (weekChartsData.songs.length > 0 || weekChartsData.albums.length > 0)) {
            // Update global charts data
            songsData = weekChartsData.songs;
            albumsData = weekChartsData.albums;
            
            console.log(`✅ Updated charts data: ${songsData.length} songs, ${albumsData.length} albums`);
            
            // Re-render current view
            renderCurrentChartsView();
            
            // Update week selectors in charts
            updateChartsWeekSelectors(selectedWeek);
            
        } else {
            console.log('⚠️ No charts data available for week:', selectedWeek);
            showNoChartsDataMessage(selectedWeek);
        }
        
    } catch (error) {
        console.error('❌ Error updating charts for week:', error);
        showChartsError();
    }
}

// Fetch charts data for a specific week
async function fetchChartsDataForWeek(week) {
    try {
        // If we're using Google Apps Script, request data for specific week
        if (CHARTS_GOOGLE_APPS_SCRIPT_URL && !CHARTS_GOOGLE_APPS_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT')) {
            const response = await fetch(`${CHARTS_GOOGLE_APPS_SCRIPT_URL}?action=getChartsData&week=${week}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const rawData = await response.json();
            
            if (rawData.error) {
                throw new Error(rawData.error);
            }
            
            // Process the week-specific data
            return processChartsDataFromGoogleDrive(rawData);
        } else {
            // Fallback: return current data (you might want to filter by week here)
            return { songs: songsData, albums: albumsData };
        }
        
    } catch (error) {
        console.error('Error fetching charts data for week:', error);
        throw error;
    }
}

// Update week selectors within charts to match global selection
function updateChartsWeekSelectors(selectedWeek) {
    const songsWeekSelector = document.getElementById('weekSelectorSongs');
    const albumsWeekSelector = document.getElementById('weekSelectorAlbums');
    
    if (songsWeekSelector) {
        // Update the display text to show selected week
        const weekNumber = extractWeekNumber(selectedWeek);
        songsWeekSelector.innerHTML = `<option value="${selectedWeek}">Week ${weekNumber}</option>`;
    }
    
    if (albumsWeekSelector) {
        const weekNumber = extractWeekNumber(selectedWeek);
        albumsWeekSelector.innerHTML = `<option value="${selectedWeek}">Week ${weekNumber}</option>`;
    }
}

// Extract week number from date string
function extractWeekNumber(weekString) {
    // This depends on your date format - adjust as needed
    // Example: if weekString is "04/10/2025", extract week number
    // You might need to implement logic based on your specific format
    
    if (typeof weekString === 'string' && weekString.includes('/')) {
        // Simple extraction - you may need to adjust this
        const parts = weekString.split('/');
        const month = parseInt(parts[0]);
        const day = parseInt(parts[1]);
        
        // Calculate approximate week number (this is a simplified approach)
        const weekNumber = Math.ceil((month * 4) + (day / 7));
        return weekNumber;
    }
    
    return 'Current';
}

// Show loading state for charts
function showChartsLoading() {
    const containers = ['songsChartContainer', 'albumsChartContainer'];
    
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '<div class="loading-message">Loading charts data for selected week...</div>';
        }
    });
    
    // Also update insights
    const overviewElements = document.querySelectorAll('.charts-overview p');
    overviewElements.forEach(element => {
        element.textContent = 'Loading chart insights for selected week...';
    });
}

// Show message when no charts data is available
function showNoChartsDataMessage(week) {
    const containers = ['songsChartContainer', 'albumsChartContainer'];
    
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `<div class="no-data">No charts data available for ${week}. Please select a different week.</div>`;
        }
    });
    
    // Update insights
    const overviewElements = document.querySelectorAll('.charts-overview p');
    overviewElements.forEach(element => {
        element.textContent = `Charts data is not available for the selected week (${week}). Please choose a different week from the dropdown.`;
    });
}

// Show error message
function showChartsError() {
    const containers = ['songsChartContainer', 'albumsChartContainer'];
    
    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '<div class="loading-message">Error loading charts data. Please try again.</div>';
        }
    });
}

// Initialize the connection when charts tab is loaded
function initializeChartsWeekIntegration() {
    console.log('🔄 Initializing charts week integration');
    
    // Connect to the week selector
    connectChartsToWeekSelector();
    
    // If there's already a selected week, update charts to match
    const currentWeekSelector = document.getElementById('weekDropdown');
    if (currentWeekSelector && currentWeekSelector.value) {
        const selectedWeek = currentWeekSelector.value;
        console.log('📅 Syncing charts to current week:', selectedWeek);
        updateChartsForWeek(selectedWeek);
    }
}

// Duplicate updateChartsTab function removed - keeping main implementation with force refresh capability
	
	
	// Simple direct update function
window.updateAllInsights = function() {
    // Summary view
    const summaryElement = document.querySelector('#chartSummaryView .charts-overview p');
    if (summaryElement) {
        summaryElement.textContent = generateSummaryInsights();
        console.log('✅ Updated summary insights');
    }
    
    // Songs view  
    const songsElement = document.querySelector('#songsChartView .charts-overview p');
    if (songsElement) {
        songsElement.textContent = generateSongsInsights();
        console.log('✅ Updated songs insights');
    }
    
    // Albums view
    const albumsElement = document.querySelector('#albumsChartView .charts-overview p');
    if (albumsElement) {
        albumsElement.textContent = generateAlbumsInsights();
        console.log('✅ Updated albums insights');
    }
};
	
	// ==========================================
// CHARTS VIEW SWITCHING (Duplicate removed - keeping main implementation)
// ==========================================

// Note: currentChartsView already declared globally above, removing duplicate declaration
	
	
	
	// ==========================================
// CHART INSIGHTS AND NARRATIVES
// ==========================================

// Generate insights for Chart Summary view
function generateSummaryInsights() {
    if (songsData.length === 0 && albumsData.length === 0) {
        return "Loading chart data to generate insights...";
    }
    
    const insights = [];
    
    // Overall chart activity
    const totalSongs = songsData.length;
    const totalAlbums = albumsData.length;
    insights.push(`This week's analysis covers ${totalSongs} songs and ${totalAlbums} albums on the Christian music charts.`);
    
    // New entries analysis
    const newSongs = songsData.filter(s => s.isNew).length;
    const newAlbums = albumsData.filter(a => a.isNew).length;
    if (newSongs > 0 || newAlbums > 0) {
        insights.push(`Chart freshness is strong with ${newSongs} new song entries and ${newAlbums} new album debuts this week.`);
    }
    
    // Movement analysis
    const songsMovingUp = songsData.filter(s => s.movement === 'up').length;
    const songsMovingDown = songsData.filter(s => s.movement === 'down').length;
    const albumsMovingUp = albumsData.filter(a => a.movement === 'up').length;
    const albumsMovingDown = albumsData.filter(a => a.movement === 'down').length;
    
    if (songsMovingUp > songsMovingDown) {
        insights.push(`Songs chart shows positive momentum with ${songsMovingUp} tracks moving up versus ${songsMovingDown} declining.`);
    } else if (songsMovingDown > songsMovingUp) {
        insights.push(`Songs chart indicates market shifts with ${songsMovingDown} tracks declining versus ${songsMovingUp} climbing.`);
    }
    
    // Top performer analysis
    if (songsData.length > 0) {
        const topSong = songsData[0];
        const topSongChange = topSong.lastWeek > 0 ? ` (${topSong.movement === 'up' ? 'up' : topSong.movement === 'down' ? 'down' : 'steady'} from #${topSong.lastWeek})` : ' (new entry)';
        insights.push(`"${topSong.title}" by ${topSong.artist} dominates the songs chart at #1${topSongChange}.`);
    }
    
    if (albumsData.length > 0) {
        const topAlbum = albumsData[0];
        const topAlbumChange = topAlbum.lastWeek > 0 ? ` (${topAlbum.movement === 'up' ? 'rising' : topAlbum.movement === 'down' ? 'falling' : 'holding'} from #${topAlbum.lastWeek})` : ' (debut)';
        insights.push(`"${topAlbum.title}" by ${topAlbum.artist} leads the albums chart${topAlbumChange}.`);
    }
    
    // Label performance analysis
    const labelPerformance = analyzeLabelPerformance();
    if (labelPerformance) {
        insights.push(labelPerformance);
    }
    
    // Streaming performance
    const streamingInsights = analyzeStreamingPerformance();
    if (streamingInsights) {
        insights.push(streamingInsights);
    }
    
    return insights.join(' ');
}

// Generate insights for Songs chart view
function generateSongsInsights() {
    if (songsData.length === 0) {
        return "Loading songs chart data to generate insights...";
    }
    
    const insights = [];
    
    // Chart composition
    insights.push(`The songs chart features ${songsData.length} tracks representing the most popular Christian music this week.`);
    
    // Top 10 analysis
    const top10 = songsData.slice(0, 10);
    const top10NewEntries = top10.filter(s => s.isNew).length;
    const top10Climbers = top10.filter(s => s.movement === 'up').length;
    
    if (top10NewEntries > 0) {
        insights.push(`The top 10 welcomes ${top10NewEntries} fresh ${top10NewEntries === 1 ? 'entry' : 'entries'}, indicating strong new music adoption.`);
    }
    
    if (top10Climbers >= 5) {
        insights.push(`Significant upward movement characterizes the top 10, with ${top10Climbers} tracks climbing from previous positions.`);
    }
    
    // Biggest mover analysis
    const biggestMover = findBiggestMover(songsData);
    if (biggestMover) {
        const moveDirection = biggestMover.movement === 'up' ? 'climbed' : 'dropped';
        const moveAmount = Math.abs(biggestMover.lastWeek - biggestMover.rank);
        insights.push(`"${biggestMover.title}" by ${biggestMover.artist} made the week's biggest move, ${moveDirection} ${moveAmount} positions to #${biggestMover.rank}.`);
    }
    
    // Longevity analysis
    const veteranTracks = songsData.filter(s => s.weeksOnChart >= 20).length;
    const freshTracks = songsData.filter(s => s.weeksOnChart <= 4).length;
    
    if (veteranTracks > 0) {
        insights.push(`Chart longevity is evident with ${veteranTracks} tracks maintaining ${veteranTracks === 1 ? 'its' : 'their'} presence for 20+ weeks.`);
    }
    
    if (freshTracks > 0) {
        insights.push(`New music energy drives the chart with ${freshTracks} tracks in their first month of charting.`);
    }
    
    // Streaming milestone analysis
    const millionStreamers = songsData.filter(s => s.streams >= 1000000).length;
    if (millionStreamers > 0) {
        insights.push(`Streaming strength is demonstrated by ${millionStreamers} tracks achieving over 1 million weekly streams.`);
    }
    
    // Current filter insights
    if (currentSongFilter !== 'all') {
        const filterInsights = generateFilterInsights(currentSongFilter, 'songs');
        if (filterInsights) insights.push(filterInsights);
    }
    
    return insights.join(' ');
}

// Generate insights for Albums chart view
function generateAlbumsInsights() {
    if (albumsData.length === 0) {
        return "Loading albums chart data to generate insights...";
    }
    
    const insights = [];
    
    // Chart overview
    insights.push(`The albums chart showcases ${albumsData.length} releases representing the most consumed Christian music projects this week.`);
    
    // New releases analysis
    const newReleases = albumsData.filter(a => a.isNew).length;
    const debutInTop10 = albumsData.slice(0, 10).filter(a => a.isNew).length;
    
    if (newReleases > 0) {
        insights.push(`Fresh releases energize the chart with ${newReleases} new ${newReleases === 1 ? 'album' : 'albums'} making ${newReleases === 1 ? 'its' : 'their'} debut${debutInTop10 > 0 ? `, including ${debutInTop10} in the top 10` : ''}.`);
    }
    
    // Peak performance analysis
    const numberOnes = albumsData.filter(a => a.peakPosition === 1).length;
    if (numberOnes > 1) {
        insights.push(`Chart history shows ${numberOnes} current albums have previously reached the #1 position, demonstrating sustained artist appeal.`);
    }
    
    // Activity vs streaming analysis
    const topActivity = albumsData.slice(0, 5);
    const activityLeader = topActivity.reduce((prev, current) => prev.sales > current.sales ? prev : current);
    const streamingLeader = topActivity.reduce((prev, current) => prev.streams > current.streams ? prev : current);
    
    if (activityLeader.rank !== streamingLeader.rank) {
        insights.push(`Market dynamics reveal "${activityLeader.title}" leads in total activity while "${streamingLeader.title}" dominates streaming consumption.`);
    }
    
    // Biggest album mover
    const biggestAlbumMover = findBiggestMover(albumsData);
    if (biggestAlbumMover) {
        const moveDirection = biggestAlbumMover.movement === 'up' ? 'surged' : 'declined';
        const moveAmount = Math.abs(biggestAlbumMover.lastWeek - biggestAlbumMover.rank);
        insights.push(`"${biggestAlbumMover.title}" by ${biggestAlbumMover.artist} ${moveDirection} ${moveAmount} positions to #${biggestAlbumMover.rank}, marking the week's most significant album movement.`);
    }
    
    // Catalog performance
    const catalogAlbums = albumsData.filter(a => a.weeksOnChart >= 52).length;
    if (catalogAlbums > 0) {
        insights.push(`Catalog strength remains evident with ${catalogAlbums} albums maintaining chart presence for over a year.`);
    }
    
    // Sales milestone analysis
    const strongSellers = albumsData.filter(a => a.sales >= 10000).length;
    if (strongSellers > 0) {
        insights.push(`Commercial impact is demonstrated by ${strongSellers} albums achieving 10,000+ weekly activity units.`);
    }
    
    // Current filter insights
    if (currentAlbumFilter !== 'all') {
        const filterInsights = generateFilterInsights(currentAlbumFilter, 'albums');
        if (filterInsights) insights.push(filterInsights);
    }
    
    return insights.join(' ');
}

// Helper function to find biggest mover
function findBiggestMover(data) {
    return data
        .filter(item => item.lastWeek > 0 && (item.movement === 'up' || item.movement === 'down'))
        .sort((a, b) => Math.abs(b.lastWeek - b.rank) - Math.abs(a.lastWeek - a.rank))[0];
}

// Analyze label performance
function analyzeLabelPerformance() {
    if (songsData.length === 0 && albumsData.length === 0) return null;
    
    const labelStats = {};
    
    // Count songs and albums by label
    [...songsData, ...albumsData].forEach(item => {
        if (!labelStats[item.label]) {
            labelStats[item.label] = { songs: 0, albums: 0, topTen: 0 };
        }
        
        if (songsData.includes(item)) labelStats[item.label].songs++;
        if (albumsData.includes(item)) labelStats[item.label].albums++;
        if (item.rank <= 10) labelStats[item.label].topTen++;
    });
    
    // Find dominant label
    const sortedLabels = Object.entries(labelStats)
        .sort((a, b) => (b[1].songs + b[1].albums) - (a[1].songs + a[1].albums));
    
    if (sortedLabels.length > 0) {
        const [topLabel, stats] = sortedLabels[0];
        const totalItems = stats.songs + stats.albums;
        return `${topLabel} demonstrates chart leadership with ${totalItems} total chart positions${stats.topTen > 0 ? ` including ${stats.topTen} top 10 placements` : ''}.`;
    }
    
    return null;
}

// Analyze streaming performance
function analyzeStreamingPerformance() {
    if (songsData.length === 0) return null;
    
    const totalStreams = songsData.reduce((sum, song) => sum + (song.streams || 0), 0);
    const avgStreams = Math.round(totalStreams / songsData.length);
    const topStreamers = songsData.filter(s => s.streams >= avgStreams * 2).length;
    
    if (topStreamers > 0) {
        return `Streaming concentration shows ${topStreamers} tracks achieving significantly above-average performance with 2x+ the chart average of ${formatNumber(avgStreams)} streams.`;
    }
    
    return null;
}

// Generate insights based on current filter
function generateFilterInsights(filter, type) {
    const data = type === 'songs' ? songsData : albumsData;
    const itemType = type === 'songs' ? 'song' : 'album';
    
    switch (filter) {
        case 'fresh':
            const freshCount = data.filter(item => item.weeksOnChart <= 52).length;
            return `Fresh Tracks filter reveals ${freshCount} ${itemType}s with under 52 weeks of chart activity, representing emerging favorites.`;
            
        case 'new':
            const newCount = data.filter(item => item.isNew).length;
            return `New Entries filter highlights ${newCount} debut ${itemType}s making their first chart appearance this week.`;
            
        case 'increases':
            const increasesCount = data.filter(item => item.movement === 'up' || item.percentChange > 0).length;
            return `Increases filter shows ${increasesCount} ${itemType}s gaining momentum with improved chart positions or streaming growth.`;
            
        case 'decreases':
            const decreasesCount = data.filter(item => item.movement === 'down' || item.percentChange < 0).length;
            return `Decreases filter identifies ${decreasesCount} ${itemType}s experiencing position declines or reduced streaming activity.`;
            
        default:
            return null;
    }
}

// Update insights when view or filter changes
function updateChartInsights() {
    let insights = '';
    
    switch (currentChartsView) {
        case 'summary':
            insights = generateSummaryInsights();
            break;
        case 'songs':
            insights = generateSongsInsights();
            break;
        case 'albums':
            insights = generateAlbumsInsights();
            break;
    }
    
    // Update the overview text
    const overviewElement = document.querySelector('.charts-overview p');
    if (overviewElement) {
        overviewElement.textContent = insights;
    }
}

// Update the existing functions to include insights
function switchChartsView(viewName, element) {
    console.log('Switching to charts view:', viewName);
    currentChartsView = viewName;
    
    // Update active nav button
    document.querySelectorAll('.charts-nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    if (element) {
        element.classList.add('active');
    }
    
    // Hide all chart views
    document.querySelectorAll('.chart-view').forEach(view => {
        view.classList.remove('active');
    });
    
    // Show selected view
    const selectedView = document.getElementById(viewName === 'summary' ? 'chartSummaryView' : viewName + 'ChartView');
    if (selectedView) {
        selectedView.classList.add('active');
    }
    
    // Update content and insights based on view
    switch(viewName) {
        case 'summary':
            updateAnalyticsCards();
            break;
        case 'songs':
            renderSongsChart();
            break;
        case 'albums':
            renderAlbumsChart();
            break;
    }
    
    // Update insights for the new view
    setTimeout(() => {
        updateChartInsights();
    }, 100);
}

// Update filter functions to refresh insights
function filterSongs(filterType) {
    currentSongFilter = filterType;
    renderSongsChart();
    setTimeout(() => {
        updateChartInsights();
    }, 100);
}

function filterAlbums(filterType) {
    currentAlbumFilter = filterType;
    renderAlbumsChart();
    setTimeout(() => {
        updateChartInsights();
    }, 100);
}

// Update renderCurrentChartsView to include insights
function renderCurrentChartsView() {
    switch(currentChartsView) {
        case 'summary':
            updateAnalyticsCards();
            break;
        case 'songs':
            renderSongsChart();
            break;
        case 'albums':
            renderAlbumsChart();
            break;
        default:
            updateAnalyticsCards();
    }
    
    // Update insights after rendering
    setTimeout(() => {
        updateChartInsights();
    }, 200);
    
    // Load Spotify artwork after rendering
    if (songsData.length > 0 || albumsData.length > 0) {
        setTimeout(() => {
            loadSpotifyArtwork();
        }, 1000);
    }
}

/// ==========================================
// SPOTIFY ARTWORK INTEGRATION
// ==========================================

// Spotify API configuration
const SPOTIFY_CLIENT_ID = '4777efa77ba14e3ea18f230c63821ce9';
const SPOTIFY_CLIENT_SECRET = 'a16a0c1146904826ab8b83d679894d8b';
let spotifyAccessToken = null;

// Initialize Spotify API
async function initializeSpotifyAPI() {
    try {
        const response = await fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Authorization': 'Basic ' + btoa(SPOTIFY_CLIENT_ID + ':' + SPOTIFY_CLIENT_SECRET)
            },
            body: 'grant_type=client_credentials'
        });
        
        const data = await response.json();
        spotifyAccessToken = data.access_token;
        console.log('✅ Spotify API initialized successfully');
        return true;
    } catch (error) {
        console.error('❌ Spotify API initialization failed:', error);
        return false;
    }
}

// Load Spotify artwork for all chart items
async function loadSpotifyArtwork() {
    console.log('🎨 Starting Spotify artwork loading...');
    
    if (!spotifyAccessToken) {
        const initialized = await initializeSpotifyAPI();
        if (!initialized) {
            console.log('❌ Cannot load artwork - Spotify API not available');
            return;
        }
    }
    
    // Load artwork for top songs and albums first
    const topSongs = songsData.slice(0, 10);
    const topAlbums = albumsData.slice(0, 10);
    
    // Load top items first with delay to avoid rate limiting
    for (const song of topSongs) {
        await loadArtworkForItem(song, 'track');
        await delay(200); // 200ms delay between requests
    }
    
    for (const album of topAlbums) {
        await loadArtworkForItem(album, 'album');
        await delay(200);
    }
    
    // Load remaining items in background
    setTimeout(async () => {
        const remainingSongs = songsData.slice(10);
        const remainingAlbums = albumsData.slice(10);
        
        for (const song of remainingSongs) {
            await loadArtworkForItem(song, 'track');
            await delay(300);
        }
        
        for (const album of remainingAlbums) {
            await loadArtworkForItem(album, 'album');
            await delay(300);
        }
    }, 2000);
}

// Load artwork for a specific item
async function loadArtworkForItem(item, type) {
    try {
        const query = cleanSearchQuery(`${item.artist} ${item.title}`);
        const searchUrl = `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=${type}&limit=1`;
        
        const response = await fetch(searchUrl, {
            headers: {
                'Authorization': 'Bearer ' + spotifyAccessToken
            }
        });
        
        const data = await response.json();
        
        let imageUrl = null;
        if (type === 'track' && data.tracks?.items?.length > 0) {
            imageUrl = data.tracks.items[0].album?.images?.[0]?.url;
        } else if (type === 'album' && data.albums?.items?.length > 0) {
            imageUrl = data.albums.items[0].images?.[0]?.url;
        }
        
        if (imageUrl) {
            updateArtworkInDOM(item.rank, imageUrl, type);
            console.log(`🎨 Found artwork for: ${item.artist} - ${item.title}`);
        }
    } catch (error) {
        console.error(`❌ Error loading artwork for ${item.artist} - ${item.title}:`, error);
    }
}

// Clean search query for better Spotify matching
function cleanSearchQuery(query) {
    return query
        .replace(/[()[\]{}]/g, '') // Remove brackets and parentheses
        .replace(/\bfeat\.?\b/gi, '') // Remove "feat" or "feat."
        .replace(/\bft\.?\b/gi, '') // Remove "ft" or "ft."
        .replace(/\s+/g, ' ') // Replace multiple spaces with single space
        .trim();
}

// Update artwork in the DOM
function updateArtworkInDOM(rank, imageUrl, type) {
    // Find all artwork placeholders for this rank
    const selectors = [
        `[data-rank="${rank}"] .artwork-placeholder`,
        `.chart-item:nth-child(${rank}) .artwork-placeholder`,
        `.analytics-item:has(.rank-badge:contains("${rank}")) .artwork-placeholder`
    ];
    
    selectors.forEach(selector => {
        try {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
                if (element && !element.querySelector('img')) {
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = 'Album Artwork';
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 8px;';
                    img.onerror = () => {
                        console.log(`❌ Failed to load image for rank ${rank}`);
                    };
                    element.innerHTML = '';
                    element.appendChild(img);
                }
            });
        } catch (error) {
            console.error('Error updating artwork in DOM:', error);
        }
    });
    
    // Also update by searching for rank badges
    const rankBadges = document.querySelectorAll('.rank-badge');
    rankBadges.forEach(badge => {
        if (badge.textContent.trim() === rank.toString()) {
            const artworkElement = badge.parentElement?.querySelector('.artwork-placeholder') || 
                                 badge.closest('.chart-item')?.querySelector('.artwork-placeholder') ||
                                 badge.closest('.analytics-item')?.querySelector('.artwork-placeholder');
            
            if (artworkElement && !artworkElement.querySelector('img')) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = 'Album Artwork';
                img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 8px;';
                artworkElement.innerHTML = '';
                artworkElement.appendChild(img);
            }
        }
    });
}

// Utility function for delays
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Update the renderCurrentChartsView function to include artwork loading
function renderCurrentChartsView() {
    switch(currentChartsView) {
        case 'summary':
            updateAnalyticsCards();
            updateSummaryText();
            break;
        case 'songs':
            renderSongsChart();
            break;
        case 'albums':
            renderAlbumsChart();
            break;
        default:
            updateAnalyticsCards();
            updateSummaryText();
    }
    
    // Load Spotify artwork after rendering
    if (songsData.length > 0 || albumsData.length > 0) {
        setTimeout(() => {
            loadSpotifyArtwork();
        }, 1000); // Wait 1 second after rendering to start artwork loading
    }
}

// Update chart item rendering to include data attributes for easier artwork targeting
function renderSongsChart() {
    const container = document.getElementById('songsChartContainer');
    if (!container) return;
    
    if (songsData.length === 0) {
        container.innerHTML = '<div class="loading-message">No songs data available. Check Google Drive connection.</div>';
        return;
    }
    
    let filteredSongs = [...songsData];
    
    switch (currentSongFilter) {
        case 'fresh':
            filteredSongs = songsData.filter(song => song.weeksOnChart <= 52);
            break;
        case 'new':
            filteredSongs = songsData.filter(song => song.isNew);
            break;
        case 'increases':
            filteredSongs = songsData.filter(song => song.movement === 'up' || song.percentChange > 0);
            break;
        case 'decreases':
            filteredSongs = songsData.filter(song => song.movement === 'down' || song.percentChange < 0);
            break;
    }
    
    if (filteredSongs.length === 0) {
        container.innerHTML = '<div class="no-data">No songs match the current filter</div>';
        return;
    }
    
    container.innerHTML = filteredSongs.map(song => {
        const changeIndicator = getChangeIndicator(song.movement, song.lastWeek, song.rank);
        const labelColor = getLabelColor(song.label);
        
        return `
            <div class="chart-item" data-rank="${song.rank}" data-type="song">
                <div class="item-left">
                    <div class="rank-display">${song.rank}</div>
                    <div class="artwork-placeholder" data-artist="${song.artist}" data-title="${song.title}">♪</div>
                    <div class="track-info">
                        <div class="track-title">${song.title}</div>
                        <div class="track-artist">${song.artist}</div>
                        <div class="track-label" style="color: ${labelColor}">${song.label}</div>
                    </div>
                </div>
                <div class="item-right">
                    <div class="stats-row">
                        <span class="stat-item">
                            <span class="stat-label">STREAMS</span>
                            <span class="stat-value">${formatNumber(song.streams)}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">LAST WEEK</span>
                            <span class="stat-value">${song.lastWeek || '-'}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">% CHG</span>
                            <span class="stat-value">${song.percentChange > 0 ? '+' : ''}${song.percentChange}%</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">WEEKS</span>
                            <span class="stat-value">${song.weeksOnChart}</span>
                        </span>
                    </div>
                    ${changeIndicator}
                </div>
            </div>
        `;
    }).join('');
}

function renderAlbumsChart() {
    const container = document.getElementById('albumsChartContainer');
    if (!container) return;
    
    if (albumsData.length === 0) {
        container.innerHTML = '<div class="loading-message">No albums data available. Check Google Drive connection.</div>';
        return;
    }
    
    let filteredAlbums = [...albumsData];
    
    switch (currentAlbumFilter) {
        case 'new':
            filteredAlbums = albumsData.filter(album => album.isNew);
            break;
        case 'increases':
            filteredAlbums = albumsData.filter(album => album.movement === 'up' || album.percentChange > 0);
            break;
        case 'decreases':
            filteredAlbums = albumsData.filter(album => album.movement === 'down' || album.percentChange < 0);
            break;
    }
    
    if (filteredAlbums.length === 0) {
        container.innerHTML = '<div class="no-data">No albums match the current filter</div>';
        return;
    }
    
    container.innerHTML = filteredAlbums.map(album => {
        const changeIndicator = getChangeIndicator(album.movement, album.lastWeek, album.rank);
        const labelColor = getLabelColor(album.label);
        
        return `
            <div class="chart-item" data-rank="${album.rank}" data-type="album">
                <div class="item-left">
                    <div class="rank-display">${album.rank}</div>
                    <div class="artwork-placeholder" data-artist="${album.artist}" data-title="${album.title}">♫</div>
                    <div class="track-info">
                        <div class="track-title">${album.title}</div>
                        <div class="track-artist">${album.artist}</div>
                        <div class="track-label" style="color: ${labelColor}">${album.label}</div>
                    </div>
                </div>
                <div class="item-right">
                    <div class="stats-row">
                        <span class="stat-item">
                            <span class="stat-label">TA</span>
                            <span class="stat-value">${formatNumber(album.sales)}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">STREAMS</span>
                            <span class="stat-value">${formatNumber(album.streams)}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">PEAK</span>
                            <span class="stat-value">${album.peakPosition}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">LAST WEEK</span>
                            <span class="stat-value">${album.lastWeek || '-'}</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">% CHG</span>
                            <span class="stat-value">${album.percentChange > 0 ? '+' : ''}${album.percentChange}%</span>
                        </span>
                        <span class="stat-item">
                            <span class="stat-label">WEEKS</span>
                            <span class="stat-value">${album.weeksOnChart}</span>
                        </span>
                    </div>
                    ${changeIndicator}
                </div>
            </div>
        `;
    }).join('');
}
	


// Force initial insights update when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        console.log('🔄 Force updating insights on DOM ready');
        updateChartInsights();
    }, 2000);
});

// Duplicate updateChartsTab function removed - keeping main implementation with force refresh capability



// Manual refresh function for charts
function refreshChartsData() {
    console.log('🔄 Manual refresh triggered');
    updateChartsTab(true); // Force refresh
}
	
</script> 
    <!-- END CONFIGURATION -->
    
   <style>
    /* Font variables */
    :root {
        --font-serif: 'ivypresto-headline', Georgia, 'Times New Roman', serif;
        --font-sans: 'pragmatica-extended', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    body {
        margin: 0;
        padding: 0;
        background: #0f1419;
        color: #e0e0e0;
        font-family: var(--font-sans);
        min-height: 100vh;
        overflow-x: hidden;
		
		

}

/* Headings - use the serif font for impact */
	   
	   
h1, h2, h3, h4, h6,
.page-title,
.chart-title,
.section-title,
.dashboard-title {
    font-family: var(--font-serif);
    font-weight: 400; /* IvyPresto works best at normal weight */
    letter-spacing: 0em; /* Tighten tracking slightly for headlines */ 
}
	   
	   h3.chart-title,
	   h3.section-title {font-size: 1.6em !important;     letter-spacing: 0em; /* Tighten tracking slightly for headlines */ 
}

/* UI elements and data - use the sans font */
.tab, h5,
.metric-value,
.metric-title,
.table-content,
.data-value,
.label-text,
button,
select,
input {
    font-family: var(--font-sans);
    letter-spacing: 0.01em; /* Pragmatica benefits from slight spacing */
}

/* Specific updates for major elements */
.page-title {
    font-family: var(--font-serif);
    font-size: 48px;
    font-weight: 400;
    line-height: 1.1;
}

.metric-value {
    font-family: var(--font-sans);
    font-weight: 700; /* Use bold weight for numbers */
}

.chart-title {
    font-family: var(--font-serif);
    font-size: 24px;
    font-weight: 400;
}

@media (max-width: 768px) {
    .chart-title, h3.chart-title {
        font-size: 1.3rem !important;
    }
}

@media (max-width: 480px) {
    .chart-title, h3.chart-title {
        font-size: 1.1rem !important;
    }
}

@media (max-width: 375px) {
    .chart-title, h3.chart-title {
        font-size: 1rem !important;
    }
}

/* Navigation and tabs */
.tab {
    font-family: var(--font-sans);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Tables */
.ranking-table th,
.ranking-table td {
    font-family: var(--font-sans);
}

/* Buttons */
.download-btn,
.export-btn,
.action-button {
    font-family: var(--font-sans);
    font-weight: 600;
    letter-spacing: 0.02em;
}
		
		
		
		/* Add to your CSS */
@font-face {
    font-display: swap; /* Ensures text remains visible during font load */
}

/* Preload critical fonts */
		
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease-out;
        }

     .header h1 {
    font-size: 3rem;
    font-weight: 700;
    font-family: var(--font-serif);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 10px;
    letter-spacing: -0.02em;
}

@media (max-width: 768px) {
    .header h1 {
        font-size: 2rem !important;
    }
}

@media (max-width: 480px) {
    .header h1 {
        font-size: 1.75rem !important;
    }
}

@media (max-width: 375px) {
    .header h1 {
        font-size: 1.5rem !important;
    }
}

.header p {
    font-size: 1.2rem;
    color: #a0a0a0;
    font-family: 'pragmatica-extended', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    font-weight: 400;
}
       .control-section {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 40px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    animation: fadeInUp 0.8s ease-out 0.8s both;
}

@media (max-width: 768px) {
    .control-section {
        padding: 20px 15px !important;
        margin: 30px !important;
        border-radius: 15px !important;
    }
}

   .control-row {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .control-row {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 15px !important;
    }
}

     .control-group {
    display: inline-flex;
    align-items: center;
    gap: 10px;
}

@media (max-width: 768px) {
    .control-group {
        display: flex !important;
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 8px !important;
        width: 100% !important;
    }
    
    .control-group label {
        font-size: 0.9rem !important;
        color: #a0a0a0 !important;
        margin-bottom: 5px !important;
    }
}

        .button {
    padding: 10px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    font-size: 0.9rem;
    font-family: 'pragmatica-extended', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    letter-spacing: 0.02em;
}
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .button.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

       select {
    padding: 8px 15px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    color: white;
    font-size: 0.9rem;
    cursor: pointer;
}

@media (max-width: 768px) {
    select {
        width: 100% !important;
        padding: 12px 15px !important;
        font-size: 1rem !important;
        min-height: 48px !important;
    }
}

        select option {
            background: #1a1a2e;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0 10px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 15px 15px 0 0;
        }

       .tab {
    padding: 10px 20px;
    background: none;
    border: none;
    color: #a0a0a0;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    position: relative;
    font-family: 'pragmatica-extended', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

        .tab.active {
            color: #ffffff;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -11px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Mobile dropdown for tabs - UPDATED */
.mobile-tab-dropdown {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    width: 100%;
    background: rgba(26, 26, 46, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(102, 126, 234, 0.3);
    padding: 15px 20px;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.mobile-tab-select {
    width: 100%;
    padding: 15px 20px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: 12px;
    color: white;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    text-align: center;
}

.mobile-tab-select:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
    border-color: rgba(102, 126, 234, 0.5);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
}

.mobile-tab-select:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
}

.mobile-tab-select option {
    background: #1a1a2e;
    color: white;
    padding: 10px;
}

/* Show mobile dropdown only on mobile and adjust body padding */
@media (max-width: 768px) {
    .mobile-tab-dropdown {
        display: block !important;
    }
    
    /* Hide desktop tabs on mobile */
    .tabs {
        display: none !important;
    }
    
    /* Add top padding to body to account for fixed dropdown */
    body {
        padding-top: 70px; /* Adjust based on dropdown height */
    }
    
    /* Adjust container for mobile */
    .container {
        padding-top: 0;
    }
    
    /* Adjust header margin */
    .header {
        margin-top: 0;
        padding-top: 20px;
    }
}

/* Hide mobile dropdown on desktop */
@media (min-width: 769px) {
    .mobile-tab-dropdown {
        display: none !important;
    }
    
    body {
        padding-top: 0;
    }
}

        .tab-content {
            display: none;
            animation-duration: 0.5s;
            animation-fill-mode: both; padding: 20px !important;
        }

        .tab-content.active {
            display: block;
            animation-name: fadeIn;
        }

       .metrics-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 40px;
    width: 100%;
    /* Dynamic grid - will be set by JavaScript */
}

       .metric-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
    min-height: 280px;
    display: flex;
    flex-direction: column;
    width: 100%;  /* ADD THIS LINE if not present */
}

        .metric-card:hover {
            transform: translateY(-5px);
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .metric-label {
            font-size: 0.9rem;
            color: #a0a0a0;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

       .metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 10px;
    display: flex;
    align-items: baseline;
    gap: 10px;
    font-family: var(--font-sans);
    letter-spacing: -0.02em;
}

@media (max-width: 768px) {
    .metric-value {
        font-size: 1.5rem !important;
    }
}

@media (max-width: 480px) {
    .metric-value {
        font-size: 1.3rem !important;
    }
}

@media (max-width: 375px) {
    .metric-value {
        font-size: 1.2rem !important;
    }
}

        .metric-change {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .metric-change.positive {
            color: #4ade80;
        }

        .metric-change.negative {
            color: #f87171;
        }

      .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
}

@media (max-width: 768px) {
    .charts-grid {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
    }
}

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            will-change: transform;
            transform: translateZ(0); /* Enable GPU acceleration */
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
    font-size: 1.5rem;
    font-weight: 400;
    margin-bottom: 20px;
    text-align: center;
    font-family: 'ivypresto-headline', Georgia, 'Times New Roman', serif;
    letter-spacing: -0.02em;
}
        /* Chart animation optimization */
        .chart-wrapper {
            position: relative;
            height: 350px;
            will-change: transform;
        }

        .chart-wrapper.tall {
            height: 450px;
        }

        #streamChartWrapper {
            height: 400px;
        }

        .week-selector {
            text-align: center;
            margin: 0 auto 30px;
            padding: 0 20px;
        }

        .week-dropdown {
            padding: 12px 24px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 25px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            min-width: 200px;
            max-width: 300px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .week-dropdown:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .week-dropdown:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
        }

        .alert-section {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

      .alert-title {
    font-size: 1.2rem;
    font-weight: 400;
    margin-bottom: 15px;
    color: #ffa500;
    font-family: 'ivypresto-headline', Georgia, 'Times New Roman', serif;
}

        .alert-item {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            min-width: 800px;
        }

        .ranking-table th {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            cursor: pointer;
            user-select: none;
            position: relative;
            white-space: nowrap;
        }

        .ranking-table th:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .ranking-table th.sortable::after {
            content: '↕';
            position: absolute;
            right: 10px;
            color: #666;
        }

        .ranking-table th.sorted-asc::after {
            content: '↑';
            color: #667eea;
        }

        .ranking-table th.sorted-desc::after {
            content: '↓';
            color: #667eea;
        }

        .ranking-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            white-space: nowrap;
        }

        .ranking-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Desktop/Tablet table wrapper for horizontal scroll */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: -20px;
            padding: 20px;
        }
        
        /* Mobile Rankings Card View */
        .mobile-rankings {
            display: none;
        }
        
        .ranking-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .ranking-card:hover {
            transform: translateY(-2px);
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .ranking-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .ranking-card-rank {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .rank-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .rank-label {
            font-size: 1.15rem;
            font-weight: 600;
        }
        
        .market-share-badge {
            background: rgba(102, 126, 234, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .ranking-card-body {
            display: grid;
            gap: 12px;
        }
        
        .ranking-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .ranking-metric-label {
            color: #a0a0a0;
            font-size: 0.85rem;
        }
        
        .ranking-metric-value {
            font-weight: 500;
            text-align: right;
        }
        
        .ranking-metric-group {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }
        
        .ranking-metric-group-title {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }
        
        /* Hide desktop view on mobile */
        @media (max-width: 768px) {
            .desktop-rankings {
                display: none;
            }
            
            .mobile-rankings {
                display: block;
            }
        }
        
        /* Show desktop view on larger screens */
        @media (min-width: 769px) {
            .desktop-rankings {
                display: block;
            }
            
            .mobile-rankings {
                display: none !important;
            }
        }

        .performance-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .performance-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .performance-card h4 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: #a0a0a0;
    font-family: 'pragmatica-extended', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-weight: 600;
			    letter-spacing: 0.05em;

        }

        .performance-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0; 
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a0a0a0;
        }

        .volatility-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .volatility-low {
            background: #4ade80;
        }

        .volatility-medium {
            background: #ffa500;
        }

        .volatility-high {
            background: #f87171;
        }

        /* Input field styles for settings */
      input[type="date"],
input[type="number"],
input[type="password"],
textarea,
select {
    font-family: 'pragmatica-extended', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            filter: invert(1);
            cursor: pointer;
        }

        /* Projection list items */
        #projectionsList > div > div {
            transition: all 0.3s ease;
        }

        #projectionsList > div > div:hover {
            background: rgba(255, 255, 255, 0.08) !important;
            transform: translateX(5px);
        }

        /* Week checkbox styling */
        .week-checkbox {
            accent-color: #667eea;
        }
        
        #weekCheckboxList label:hover {
            background: rgba(255, 255, 255, 0.05);
            padding: 3px 6px;
            margin: -3px -6px;
            border-radius: 4px;
        }
        
        /* Week context cards */
        #weeksWithContextList > div > div {
            transition: all 0.3s ease;
        }
        
        #weeksWithContextList > div > div:hover {
            background: rgba(255, 255, 255, 0.08) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        /* Progress Bar Styles */
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .progress-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .progress-container {
            background: rgba(26, 26, 46, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(102, 126, 234, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .progress-title {
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
            color: #ffffff;
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .progress-bar-wrapper {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .progress-text {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #a0a0a0;
        }

        /* Stream chart placeholder animation */
        #streamChartPlaceholder {
            animation: fadeIn 0.5s ease-out;
        }
        
        #streamChartWrapper {
            animation: fadeIn 0.8s ease-out;
        }
        
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .control-section, .tabs, .week-selector, .control-group, .mobile-tab-dropdown, #settings-tab {
                display: none;
            }
            
            .chart-container, .metric-card {
                break-inside: avoid;
                background: white;
                border: 1px solid #ddd;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (min-width: 769px) {
            .mobile-tab-dropdown {
                display: none !important;
            }
            
            .tabs {
                display: flex !important;
            }
        }
        
        @media (min-width: 768px) and (max-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .performance-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .tabs {
        display: none !important;
    }
    
    .mobile-tab-dropdown {
        display: block !important;
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        background: rgba(26, 26, 46, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(102, 126, 234, 0.3);
        padding: 10px 20px;
        z-index: 999;
    }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .chart-wrapper {
                height: 280px;
            }
            
            /* Adjust stream chart height on mobile */
            #streamChartWrapper {
                height: 300px !important;
            }
            
            .week-selector {
                text-align: center;
                padding: 0 10px;
            }
            
            .week-dropdown {
                width: 100%;
                max-width: 280px;
                padding: 10px 20px;
                font-size: 0.95rem;
            }
          
			    .metrics-grid {
        grid-template-columns: 1fr !important;
        gap: 15px !important;
    }
    
    .metric-card {
        min-height: 200px !important;
        padding: 18px !important;
    }
}
            
            /* Ensure metric cards have proper min-height on mobile */
            .metric-card {
                min-height: auto;
            }
            
            .performance-cards {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                justify-content: center;
                margin-bottom: 15px;
            }
            
            .button, .button.secondary {
                width: 100%;
                max-width: 400px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.75rem;
            }
            
            .week-selector {
                padding: 0 10px;
                margin-bottom: 25px;
            }
            
            .week-dropdown {
                width: 100%;
                max-width: 260px;
                font-size: 0.9rem;
                padding: 10px 16px;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
            
            .mobile-tab-select {
                font-size: 0.95rem;
                padding: 10px 20px;
            }
            
            /* Hide YTD units, albums, and volatility columns on small screens to save space */
            .ranking-table th:nth-child(5),
            .ranking-table td:nth-child(5),
            .ranking-table th:nth-child(6),
            .ranking-table td:nth-child(6),
            .ranking-table th:nth-child(9),
            .ranking-table td:nth-child(9) {
                display: none;
            }
        }
	   
	   
	   @media (max-width: 768px) {
    .chart-container {
        padding: 20px 15px !important;
        margin-bottom: 20px !important;
    }
    
    .chart-wrapper {
        height: 300px !important;
        min-height: 300px !important;
    }
    
    .chart-title {
        font-size: 1.2rem !important;
        margin-bottom: 15px !important;
        text-align: center !important;
    }
}
		
		#totalMarketCard { /* Restore original layout behavior */ display: flex !important; flex-direction: column !important; justify-content: flex-start !important; align-items: stretch !important; text-align: left !important; min-height: 280px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-color: rgba(102, 126, 234, 0.2); } /* Ensure all flex rows maintain original space-between layout */ #totalMarketCard div[style*="display: flex"] { justify-content: space-between !important; align-items: center !important; text-align: left !important; } /* Responsive text scaling for all metric values */ #totalMarketCard span[style*="font-size: 1.5rem"] { font-size: clamp(1.2rem, 4vw, 1.8rem) !important; font-weight: 700 !important; } #totalMarketCard span[style*="font-size: 1.1rem"] { font-size: clamp(0.95rem, 3vw, 1.2rem) !important; font-weight: 600 !important; } #totalMarketCard span[style*="font-size: 0.85rem"] { font-size: clamp(0.75rem, 2.5vw, 0.9rem) !important; } #totalMarketCard span[style*="font-size: 0.75rem"] { font-size: clamp(0.65rem, 2vw, 0.8rem) !important; } #totalMarketCard div[style*="font-size: 1rem"] { font-size: clamp(0.9rem, 2.5vw, 1.1rem) !important; margin-bottom: 15px !important; } /* Mobile optimizations */ @media (max-width: 768px) { #totalMarketCard { padding: 15px !important; min-height: 220px !important; } #totalMarketCard span[style*="font-size: 1.5rem"] { font-size: 1.3rem !important; } #totalMarketCard span[style*="font-size: 1.1rem"] { font-size: 1rem !important; } } @media (max-width: 480px) { #totalMarketCard { min-height: 200px !important; } #totalMarketCard span[style*="font-size: 1.5rem"] { font-size: 1.2rem !important; } }
		
		/* 2. Smart Label Cards Grid */ #metricsGrid { display: grid; gap: 20px; margin-bottom: 40px; width: 100%; } @media (min-width: 769px) { #metricsGrid { grid-template-columns: repeat(12, 1fr); } #metricsGrid .metric-card:nth-child(1), #metricsGrid .metric-card:nth-child(2), #metricsGrid .metric-card:nth-child(3) { grid-column: span 4; } #metricsGrid .metric-card:nth-child(n+4):nth-child(-n+7) { grid-column: span 3; } #metricsGrid .metric-card:nth-child(n+8):nth-child(-n+10) { grid-column: span 4; } #metricsGrid .metric-card:nth-child(n+11):nth-child(-n+14) { grid-column: span 3; } } @media (min-width: 481px) and (max-width: 768px) { #metricsGrid { grid-template-columns: repeat(2, 1fr); } } @media (max-width: 480px) { #metricsGrid { grid-template-columns: 1fr; gap: 15px; } } 
		
		
		/* 3. Performance Cards Even Distribution */ #biggestMovers, .performance-cards { display: grid; gap: 20px; margin: 20px 0; width: 100%; } @media (min-width: 769px) { #biggestMovers, .performance-cards { grid-template-columns: repeat(3, 1fr); grid-auto-rows: minmax(120px, auto); } #biggestMovers:has(.performance-card:nth-child(4):last-child), .performance-cards:has(.performance-card:nth-child(4):last-child) { grid-template-columns: repeat(2, 1fr); } } @media (min-width: 481px) and (max-width: 768px) { #biggestMovers, .performance-cards { grid-template-columns: repeat(2, 1fr); gap: 15px; } } @media (max-width: 480px) { #biggestMovers, .performance-cards { grid-template-columns: 1fr; gap: 12px; } } #metricsGrid .metric-card { width: 100%; min-height: 200px; display: flex; flex-direction: column; justify-content: space-between; }
		
		
		/* === BIGGEST MOVERS MOBILE LAYOUT === */ @media (max-width: 768px) { #biggestMovers, .performance-cards { display: grid; grid-template-columns: 1fr 1fr; /* 2-column grid base */ gap: 15px; margin: 20px 0; width: 100%; } /* First card: Full width (spans both columns) */ #biggestMovers .performance-card:first-child, .performance-cards .performance-card:first-child { grid-column: 1 / -1; /* Span all columns = 100% width */ } /* Cards 2 and 3: 50% width each on second row */ #biggestMovers .performance-card:nth-child(2), #biggestMovers .performance-card:nth-child(3), .performance-cards .performance-card:nth-child(2), .performance-cards .performance-card:nth-child(3) { grid-column: span 1; /* Each takes 1 column = 50% width */ } } /* === LABEL CARDS MOBILE LAYOUT === */ @media (max-width: 768px) { #metricsGrid { display: grid; grid-template-columns: 1fr; /* Single column = 100% width */ gap: 15px; margin-bottom: 40px; width: 100%; } #metricsGrid .metric-card { width: 100%; grid-column: 1; min-height: 180px; } } /* === EXTRA SMALL SCREENS === */ @media (max-width: 480px) { /* Optimize Biggest Movers for tiny screens */ #biggestMovers, .performance-cards { gap: 12px; } /* Optimize Label Cards for tiny screens */ #metricsGrid { gap: 12px; } #metricsGrid .metric-card { min-height: 160px; padding: 18px; } /* Smaller performance cards on tiny screens */ .performance-card { padding: 15px; min-height: 100px; } }
		
		
		/* Biggest Movers: First card 100%, cards 2-3 at 50% each */
@media (max-width: 768px) {
    #biggestMovers {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 15px !important;
        margin: 20px 0 !important;
        width: 100% !important;
    }
    
    /* First card spans both columns (100% width) */
    #biggestMovers .performance-card:first-child {
        grid-column: 1 / -1 !important;
    }
    
    /* Cards 2 and 3 each take 1 column (50% width each) */
    #biggestMovers .performance-card:nth-child(2),
    #biggestMovers .performance-card:nth-child(3) {
        grid-column: span 1 !important;
    }
    
    #biggestMovers .performance-card {
        width: 100% !important;
        min-height: 120px !important;
    }
}

@media (max-width: 480px) {
    #biggestMovers {
        gap: 12px !important;
    }
    
    #biggestMovers .performance-card {
        min-height: 100px !important;
        padding: 15px !important;
    }
}
		
		
		/* === ADVANCED ANALYTICS GRID LAYOUT - CONSOLIDATED === */
.analytics-charts-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

/* Mobile Layout - Single column, all charts full width */
@media (max-width: 768px) {
    .analytics-charts-grid {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
        padding: 0 !important;
    }
    
    /* Force all analytics charts to single column on mobile */
    .analytics-chart-1,
    .analytics-chart-2,
    .analytics-chart-3,
    .analytics-chart-4,
    .analytics-chart-5,
    .analytics-charts-grid .chart-container,
    .analytics-charts-grid .chart-container.full-width {
        grid-column: 1 !important;
        width: 100% !important;
        margin: 0 !important;
    }
    
    /* Mobile chart heights */
    .analytics-chart-1 .chart-wrapper,
    .analytics-chart-2 .chart-wrapper,
    .analytics-chart-3 .chart-wrapper,
    .analytics-chart-4 .chart-wrapper,
    .analytics-chart-5 .chart-wrapper {
        min-height: 300px !important;
        height: auto !important;
    }
    
    /* Mobile chart titles */
    .analytics-charts-grid .chart-title {
        font-size: 1.1rem !important;
        margin-bottom: 10px !important;
        text-align: center !important;
    }
    
    /* Mobile chart containers */
    .analytics-charts-grid .chart-container {
        padding: 15px !important;
        margin-bottom: 0 !important;
    }
}

/* Tablet Layout - 2 columns */
@media (min-width: 769px) and (max-width: 1199px) {
    .analytics-charts-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
    }
    
    .analytics-chart-1 {
        grid-column: 1 / -1;
    }
    
    .analytics-chart-2,
    .analytics-chart-3 {
        grid-column: span 1;
    }
    
    .analytics-chart-4,
    .analytics-chart-5 {
        grid-column: 1 / -1;
    }
}

/* Desktop Layout - Using 3-column grid for flexible width distribution */
@media (min-width: 1200px) {
    .analytics-charts-grid {
        grid-template-columns: 1fr 1fr 1fr;
        grid-template-rows: auto auto auto;
        gap: 25px;
    }
    
    /* Row 1: Card 1 (66%) spans columns 1-2, Card 2 (33%) spans column 3 */
    .analytics-chart-1 {
        grid-column: 1 / 3;
        grid-row: 1;
    }
    
    .analytics-chart-2 {
        grid-column: 3;
        grid-row: 1;
    }
    
    /* Row 2: Card 3 (33%) spans column 1, Card 4 (66%) spans columns 2-3 */
    .analytics-chart-3 {
        grid-column: 1;
        grid-row: 2;
    }
    
    .analytics-chart-4 {
        grid-column: 2 / 4;
        grid-row: 2;
    }
    
    /* Row 3: Card 5 (100% width) spans all columns */
    .analytics-chart-5 {
        grid-column: 1 / -1;
        grid-row: 3;
    }
}

/* Large Desktop Layout - Better spacing */
@media (min-width: 1400px) {
    .analytics-charts-grid {
        gap: 30px;
    }
}

/* Consistent chart heights for desktop */
@media (min-width: 769px) {
    .analytics-chart-1 .chart-wrapper,
    .analytics-chart-2 .chart-wrapper,
    .analytics-chart-3 .chart-wrapper,
    .analytics-chart-4 .chart-wrapper {
        min-height: 320px;
        height: 320px;
    }
    
    .analytics-chart-5 .chart-wrapper {
        min-height: 400px;
        height: 400px;
    }
}

/* Chart title responsive sizing */
.analytics-charts-grid .chart-title {
    font-size: 1.2rem;
    line-height: 1.3;
    margin-bottom: 15px;
    white-space: nowrap;
    overflow: visible;
    text-overflow: clip;
    min-height: 1.5em;
}

@media (min-width: 1200px) and (max-width: 1399px) {
    .analytics-charts-grid .chart-title {
        font-size: 1.1rem;
    }
}

@media (min-width: 1400px) {
    .analytics-charts-grid .chart-title {
        font-size: 1.3rem;
    }
}

/* Container padding adjustments */
@media (min-width: 1200px) {
    .analytics-charts-grid .chart-container {
        padding: 20px;
    }
}

@media (min-width: 1400px) {
    .analytics-charts-grid .chart-container {
        padding: 25px;
    }
}
		
		/* === CHART RESPONSIVENESS FIX === */
/* Ensure all chart canvases are responsive */
canvas {
    max-width: 100% !important;
    height: auto !important;
}

.chart-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
}

.chart-wrapper canvas {
    display: block;
    width: 100% !important;
    height: 100% !important;
}

/* Chart container responsiveness */
.chart-container {
    width: 100%;
    min-width: 0; /* Prevents flex/grid overflow */
    box-sizing: border-box;
}

/* Advanced Analytics specific fixes */
#analytics-tab .chart-container {
    width: 100% !important;
    min-width: 0 !important;
    overflow: hidden;
}

#analytics-tab .chart-wrapper {
    width: 100% !important;
    min-width: 0 !important;
    position: relative;
}
		
		
		.progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}

.progress-overlay.active {
    opacity: 1;
    visibility: visible;
}

.progress-content {
    text-align: center;
    max-width: 400px;
    padding: 40px;
}

.progress-spinner {
    width: 60px;
    height: 60px;
    margin: 0 auto 20px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top-color: #0099ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.progress-message {
    color: #e0e0e0;
    font-size: 1.1rem;
    margin-bottom: 20px;
}

.progress-bar {
    width: 100%;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #0099ff 0%, #00d4ff 100%);
    border-radius: 2px;
    transition: width 0.3s ease;
}

	   
	   
	   /* Desktop layout for Total Market Overview card - 6 equal metrics in 2 rows */
@media (min-width: 769px) {
    /* Override the card's internal structure to create a 3x2 grid */
    #totalMarketCard {
        display: flex !important;
        flex-direction: column !important;
    }
    
    /* Hide the original dividers and sections */
    #totalMarketCard div[style*="border-top: 1px solid"] {
        border-top: none !important;
        padding-top: 0 !important;
        margin-top: 0 !important;
    }
    
    /* Create a 3x2 grid container for all metrics */
    #totalMarketCard .metrics-grid-container {
        display: grid !important;
        grid-template-columns: 1fr 1fr 1fr !important;
        grid-template-rows: 1fr 1fr !important;
        gap: 15px !important;
        margin-top: 20px !important;
    }
    
    /* Style each metric item */
    #totalMarketCard .metric-item {
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 8px !important;
        padding: 12px !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
        text-align: center !important;
        min-height: 70px !important;
    }
    
    /* Metric labels */
    #totalMarketCard .metric-item .metric-label {
        font-size: 0.75rem !important;
        color: #a0a0a0 !important;
        margin-bottom: 4px !important;
        text-transform: uppercase !important;
        letter-spacing: 0.05em !important;
    }
    
    /* Metric values */
    #totalMarketCard .metric-item .metric-value {
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        color: #ffffff !important;
        line-height: 1.2 !important;
    }
    
    /* Change indicators */
    #totalMarketCard .metric-item .metric-change {
        font-size: 0.7rem !important;
        margin-top: 2px !important;
        opacity: 0.8 !important;
    }
}

/* Keep mobile layout unchanged */
@media (max-width: 768px) {
    #totalMarketCard {
        display: flex !important;
        flex-direction: column !important;
    }
}
	   
	@media (max-width: 768px) {
    .button {
        width: 100% !important;
        padding: 12px 20px !important;
        font-size: 0.95rem !important;
        text-align: center !important;
        justify-content: center !important;
        min-height: 48px !important; margin: 10px auto !important;
    }
    
    .button.secondary {
        margin: 10px auto !important;
    }
}

@media (max-width: 480px) {
    .button {
        padding: 14px 20px !important;
        font-size: 1rem !important;
        min-height: 52px !important; margin: 10px auto !important;
    }
}   
	   
	   
	   
	   @media (max-width: 768px) {
    .form-input, .form-textarea {
        width: 100% !important;
        padding: 12px 15px !important;
        font-size: 1rem !important;
        min-height: 48px !important;
        background: rgba(255, 255, 255, 0.1) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        border-radius: 10px !important;
        color: white !important;
    }
    
    .form-textarea {
        min-height: 120px !important;
        resize: vertical !important;
    }
    
    .form-label {
        font-size: 0.9rem !important;
        margin-bottom: 8px !important;
        display: block !important;
    }
    
    .form-group {
        margin-bottom: 20px !important;
    }
}
	   
	   
	   @media (max-width: 768px) {
    /* Stack buttons vertically in control rows */
    .control-row .button + .button {
        margin: 10px auto !important;
    }
    
    /* Make button groups stack nicely */
    .control-row > .button {
        order: 999 !important;
    }
    
    /* Ensure export buttons stack properly */
    .control-row[style*="justify-content: center"] {
        flex-direction: column !important;
    }
    
    /* Success/error messages mobile friendly */
    .success-message, .error-message {
        text-align: center !important;
        padding: 15px !important;
        font-size: 0.9rem !important;
        margin-top: 15px !important;
    }
}
	   
	@media (max-width: 768px) {
    .section-title, h3.section-title {
        font-size: 1.3rem !important;
    }
    
    /* Biggest Movers title specific fix */
    .metric-card h3[style*="font-size: 1.6rem"] {
        font-size: 1.5rem !important;
    }
    
    .metric-card h3[style*="font-size: 1.2rem"] {
        font-size: 1.3rem !important;
    }
}

@media (max-width: 480px) {
    .section-title, h3.section-title {
        font-size: 1.3rem !important;
    }
    
    .metric-card h3[style*="font-size: 1.6rem"] {
        font-size: 1.3rem !important;
    }
    
    .metric-card h3[style*="font-size: 1.2rem"] {
        font-size: 1rem !important;
    }
}

@media (max-width: 375px) {
    .section-title, h3.section-title {
        font-size: 1rem !important;
    }
    
    .metric-card h3 {
        font-size: 0.95rem !important;
    }
}   
	   
@media (max-width: 768px) {
    .metric-label {
        font-size: 0.8rem !important;
    }
    
    .metric-change {
        font-size: 0.8rem !important;
    }
}

@media (max-width: 480px) {
    .metric-label {
        font-size: 0.75rem !important;
    }
    
    .metric-change {
        font-size: 0.75rem !important;
    }
}

@media (max-width: 375px) {
    .metric-label {
        font-size: 0.7rem !important;
    }
    
    .metric-change {
        font-size: 0.7rem !important;
    }
}	   
	 
	   
	   
/* Charts Tab Complete Styles - Full Height, No Scrolling */
.charts-dashboard {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.charts-overview {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 30px;
    border: 1px solid rgba(102, 126, 234, 0.2);
}

.charts-overview h2 {
    font-family: var(--font-serif);
    color: #ffffff;
    font-size: 2rem;
    margin-bottom: 15px;
}

.charts-overview p {
    color: #b0b8c8;
    font-size: 1.1rem;
    line-height: 1.6;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

.analytics-card {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 16px;
    padding: 25px;
    border: 1px solid rgba(102, 126, 234, 0.2);
}

.card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.card-header h3 {
    font-family: var(--font-serif);
    color: #ffffff;
    font-size: 1.3rem;
    margin: 0;
}

.card-icon {
    font-size: 1.5rem;
    margin-right: 10px;
}

.toggle-buttons {
    display: flex;
    gap: 5px;
}

.toggle-btn {
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.1);
    color: #a0a0a0;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.toggle-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #ffffff;
    border-color: transparent;
}

.analytics-content {
    color: #e0e0e0;
}

.analytics-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.analytics-item:last-child {
    border-bottom: none;
}

.rank-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.8rem;
    min-width: 24px;
    text-align: center;
    margin-right: 12px;
}

.item-info {
    flex: 1;
}

.item-title {
    font-weight: 600;
    color: #ffffff;
    font-size: 0.9rem;
    margin-bottom: 2px;
}

.item-artist {
    color: #a0a0a0;
    font-size: 0.8rem;
}

.item-stats {
    font-weight: 600;
    font-size: 0.85rem;
}

.new-badge {
    background: #4ade80;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: bold;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 30px;
}

.chart-section {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 16px;
    padding: 25px;
    border: 1px solid rgba(102, 126, 234, 0.2);
    width: 100%;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    flex-wrap: wrap;
    gap: 15px;
}

.chart-header h3 {
    font-family: var(--font-serif);
    color: #ffffff;
    font-size: 1.5rem;
    margin: 0;
}

.chart-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.chart-select {
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: white;
    font-size: 0.9rem;
    cursor: pointer;
}

/* REMOVED: max-height and overflow restrictions */
.chart-list {
    width: 100%;
    /* Allow full height - no max-height or overflow */
}

.chart-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: background-color 0.3s ease;
}

.chart-item:hover {
    background: rgba(255, 255, 255, 0.05);
}

.item-left {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
}

.rank-display {
    font-family: var(--font-serif);
    font-size: 1.5rem;
    font-weight: bold;
    color: #667eea;
    min-width: 40px;
    text-align: center;
}

.artwork-placeholder {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.track-info {
    flex: 1;
}

.track-title {
    font-weight: 600;
    color: #ffffff;
    font-size: 1rem;
    margin-bottom: 4px;
}

.track-artist {
    color: #a0a0a0;
    font-size: 0.9rem;
    margin-bottom: 2px;
}

.track-label {
    font-size: 0.8rem;
    font-weight: 500;
}

.item-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

.stats-row {
    display: flex;
    gap: 20px;
    align-items: center;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 60px;
}

.stat-label {
    font-size: 0.7rem;
    color: #a0a0a0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 2px;
}

.stat-value {
    font-size: 0.85rem;
    color: #ffffff;
    font-weight: 600;
}

.change-indicator {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
    min-width: 40px;
    text-align: center;
}

.change-indicator.new {
    background: #4ade80;
    color: white;
}

.change-indicator.up {
    background: #4ade80;
    color: white;
}

.change-indicator.down {
    background: #f87171;
    color: white;
}

.change-indicator.same {
    background: rgba(255, 255, 255, 0.1);
    color: #a0a0a0;
}

.no-data {
    text-align: center;
    color: #a0a0a0;
    font-style: italic;
    padding: 20px;
}

.loading-message {
    text-align: center;
    color: #a0a0a0;
    font-style: italic;
    padding: 40px 20px;
    background: rgba(102, 126, 234, 0.05);
    border-radius: 12px;
    margin: 20px 0;
}

/* Charts Navigation */
.charts-nav {
    display: flex;
    gap: 5px;
    margin-bottom: 30px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 8px;
}

.charts-nav-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    color: #a0a0a0;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    border-radius: 8px;
    font-family: var(--font-sans);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.9rem;
    flex: 1;
    text-align: center;
}

.charts-nav-btn:hover {
    color: #ffffff;
    background: rgba(255, 255, 255, 0.1);
}

.charts-nav-btn.active {
    color: #ffffff;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

/* Chart Views */
.chart-view {
    display: none;
}

.chart-view.active {
    display: block;
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Full-width chart sections in individual views */
.chart-view .chart-section {
    max-width: none;
    width: 100%;
}

/* Responsive Charts Styles */
@media (max-width: 768px) {
    .analytics-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .chart-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .chart-controls {
        justify-content: stretch;
    }
    
    .chart-select {
        flex: 1;
    }
    
    .chart-item {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .stats-row {
        gap: 10px;
        overflow-x: auto;
        padding-bottom: 5px;
    }
    
    .stat-item {
        min-width: 50px;
        flex-shrink: 0;
    }
    
    .charts-overview h2 {
        font-size: 1.5rem;
    }
    
    .charts-overview p {
        font-size: 1rem;
    }
    
    .charts-nav {
        flex-direction: column;
        gap: 8px;
    }
    
    .charts-nav-btn {
        padding: 15px 20px;
        font-size: 1rem;
    }
}
	   
	.refresh-btn {
    background: rgba(102, 126, 234, 0.2) !important;
    border: 1px solid rgba(102, 126, 234, 0.3) !important;
    margin-left: auto !important;
}

.refresh-btn:hover {
    background: rgba(102, 126, 234, 0.3) !important;
}   
	   
    </style>
</head>
<body>
    <!-- Progress Overlay -->
    <div id="progressOverlay" class="progress-overlay">
        <div class="progress-container">
            <div class="progress-title">Loading Market Data</div>
            <div class="progress-bar-wrapper">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <div id="progressText" class="progress-text">Initializing...</div>
        </div>
    </div>
	
	

<!-- Fixed Navigation -->
<div class="fixed-nav-container">
    <div class="nav-content">
        <div class="nav-left">
            <div class="tabs">
    <button class="tab active" onclick="switchTab('overview', this)">Overview</button>
    <button class="tab" onclick="switchTab('analytics', this)">Analytics</button>
    <button class="tab" onclick="switchTab('performance', this)">Performance</button>
    <button class="tab" onclick="switchTab('comparison', this)">Compare</button>
    <button class="tab" onclick="switchTab('charts', this)">Charts</button>
    <button class="tab" onclick="switchTab('calculators', this)">Tools</button>
    <button class="tab" onclick="switchTab('export', this)">Reports</button>
    <button class="tab" onclick="switchTab('settings', this)">Settings</button>
</div>
        </div>
        <div class="nav-right">
            <div class="week-selector-nav">
                <label for="weekDropdown">Week:</label>
                <select class="week-dropdown" id="weekDropdown" onchange="selectWeek(this.value)">
                    <!-- Populated dynamically -->
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Header -->
    <div class="mobile-header">
        <div class="hamburger-menu" onclick="toggleMobileDrawer()">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
        </div>
       
    </div>

    <!-- Mobile Drawer Overlay -->
    <div class="mobile-drawer-overlay" onclick="closeMobileDrawer()"></div>

    <!-- Mobile Drawer -->
    <div class="mobile-drawer">
        <div class="drawer-header">
            <div class="drawer-logo">Market Share Tracker</div>
            <div class="drawer-subtitle">Analytics & Performance</div>
        </div>
        
        <div class="drawer-week-selector">
            <span class="drawer-week-label">Select Week</span>
            <select class="drawer-week-select" id="drawerWeekDropdown" onchange="selectWeek(this.value)">
                <!-- Populated dynamically -->
            </select>
        </div>
        
        <nav class="drawer-nav">
            <a href="#" class="drawer-nav-item active" onclick="switchTabDrawer('overview', this)">Overview</a>
            <a href="#" class="drawer-nav-item" onclick="switchTabDrawer('analytics', this)">Advanced Analytics</a>
            <a href="#" class="drawer-nav-item" onclick="switchTabDrawer('performance', this)">Performance Metrics</a>
            <a href="#" class="drawer-nav-item" onclick="switchTabDrawer('comparison', this)">Label Comparison</a>
			<a href="#" class="drawer-nav-item" onclick="switchTabDrawer('charts', this)">Charts</a>
            <a href="#" class="drawer-nav-item" onclick="switchTabDrawer('export', this)">Reports & Export</a>
            <a href="#" class="drawer-nav-item" onclick="switchTabDrawer('settings', this)">Settings & Projections</a>
        </nav>
    </div>    

        <div class="header"><br><br>
            <h1>Market Share Tracker</h1>
            <p>Advanced Analytics & Performance Tracking</p>
        </div>

    

        
        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
 

    <!-- NEW: Top Section with Summary and Total Market Card Side by Side (50/50) -->
    <div class="top-summary-section" style="display: flex; gap: 20px; margin-bottom: 30px;">
        <!-- Weekly Summary Section (50% width) -->
        <div id="weeklySummarySection" class="metric-card" style="flex: 1; background: rgba(102, 126, 234, 0.05); border-color: rgba(102, 126, 234, 0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="font-size: 1.6rem; color: #a0a0a0;">Weekly Market Summary</h3>
                <span id="contextIndicator" style="font-size: 0.8rem; color: #667eea; display: none;">
                    ✨ Context Applied
                </span>
            </div>
            <div id="weeklySummaryText" style="line-height: 1.7; color: #e0e0e0; font-size: 1.05rem;">
                <div class="loading">Analyzing data...</div>
            </div>
        </div>

        <!-- Total Market Card (50% width) -->
        <div id="totalMarketCard" class="metric-card" style="flex: 1; background: rgba(102, 126, 234, 0.1); border-color: rgba(102, 126, 234, 0.2); min-height: 280px;">
            <div class="loading">Loading market data...</div>
        </div>
    </div>

    <!-- Responsive Mobile Layout -->
    <style>
        @media (max-width: 768px) {
            .top-summary-section {
                flex-direction: column !important;
                gap: 15px !important;
            }
            .top-summary-section > div {
                flex: none !important;
            }
        }
		
		
		@media (max-width: 768px) { .comparison-controls { display: flex !important; flex-direction: column !important; align-items: center !important; gap: 15px !important; } #label1Select, #label2Select { min-width: auto !important; width: 100% !important; max-width: 280px !important; padding: 12px 15px !important; font-size: 0.9rem !important; } .vs-text { font-size: 1rem !important; padding: 8px 16px !important; background: rgba(102, 126, 234, 0.2) !important; border-radius: 6px !important; color: #667eea !important; } } @media (max-width: 480px) { #label1Select, #label2Select { max-width: none !important; width: calc(100% - 20px) !important; margin: 0 10px !important; } }
		
		
		/* Performance cards 50% width on mobile */
@media (max-width: 768px) {
    .performance-cards, #performanceCards, #biggestMovers {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important; /* 2 columns = 50% each */
        gap: 15px !important;
        margin: 20px 0 !important;
        width: 100% !important;
    }
    
    .performance-card {
        width: 100% !important;
        min-height: 120px !important;
        grid-column: span 1 !important; /* Each card takes 1 column */
    }
}
		
		
/* === ADVANCED ANALYTICS GRID LAYOUT - CONSOLIDATED === */
.analytics-charts-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

/* Mobile Layout - Single column, all charts full width */
@media (max-width: 768px) {
    .analytics-charts-grid {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
        padding: 0 !important;
    }
    
    /* Force all analytics charts to single column on mobile */
    .analytics-chart-1,
    .analytics-chart-2,
    .analytics-chart-3,
    .analytics-chart-4,
    .analytics-chart-5,
    .analytics-charts-grid .chart-container,
    .analytics-charts-grid .chart-container.full-width {
        grid-column: 1 !important;
        width: 100% !important;
        margin: 0 !important;
    }
    
    /* Mobile chart heights */
    .analytics-chart-1 .chart-wrapper,
    .analytics-chart-2 .chart-wrapper,
    .analytics-chart-3 .chart-wrapper,
    .analytics-chart-4 .chart-wrapper,
    .analytics-chart-5 .chart-wrapper {
        min-height: 300px !important;
        height: auto !important;
    }
    
    /* Mobile chart titles */
    .analytics-charts-grid .chart-title {
        font-size: 1.1rem !important;
        margin-bottom: 10px !important;
        text-align: center !important;
    }
    
    /* Mobile chart containers */
    .analytics-charts-grid .chart-container {
        padding: 15px !important;
        margin-bottom: 0 !important;
    }
}

/* Tablet Layout - 2 columns */
@media (min-width: 769px) and (max-width: 1199px) {
    .analytics-charts-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
    }
    
    .analytics-chart-1 {
        grid-column: 1 / -1;
    }
    
    .analytics-chart-2,
    .analytics-chart-3 {
        grid-column: span 1;
    }
    
    .analytics-chart-4,
    .analytics-chart-5 {
        grid-column: 1 / -1;
    }
}

/* Desktop Layout - Using 3-column grid for flexible width distribution */
@media (min-width: 1200px) {
    .analytics-charts-grid {
        grid-template-columns: 1fr 1fr 1fr;
        grid-template-rows: auto auto auto;
        gap: 25px;
    }
    
    /* Row 1: Card 1 (66%) spans columns 1-2, Card 2 (33%) spans column 3 */
    .analytics-chart-1 {
        grid-column: 1 / 3;
        grid-row: 1;
    }
    
    .analytics-chart-2 {
        grid-column: 3;
        grid-row: 1;
    }
    
    /* Row 2: Card 3 (33%) spans column 1, Card 4 (66%) spans columns 2-3 */
    .analytics-chart-3 {
        grid-column: 1;
        grid-row: 2;
    }
    
    .analytics-chart-4 {
        grid-column: 2 / 4;
        grid-row: 2;
    }
    
    /* Row 3: Card 5 (100% width) spans all columns */
    .analytics-chart-5 {
        grid-column: 1 / -1;
        grid-row: 3;
    }
}

/* Large Desktop Layout - Better spacing */
@media (min-width: 1400px) {
    .analytics-charts-grid {
        gap: 30px;
    }
}

/* Consistent chart heights for desktop */
@media (min-width: 769px) {
    .analytics-chart-1 .chart-wrapper,
    .analytics-chart-2 .chart-wrapper,
    .analytics-chart-3 .chart-wrapper,
    .analytics-chart-4 .chart-wrapper {
        min-height: 320px;
        height: 320px;
    }
    
    .analytics-chart-5 .chart-wrapper {
        min-height: 400px;
        height: 400px;
    }
}

/* Chart title responsive sizing */
.analytics-charts-grid .chart-title {
    font-size: 1.2rem;
    line-height: 1.3;
    margin-bottom: 15px;
    white-space: nowrap;
    overflow: visible;
    text-overflow: clip;
    min-height: 1.5em;
}

@media (min-width: 1200px) and (max-width: 1399px) {
    .analytics-charts-grid .chart-title {
        font-size: 1.1rem;
    }
}

@media (min-width: 1400px) {
    .analytics-charts-grid .chart-title {
        font-size: 1.3rem;
    }
}

/* Container padding adjustments */
@media (min-width: 1200px) {
    .analytics-charts-grid .chart-container {
        padding: 20px;
    }
}

@media (min-width: 1400px) {
    .analytics-charts-grid .chart-container {
        padding: 25px;
    }
}	
		
	/* === LABEL COMPARISON CARDS MOBILE LAYOUT === */
@media (max-width: 768px) {
    /* Override general performance-cards behavior for comparison cards specifically */
    #comparisonCards.performance-cards {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important; /* 50% 50% base */
        gap: 15px !important;
        margin: 20px 0 !important;
        width: 100% !important;
    }
    
    /* Row 1: Label 1 card (50%) and Label 2 card (50%) */
    #comparisonCards .performance-card:nth-child(1) {
        grid-column: 1 !important; /* First column (50%) */
        order: 1 !important;
    }
    
    #comparisonCards .performance-card:nth-child(3) {
        grid-column: 2 !important; /* Second column (50%) */
        order: 2 !important;
    }
    
    /* Row 2: Comparison card (100% width) - it's the 2nd child */
    #comparisonCards .performance-card:nth-child(2) {
        grid-column: 1 / -1 !important; /* Spans both columns (100%) */
        order: 3 !important; /* Forces it to appear last */
    }
    
    /* Ensure all comparison cards have consistent styling */
    #comparisonCards .performance-card {
        width: 100% !important;
        min-height: 120px !important;
    }
}

/* Extra small screens optimization */
@media (max-width: 480px) {
    #comparisonCards.performance-cards {
        gap: 12px !important;
    }
    
    #comparisonCards .performance-card {
        min-height: 100px !important;
        padding: 15px !important;
    }
}
	
	/* Smooth scroll behavior when fixed header is present */
@media (max-width: 768px) {
    html {
        scroll-behavior: smooth;
        scroll-padding-top: 70px; /* Same as body padding-top */
    }
}	
		
		
		/* Stream Calculators Mobile Responsive */
@media (max-width: 768px) {
    .chart-container > div[style*="grid-template-columns: 1fr 1fr"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 20px !important;
    }
    
    .chart-container > div[style*="grid-template-columns: repeat(auto-fit"] {
        grid-template-columns: 1fr !important;
    }
}
		
		
		
		/* Fixed Navigation Styles */
.fixed-nav-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: rgba(26, 26, 46, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(102, 126, 234, 0.3);
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
}

.nav-content {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    height: 70px;
}

.nav-left {
    display: flex;
    align-items: center;
    gap: 30px;
}

.nav-logo {
    font-family: 'ivypresto-headline', Georgia, 'Times New Roman', serif;
    font-size: 1.5rem;
    font-weight: 400;
    color: #667eea;
    text-decoration: none;
}

.tabs {
    display: flex;
    gap: 5px;
    align-items: center;
    height: 100%;
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    border-bottom: none;
    border-radius: 0;
}

.nav-right {
    display: flex;
    align-items: center;
    gap: 20px;
}

.week-selector-nav {
    display: flex;
    align-items: center;
    gap: 10px;
}

.week-selector-nav label {
    font-size: 0.9rem;
    color: #a0a0a0;
    font-weight: 500;
}

.week-dropdown {
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: white;
    font-size: 0.9rem;
    min-width: 120px;
    cursor: pointer;
}

/* Update existing tab styles for fixed nav */
.tab {
    padding: 8px 16px;
    background: none;
    border: none;
    color: #a0a0a0;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    position: relative;
    font-family: 'pragmatica-extended', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.85rem;
    border-radius: 6px;
}

.tab:hover {
    color: #ffffff;
    background: rgba(255, 255, 255, 0.1);
}

.tab.active {
    color: #ffffff;
    background: rgba(102, 126, 234, 0.3);
}

.tab.active::after {
    display: none;
}

/* Update body padding to account for fixed nav */
body {
    padding-top: 70px;
}

.container {
    padding-top: 20px;
}

/* Mobile Header Bar */
.mobile-header {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: rgba(26, 26, 46, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(102, 126, 234, 0.3);
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    z-index: 1001;
    padding: 0 15px;
    align-items: center;
    justify-content: space-between;
}

.hamburger-menu {
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    transition: transform 0.3s ease;
}

.hamburger-line {
    width: 100%;
    height: 2px;
    background: #ffffff;
    border-radius: 2px;
    transition: all 0.3s ease;
    transform-origin: center;
}

.hamburger-menu.active .hamburger-line:nth-child(1) {
    transform: rotate(45deg) translateY(7px);
}

.hamburger-menu.active .hamburger-line:nth-child(2) {
    opacity: 0;
}

.hamburger-menu.active .hamburger-line:nth-child(3) {
    transform: rotate(-45deg) translateY(-7px);
}

.mobile-header-logo {
    font-family: 'ivypresto-headline', Georgia, 'Times New Roman', serif;
    font-size: 1.3rem;
    font-weight: 400;
    color: #667eea;
    text-decoration: none;
    flex-shrink: 0;
    white-space: nowrap;
}

.mobile-header-week {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: #a0a0a0;
}

.mobile-header-week select {
    padding: 4px 8px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    color: white;
    font-size: 0.8rem;
    min-width: 80px;
}

/* Mobile Drawer Overlay */
.mobile-drawer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.mobile-drawer-overlay.active {
    opacity: 1;
    visibility: visible;
}

/* Mobile Drawer */
.mobile-drawer {
    position: fixed;
    top: 0;
    left: -300px;
    width: 300px;
    height: 100vh;
    background: rgba(26, 26, 46, 0.98);
    backdrop-filter: blur(20px);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1002;
    transition: left 0.3s ease;
    overflow-y: auto;
    padding: 80px 0 20px 0;
}

.mobile-drawer.active {
    left: 0;
}

.drawer-header {
    padding: 0 20px 30px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 30px;
}

.drawer-logo {
    font-family: 'ivypresto-headline', Georgia, 'Times New Roman', serif;
    font-size: 1.5rem;
    font-weight: 400;
    color: #667eea;
    margin-bottom: 8px;
}

.drawer-subtitle {
    font-size: 0.9rem;
    color: #a0a0a0;
}

.drawer-week-selector {
    padding: 0 20px 20px;
    margin-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.drawer-week-label {
    display: block;
    font-size: 0.8rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 10px;
    font-weight: 600;
}

.drawer-week-select {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: white;
    font-size: 0.9rem;
    cursor: pointer;
}

.drawer-nav {
    padding: 0 20px;
}

.drawer-nav-item {
    display: block;
    padding: 15px 0;
    color: #a0a0a0;
    text-decoration: none;
    font-size: 1rem;
    font-weight: 500;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
    cursor: pointer;
    text-align: left;
    background: none;
    border-left: none;
    border-right: none;
    border-top: none;
    width: 100%;
    font-family: 'pragmatica-extended', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

.drawer-nav-item:hover {
    color: #ffffff;
    padding-left: 10px;
}

.drawer-nav-item.active {
    color: #667eea;
    border-left: 3px solid #667eea;
    padding-left: 17px;
    background: rgba(102, 126, 234, 0.1);
}

.drawer-nav-item:last-child {
    border-bottom: none;
}

/* Hide desktop nav on mobile, show mobile header */
@media (max-width: 768px) {
    .fixed-nav-container {
        display: none;
    }
    
    .mobile-header {
        display: flex;
    }
    
    body {
        padding-top: 120px !important;
    }
    
    .header {
        padding-top: 10px !important;
        margin-top: 0 !important;
    }
}

/* Hide mobile elements on desktop */
@media (min-width: 769px) {
    .mobile-header,
    .mobile-drawer,
    .mobile-drawer-overlay {
        display: none !important;
    }
}
		
		
		@media (max-width: 480px) {
    .metric-value {
        font-size: 1.5rem !important;
    }
    
    .metric-label {
        font-size: 0.8rem !important;
    }
    
    .metric-change {
        font-size: 0.8rem !important;
    }
    
    .header h1 {
        font-size: 1.8rem !important;
    }
    
    .header p {
        font-size: 0.9rem !important;
    }
			
			 .performance-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0; font-size: 0.8rem !important;
        }
}
		
    </style>

    <!-- Alerts Section -->
    <div id="alertsSection" class="alert-section" style="display: none;">
        <h3 class="alert-title">⚠️ Significant Changes Detected</h3>
        <div id="alertsList"></div>
    </div>

    <!-- Biggest Movers -->
    <div class="metric-card" style="grid-column: 1 / -1; margin-bottom: 30px;">
        <h3 style="margin-bottom: 20px; font-size: 1.6rem;">📈 Biggest Movers This Week</h3>
        <div id="biggestMovers" class="performance-cards"></div>
    </div>

    <!-- Individual Label Cards Grid -->
    <div class="metrics-grid" id="metricsGrid">
        <div class="loading">Loading data...</div>
    </div>

    <!-- Stream Graph -->
    <div class="chart-container full-width" style="margin-bottom: 30px; background: rgba(255, 255, 255, 0.03);">
        <h3 class="chart-title">Week-over-Week Volume Changes</h3>
        <p style="text-align: center; font-size: 0.85rem; color: #888; margin-top: -10px; margin-bottom: 15px;">
            Weekly gains and losses by label showing market momentum • Click any week to view details
        </p>
        <div id="streamChartPlaceholder" style="display: block; text-align: center; padding: 80px 20px; color: #888; background: rgba(102, 126, 234, 0.05); border-radius: 15px; margin: 20px;">
            <p style="font-size: 1.1rem; margin-bottom: 10px;">📊 Insufficient data for trend analysis</p>
            <p style="font-size: 0.9rem;">This chart requires at least 8 weeks of data</p>
            <p id="streamChartProgress" style="font-size: 0.85rem; color: #667eea; margin-top: 15px;">Loading data...</p>
        </div>
        <div id="streamChartWrapper" class="chart-wrapper" style="display: none;">
            <canvas id="streamChart"></canvas>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <h3 class="chart-title">Market Share Distribution</h3>
            <div class="chart-wrapper">
                <canvas id="pieChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Week-over-Week Changes</h3>
            <div class="chart-wrapper">
                <canvas id="barChart"></canvas>
            </div>
        </div>
		
    </div>
</div>

       <!-- Advanced Analytics Tab -->
<div id="analytics-tab" class="tab-content">
    <div class="analytics-charts-grid">
        <!-- First Position: Week-over-Week Volume Changes -->
        <div class="chart-container analytics-chart-1">
            <h3 class="chart-title">Week-over-Week Volume Changes</h3>
            <p style="text-align: center; font-size: 0.85rem; color: #888; margin-top: -10px; margin-bottom: 15px;">
                Weekly gains and losses by label showing market momentum • All 6 labels (excluding Total Others)
            </p>
            <div id="analyticsStreamChartPlaceholder" style="display: block; text-align: center; padding: 40px 20px; color: #888; background: rgba(102, 126, 234, 0.05); border-radius: 15px;">
                <p style="font-size: 1rem; margin-bottom: 10px;">📊 Insufficient data for trend analysis</p>
                <p style="font-size: 0.85rem;">This chart requires at least 8 weeks of data</p>
            </div>
            <div id="analyticsStreamChartWrapper" class="chart-wrapper" style="display: none;">
                <canvas id="analyticsStreamChart"></canvas>
            </div>
        </div>

        <!-- Second Position: Streams vs Albums Correlation -->
        <div class="chart-container analytics-chart-2">
            <h3 class="chart-title">Streams vs Albums Correlation</h3>
            <p style="text-align: center; font-size: 0.85rem; color: #888; margin-top: -10px; margin-bottom: 15px;">
                Comparing streaming performance to album sales (including Track Equivalent Albums)
            </p>
            <div class="chart-wrapper">
                <canvas id="correlationChart"></canvas>
            </div>
        </div>

        <!-- Third Position: Market Share Volatility -->
        <div class="chart-container analytics-chart-3">
            <h3 class="chart-title">Market Share Volatility</h3>
            <div class="chart-wrapper">
                <canvas id="volatilityChart"></canvas>
            </div>
        </div>

        <!-- Fourth Position: Market Share Trends Over Time -->
        <div class="chart-container analytics-chart-4">
            <h3 class="chart-title">Market Share Trends Over Time</h3>
            <div class="chart-wrapper">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Fifth Position: Predictive Trend Analysis -->
        <div class="chart-container analytics-chart-5">
            <h3 class="chart-title">Predictive Trend Analysis (Linear Regression)</h3>
            <div class="chart-wrapper">
                <canvas id="predictiveChart"></canvas>
            </div>
        </div>
    </div>
</div>
        

        <!-- Performance Metrics Tab -->
        <div id="performance-tab" class="tab-content">
            <div class="performance-cards" id="performanceCards"></div>
            
            <div class="chart-container" style="margin-top: 30px;">
                <h3 class="chart-title">Performance Rankings</h3>
                
                <!-- Desktop Table View -->
                <div class="desktop-rankings">
                    <div class="table-wrapper">
                        <table class="ranking-table" id="rankingTable">
                            <thead>
                                <tr>
                                    <th class="sortable" onclick="sortTable(0)">Rank</th>
                                    <th class="sortable" onclick="sortTable(1)">Label</th>
                                    <th class="sortable" onclick="sortTable(2)">Market Share %</th>
                                    <th class="sortable" onclick="sortTable(3)">Weekly Units</th>
                                    <th class="sortable" onclick="sortTable(4)">Total YTD Units</th>
                                    <th class="sortable" onclick="sortTable(5)">Albums (w/TEA)</th>
                                    <th class="sortable" onclick="sortTable(6)">Streams</th>
                                    <th class="sortable" onclick="sortTable(7)">Growth Rate</th>
                                    <th class="sortable" onclick="sortTable(8)">Volatility</th>
                                </tr>
                            </thead>
                            <tbody id="rankingTableBody">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Mobile Card View -->
                <div class="mobile-rankings" id="mobileRankings">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Label Comparison Tab -->
<div id="comparison-tab" class="tab-content">
    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; margin-bottom: 30px; text-align: center;">
        <div class="control-group comparison-controls" style="display: inline-flex; align-items: center; gap: 10px;">
            <label style="font-weight: 600; color: #a0a0a0;">Compare Labels:</label>
            <select id="label1Select" style="min-width: 150px;">
                <option value="Provident">Provident</option>
                <option value="CCMG">CCMG</option>
                <option value="ADA">ADA</option>
                <option value="THE ORCHARD">THE ORCHARD</option>
                <option value="Fair Trade">Fair Trade</option>
                <option value="WORD/CURB">WORD/CURB</option>
            </select>
            <span class="vs-text" style="font-weight: 600; color: #666;">vs</span>
            <select id="label2Select" style="min-width: 150px;">
                <option value="CCMG">CCMG</option>
                <option value="Provident">Provident</option>
                <option value="ADA">ADA</option>
                <option value="THE ORCHARD">THE ORCHARD</option>
                <option value="Fair Trade">Fair Trade</option>
                <option value="WORD/CURB">WORD/CURB</option>
            </select>
        </div>
    </div>
    
    <div id="comparisonCards" class="performance-cards"></div>
    
    <div class="charts-grid">
        <div class="chart-container">
            <h3 class="chart-title" id="comparisonChartTitle">Label Comparison - Units</h3>
            <div class="chart-wrapper">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Week-over-Week Change Comparison</h3>
            <div class="chart-wrapper">
                <canvas id="headToHeadChart"></canvas>
            </div>
        </div>
    </div>

    <!-- NEW: Week-over-Week Volume Changes Chart -->
    <div class="chart-container full-width" style="margin-top: 30px;">
        <h3 class="chart-title" id="comparisonVolumeChangesTitle">Week-over-Week Volume Changes Comparison</h3>
        <p style="text-align: center; font-size: 0.85rem; color: #888; margin-top: -10px; margin-bottom: 15px;">
            Weekly gains and losses comparison showing market momentum between selected labels
        </p>
        <div id="comparisonVolumeChangesPlaceholder" style="display: block; text-align: center; padding: 40px 20px; color: #888; background: rgba(102, 126, 234, 0.05); border-radius: 15px;">
            <p style="font-size: 1rem; margin-bottom: 10px;">📊 Insufficient data for trend analysis</p>
            <p style="font-size: 0.85rem;">This chart requires at least 2 weeks of data</p>
        </div>
        <div id="comparisonVolumeChangesWrapper" class="chart-wrapper" style="display: none;">
            <canvas id="comparisonVolumeChangesChart"></canvas>
        </div>
    </div>
</div>
	
	
	<!-- Charts Tab -->
<div id="charts-tab" class="tab-content">
    <div class="charts-dashboard">
        <!-- Charts Navigation -->
       <!-- Updated Charts Navigation with Refresh Button -->
<div class="charts-nav">
    <button class="charts-nav-btn active" onclick="switchChartsView('summary', this)">Chart Summary</button>
    <button class="charts-nav-btn" onclick="switchChartsView('songs', this)">Songs Chart</button>
    <button class="charts-nav-btn" onclick="switchChartsView('albums', this)">Albums Chart</button>
    <button class="charts-nav-btn refresh-btn" onclick="refreshChartsData()" title="Refresh charts data">↻ Refresh</button>
</div>

        <!-- Chart Summary View -->
        <div id="chartSummaryView" class="chart-view active">
            <div class="charts-overview">
                <h2>Chart Summary Insights</h2>
                <p>Analyzing chart data to generate comprehensive insights...</p>
            </div>

            <!-- Analytics Cards - ONLY IN SUMMARY VIEW -->
            <div class="analytics-grid">
                <!-- Top 5 Card -->
                <div class="analytics-card">
                    <div class="card-header">
                        <span class="card-icon">♪</span>
                        <h3>Top 5</h3>
                        <div class="toggle-buttons">
                            <button class="toggle-btn active" onclick="toggleAnalytics('top5', 'songs')">Songs</button>
                            <button class="toggle-btn" onclick="toggleAnalytics('top5', 'albums')">Albums</button>
                        </div>
                    </div>
                    <div id="top5-songs" class="analytics-content">
                        <!-- Content populated by JavaScript -->
                    </div>
                    <div id="top5-albums" class="analytics-content" style="display: none;">
                        <!-- Content populated by JavaScript -->
                    </div>
                </div>

                <!-- Biggest Movers Card -->
                <div class="analytics-card">
                    <div class="card-header">
                        <span class="card-icon">↗</span>
                        <h3>Biggest Movers</h3>
                        <div class="toggle-buttons">
                            <button class="toggle-btn active" onclick="toggleAnalytics('movers', 'songs')">Songs</button>
                            <button class="toggle-btn" onclick="toggleAnalytics('movers', 'albums')">Albums</button>
                        </div>
                    </div>
                    <div id="movers-songs" class="analytics-content">
                        <!-- Content populated by JavaScript -->
                    </div>
                    <div id="movers-albums" class="analytics-content" style="display: none;">
                        <!-- Content populated by JavaScript -->
                    </div>
                </div>

                <!-- New Entries Card -->
                <div class="analytics-card">
                    <div class="card-header">
                        <span class="card-icon">★</span>
                        <h3>New Entries</h3>
                        <div class="toggle-buttons">
                            <button class="toggle-btn active" onclick="toggleAnalytics('new', 'songs')">Songs</button>
                            <button class="toggle-btn" onclick="toggleAnalytics('new', 'albums')">Albums</button>
                        </div>
                    </div>
                    <div id="new-songs" class="analytics-content">
                        <!-- Content populated by JavaScript -->
                    </div>
                    <div id="new-albums" class="analytics-content" style="display: none;">
                        <!-- Content populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Songs Chart View -->
        <div id="songsChartView" class="chart-view">
            <div class="charts-overview">
                <h2>Songs Chart Insights</h2>
                <p>Analyzing songs chart data to generate insights...</p>
            </div>

            <div class="chart-section">
                <div class="chart-header">
                    <h3>Songs Chart</h3>
                    <div class="chart-controls">
                        <select id="weekSelectorSongs" class="chart-select">
                            <option value="current">Week 26</option>
                        </select>
                        <select id="songFilter" class="chart-select" onchange="filterSongs(this.value)">
                            <option value="all">All Songs</option>
                            <option value="fresh">Fresh Tracks</option>
                            <option value="new">New Entries</option>
                            <option value="increases">Increases</option>
                            <option value="decreases">Decreases</option>
                        </select>
                    </div>
                </div>
                <div id="songsChartContainer" class="chart-list">
                    <!-- Songs list populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Albums Chart View -->
        <div id="albumsChartView" class="chart-view">
            <div class="charts-overview">
                <h2>Albums Chart Insights</h2>
                <p>Analyzing albums chart data to generate insights...</p>
            </div>

            <div class="chart-section">
                <div class="chart-header">
                    <h3>Albums Chart</h3>
                    <div class="chart-controls">
                        <select id="weekSelectorAlbums" class="chart-select">
                            <option value="current">Week 26</option>
                        </select>
                        <select id="albumFilter" class="chart-select" onchange="filterAlbums(this.value)">
                            <option value="all">All Albums</option>
                            <option value="new">New Entries</option>
                            <option value="increases">Increases</option>
                            <option value="decreases">Decreases</option>
                        </select>
                    </div>
                </div>
                <div id="albumsChartContainer" class="chart-list">
                    <!-- Albums list populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- Reports & Export Tab -->
        <div id="export-tab" class="tab-content">
            <div class="metric-card" style="max-width: 800px; margin: 0 auto;">
                <h3 style="margin-bottom: 20px;">Weekly Summary Report</h3>
                <div id="weeklySummary" style="line-height: 1.8;">
                    <!-- Populated dynamically -->
                </div>
                <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                    <button class="button" onclick="downloadWeeklySummary()">Download Summary</button>
                    <button class="button secondary" onclick="emailWeeklySummary()">Email Summary</button>
                </div>
            </div>
        </div>

       <!-- Calculators Tab -->
<div id="calculators-tab" class="tab-content">
    <h2 style="text-align: center; margin-bottom: 30px; font-size: 1.8rem;">Stream Calculators</h2>
    <p style="font-size: 0.95rem; color: #888; margin-bottom: 35px; text-align: center; max-width: 800px; margin-left: auto; margin-right: auto;">
        Convert streaming numbers to units and revenue estimates using industry-standard ratios. These calculators help you quickly understand the value and impact of streaming performance.
    </p>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; max-width: 1200px; margin-left: auto; margin-right: auto;">
        <!-- Streams to Units Calculator -->
        <div style="background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1);">
            <h4 style="margin-bottom: 20px; color: #667eea;">🎵 Streams to Units</h4>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">Stream Count</label>
                <input type="number" id="streamsToUnitsInput" 
                    style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); 
                           border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                           color: white; font-size: 0.95rem;"
                    placeholder="Enter number of streams"
                    oninput="calculateStreamsToUnits()">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">Conversion Ratio</label>
                <select id="streamRatioSelect" 
                    style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); 
                           border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                           color: white; font-size: 0.95rem;"
                    onchange="calculateStreamsToUnits()">
                    <option value="1500">1,500 streams = 1 unit (Standard)</option>
                    <option value="1250">1,250 streams = 1 unit (Premium)</option>
                    <option value="2000">2,000 streams = 1 unit (Conservative)</option>
                    <option value="custom">Custom Ratio</option>
                </select>
            </div>
            
            <div id="customRatioDiv" style="margin-bottom: 15px; display: none;">
                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">Custom Streams per Unit</label>
                <input type="number" id="customRatioInput" 
                    style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); 
                           border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                           color: white; font-size: 0.95rem;"
                    placeholder="Enter custom ratio"
                    oninput="calculateStreamsToUnits()">
            </div>
            
            <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 0.9rem; color: #a0a0a0; margin-bottom: 5px;">Equivalent Units</div>
                <div id="unitsResult" style="font-size: 1.8rem; font-weight: 600; color: #667eea;">0</div>
            </div>
        </div>
        
        <!-- Streams to Revenue Calculator -->
        <div style="background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1);">
            <h4 style="margin-bottom: 20px; color: #28a745;">💰 Streams to Revenue</h4>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">Stream Count</label>
                <input type="number" id="streamsToRevenueInput" 
                    style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); 
                           border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                           color: white; font-size: 0.95rem;"
                    placeholder="Enter number of streams"
                    oninput="calculateStreamsToRevenue()">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">Platform/Rate</label>
                <select id="revenueRateSelect" 
                    style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); 
                           border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                           color: white; font-size: 0.95rem;"
                    onchange="calculateStreamsToRevenue()">
                    <option value="0.004">Spotify ($0.004/stream)</option>
                    <option value="0.0064">Apple Music ($0.0064/stream)</option>
                    <option value="0.0025">YouTube Music ($0.0025/stream)</option>
                    <option value="0.0038">Amazon Music ($0.0038/stream)</option>
                    <option value="0.0035">Industry Average ($0.0035/stream)</option>
                    <option value="custom">Custom Rate</option>
                </select>
            </div>
            
            <div id="customRevenueDiv" style="margin-bottom: 15px; display: none;">
                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">Custom Rate per Stream ($)</label>
                <input type="number" id="customRevenueInput" step="0.0001"
                    style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); 
                           border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                           color: white; font-size: 0.95rem;"
                    placeholder="Enter rate (e.g., 0.0035)"
                    oninput="calculateStreamsToRevenue()">
            </div>
            
            <div style="background: rgba(40, 167, 69, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 0.9rem; color: #a0a0a0; margin-bottom: 5px;">Estimated Revenue</div>
                <div id="revenueResult" style="font-size: 1.8rem; font-weight: 600; color: #28a745;">$0.00</div>
            </div>
        </div>
    </div>
    
    <!-- Quick Reference Table -->
    <div style="background: rgba(255, 255, 255, 0.03); padding: 20px; border-radius: 15px; margin-top: 20px; max-width: 1200px; margin-left: auto; margin-right: auto;">
        <h4 style="margin-bottom: 15px; color: #a0a0a0;">📊 Quick Reference</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 0.85rem;">
            <div>
                <strong style="color: #667eea;">Units Conversion:</strong><br>
                • 1,500 streams = 1 album unit<br>
                • 10 track sales = 1 album unit<br>
                • 1 album sale = 1 album unit
            </div>
            <div>
                <strong style="color: #28a745;">Revenue Rates:</strong><br>
                • Spotify: $0.003-$0.005/stream<br>
                • Apple Music: $0.006-$0.007/stream<br>
                • YouTube: $0.002-$0.003/stream
            </div>
            <div>
                <strong style="color: #ffc107;">Industry Standards:</strong><br>
                • 1M streams ≈ 667 album units<br>
                • 1M streams ≈ $3,500 revenue<br>
                • Varies by country/platform
            </div>
        </div>
    </div>
</div>
                
               
		
        
       <!-- Control Section (moved to bottom) -->
<div class="control-section" style="margin-top: 40px;">
    <div class="control-row">
        <div class="control-group">
            <button id="refreshButton" class="button">
                Refresh Data
            </button>
            <p id="dataStatus" style="margin-left: 15px;margin:auto;"></p>
        </div>
        <div class="control-group">
            <button class="button secondary" onclick="exportToCSV()">Export CSV</button>
            <button class="button secondary" onclick="generatePDFReport()">Generate Report</button>
            <button class="button secondary" onclick="window.print()">Print View</button>
            <button class="button secondary" onclick="toggleSettings()" id="settingsToggleBtn">
                Settings & Projections
            </button>
        </div>
    </div>
    <div class="control-row">
        <p style="font-size: 0.85rem; color: #888; text-align: center; width: 100%;">
            Auto-refresh every 30 minutes | Last updated: <span id="lastUpdateTime">-</span><br>
            <span style="font-size: 0.8rem;">To add new data: Convert Excel files to CSV format and upload to your Google Drive folder</span>
        </p>
    </div>
</div>

<!-- Settings & Projections Section (Collapsible) -->
<div id="settings-section" style="display: none; margin-top: 20px;">
    <div class="control-section">
        <h3 style="margin-bottom: 20px; text-align: center; font-size: 1.3rem;">Settings & Projections</h3>
        
        <!-- Cache Management -->
        <div class="setting-item" style="margin-bottom: 20px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
            <div>
                <h4>Cache Management</h4>
                <p>Clear cached data to force fresh download</p>
            </div>
            <button onclick="clearCacheAndReload()" class="clear-cache-btn" 
                    style="padding: 8px 16px; border: 1px solid #667eea; border-radius: 6px; background: transparent; color: #667eea; cursor: pointer;">
                Clear Cache
            </button>
        </div>
        
        <!-- Password Protection -->
        <div id="settingsLogin" style="display: block;">
            <div class="metric-card" style="max-width: 500px; margin: 50px auto; text-align: center;">
                <h3 style="margin-bottom: 30px; font-size: 1.3rem;">Settings & Projections Access</h3>
                <p style="color: #a0a0a0; margin-bottom: 30px;">This section is password protected</p>
                
                <div id="passwordError" style="color: #f87171; margin-bottom: 20px; display: none;">
                    Incorrect password. Please try again.
                </div>
                
                <div style="margin-bottom: 20px;">
                    <input type="password" id="settingsPassword" 
                        style="width: 100%; max-width: 300px; padding: 12px 20px; 
                               background: rgba(255, 255, 255, 0.1); 
                               border: 1px solid rgba(255, 255, 255, 0.2); 
                               border-radius: 25px; color: white; 
                               font-size: 1rem; text-align: center;"
                        placeholder="Enter password"
                        onkeypress="if(event.keyCode===13) checkSettingsPassword()">
                </div>
                
                <button class="button" onclick="checkSettingsPassword()">Access Settings</button>
                
                <p style="font-size: 0.8rem; color: #666; margin-top: 30px;">
                    First time? Use default password: <code style="background: rgba(255, 255, 255, 0.1); padding: 2px 8px; border-radius: 4px; font-family: 'Courier New', monospace;">admin</code>
                </p>
            </div>
        </div>
    
		
		<!-- Settings Content (hidden by default) -->
<div id="settingsContent" style="display: none;">
    <!-- Password Management -->
    <div style="display: flex; justify-content: flex-end; gap: 15px; margin-bottom: 20px;">
        <button class="button secondary" onclick="showChangePassword()">Change Password</button>
        <button class="button secondary" onclick="logoutSettings()">Lock Settings</button>
    </div>
    
    <!-- Settings Grid -->
    <div class="charts-grid">
        <!-- Market Summary Context Manager -->
        <div class="chart-container">
            <h3 class="chart-title">
                Market Summary Context Manager
                <span id="totalContextCount" style="font-size: 0.8rem; color: #667eea; margin-left: 10px;"></span>
            </h3>
            <p style="font-size: 0.85rem; color: #888; margin-bottom: 20px;">
                Add unique context for individual weeks or apply context to multiple weeks
            </p>
            
            <!-- Context Mode Selection -->
            <div style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; 
                        background: rgba(255, 255, 255, 0.03); border-radius: 10px; 
                        border: 1px solid rgba(255, 255, 255, 0.1);">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="contextMode" value="individual" checked
                           onchange="switchContextMode('individual')"
                           style="cursor: pointer;">
                    <span style="font-weight: 500;">Individual Week Context</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="contextMode" value="multiple"
                           onchange="switchContextMode('multiple')"
                           style="cursor: pointer;">
                    <span style="font-weight: 500;">Apply to Multiple Weeks</span>
                </label>
            </div>
            
            <!-- Individual Week Context Mode -->
            <div id="individualContextMode">
                <div style="display: grid; gap: 15px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">Select Week</label>
                        <select id="contextWeekSelect" 
                            style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); 
                                   border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                                   color: white; font-size: 0.9rem;">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">
                            Context for Selected Week
                            <span id="existingContextIndicator" style="color: #667eea; font-size: 0.8rem; margin-left: 10px;"></span>
                        </label>
                        <textarea id="individualWeekContext" 
                            style="width: 100%; min-height: 100px; padding: 10px; background: rgba(255, 255, 255, 0.1); 
                                   border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; color: white; 
                                   font-size: 0.9rem; resize: vertical;"
                            placeholder="Enter context for this specific week..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="button secondary" style="padding: 8px 20px;" 
                                onclick="saveIndividualContext()">Save Week Context</button>
                        <button class="button secondary" style="padding: 8px 20px;" 
                                onclick="clearIndividualContext()">Clear</button>
                        <button class="button secondary" style="padding: 8px 20px;" 
                                onclick="copyFromPreviousWeek()" title="Copy context from previous week">← Copy Previous</button>
                    </div>
                </div>
                
                <!-- List of weeks with context -->
                <div style="margin-top: 20px;">
                    <h4 style="font-size: 1rem; margin-bottom: 15px; color: #a0a0a0;">
                        Weeks with Context <span id="contextCountBadge" style="background: #667eea; color: white; 
                                                                               padding: 2px 8px; border-radius: 12px; 
                                                                               font-size: 0.8rem; margin-left: 8px;">0</span>
                    </h4>
                    <div id="weeksWithContextList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Multiple Weeks Context Mode -->
            <div id="multipleContextMode" style="display: none;">
                <textarea id="summaryContext" 
                    style="width: 100%; min-height: 150px; padding: 15px; background: rgba(255, 255, 255, 0.1); 
                           border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; color: white; 
                           font-size: 0.95rem; resize: vertical;"
                    placeholder="Examples:&#10;• 'Easter holiday affected sales during this period'&#10;• 'New album releases from Provident drove significant growth'&#10;• 'Industry-wide promotion campaign was active this week'"></textarea>
                
                <!-- Week Selection Options -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <input type="checkbox" id="applyToSpecificWeeks" 
                            style="width: 18px; height: 18px; cursor: pointer;"
                            onchange="toggleWeekSelection()">
                        <label for="applyToSpecificWeeks" style="cursor: pointer; font-weight: 500;">
                            Apply context to specific weeks only
                        </label>
                    </div>
                    
                    <div id="weekSelectionContainer" style="display: none;">
                        <p style="font-size: 0.85rem; color: #a0a0a0; margin-bottom: 10px;">
                            Select weeks where this context applies: <span id="selectedWeekCount" style="color: #667eea; font-weight: 600;"></span>
                        </p>
                        <div id="weekCheckboxList" style="max-height: 200px; overflow-y: auto; 
                                    padding: 10px; background: rgba(0, 0, 0, 0.2); 
                                    border-radius: 8px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px;">
                            <!-- Populated dynamically -->
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="button secondary" style="padding: 5px 15px; font-size: 0.85rem;" 
                                    onclick="selectAllWeeks()">Select All</button>
                            <button class="button secondary" style="padding: 5px 15px; font-size: 0.85rem;" 
                                    onclick="deselectAllWeeks()">Deselect All</button>
                            <button class="button secondary" style="padding: 5px 15px; font-size: 0.85rem;" 
                                    onclick="selectRecentWeeks(4)">Last 4 Weeks</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <p style="font-size: 0.8rem; color: #666; margin-top: 12px;">
                Context will be seamlessly integrated into the summary text. 
                <span style="color: #667eea;">Individual week contexts have priority over general contexts.</span>
            </p>
            <div style="margin-top: 20px; text-align: center;">
                <button class="button" onclick="saveAllContexts()">Save All Contexts & Refresh</button>
                <button class="button secondary" style="margin-left: 10px;" onclick="clearAllContexts()">Clear All</button>
            </div>
        </div>

        <!-- Future Projections -->
        <div class="chart-container">
            <h3 class="chart-title">Future Projections</h3>
            <p style="font-size: 0.85rem; color: #888; margin-bottom: 20px;">
                Add expected future data points to improve regression analysis. Projected units will be <strong>added to current YTD units</strong> to show cumulative totals. These projections will appear as diamond markers on the predictive trend chart and influence the forecast calculations.
            </p>
            
            <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">Date</label>
                    <input type="date" id="projectionDate" 
                        style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); 
                               border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                               color: white; font-size: 0.9rem;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">Label</label>
                    <select id="projectionLabel" 
                        style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); 
                               border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                               color: white; font-size: 0.9rem;">
                        <option value="">Select a label...</option>
                        <option value="Provident">Provident</option>
                        <option value="CCMG">CCMG</option>
                        <option value="ADA">ADA</option>
                        <option value="THE ORCHARD">THE ORCHARD</option>
                        <option value="Fair Trade">Fair Trade</option>
                        <option value="WORD/CURB">WORD/CURB</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">Projected Units</label>
                    <input type="number" id="projectionUnits" 
                        style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); 
                               border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                               color: white; font-size: 0.9rem;"
                        placeholder="Enter projected units">
                </div>
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="button secondary" onclick="addProjection()">Add Projection</button>
            </div>
            
            <!-- Projections List -->
            <div id="projectionsList" style="max-height: 300px; overflow-y: auto;">
                <!-- Populated dynamically -->
            </div>
            
            <div style="margin-top: 20px; text-align: center; display: flex; gap: 15px; justify-content: center;">
                <button class="button" onclick="saveProjections()">Save Projections & Update Analysis</button>
                <button class="button secondary" onclick="clearAllProjections()">Clear All</button>
            </div>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
<div id="changePasswordModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                                     background: rgba(0, 0, 0, 0.8); z-index: 10000; 
                                     display: flex; align-items: center; justify-content: center;">
    <div style="background: #1a1a2e; padding: 40px; border-radius: 20px; 
                border: 1px solid rgba(102, 126, 234, 0.3); max-width: 400px; width: 90%;">
        <h3 style="margin-bottom: 20px; text-align: center;">Change Settings Password</h3>
        
        <div id="passwordChangeError" style="color: #f87171; margin-bottom: 20px; display: none; text-align: center;"></div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">New Password</label>
            <input type="password" id="newPassword" 
                style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); 
                       border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                       color: white; font-size: 0.9rem;">
        </div>
        
        <div style="margin-bottom: 30px;">
            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #a0a0a0;">Confirm Password</label>
            <input type="password" id="confirmPassword" 
                style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); 
                       border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
                       color: white; font-size: 0.9rem;">
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center;">
            <button class="button" onclick="changePassword()">Update Password</button>
            <button class="button secondary" onclick="hideChangePassword()">Cancel</button>
        </div>
    </div>
</div>
    </div>
</div>
	    
</body>
</html>